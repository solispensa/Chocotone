<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chocotone Manual & Walkthrough</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Palette */
            --bg-dark: #050505;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.06);
            --text-main: #ffffff;
            --text-muted: #9ca3af;
            --text-dim: #4b5563;

            /* Chocotone Brand Colors */
            --brand-mint: #e5fff2;
            --brand-cyan: #8ffdff;
            --brand-lavender: #8c81df;
            --brand-lavender-dim: #6b62b0;

            /* Functional */
            --accent: var(--brand-lavender);
            --accent-glow: rgba(140, 129, 223, 0.4);
            --border: rgba(255, 255, 255, 0.1);
            --border-hover: rgba(140, 129, 223, 0.5);

            /* Spacing */
            --section-spacing: 8rem;
            --container-width: 1200px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            font-size: 16px;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(circle at 15% 50%, rgba(140, 129, 223, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(143, 253, 255, 0.05) 0%, transparent 25%);
            color: var(--text-main);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Typography */
        h1,
        h2,
        h3,
        h4 {
            line-height: 1.1;
            letter-spacing: -0.02em;
        }

        h2 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 4rem;
            text-align: center;
            background: linear-gradient(to right, #fff, var(--brand-lavender));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: fit-content;
            left: auto;
            transform: none;
        }

        h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: #fff;
        }

        p {
            color: var(--text-muted);
            font-size: 1.05rem;
            margin-bottom: 1.5rem;
            font-weight: 400;
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: var(--container-width);
            background: rgba(15, 15, 15, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 100px;
            z-index: 1000;
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .nav-logo {
            font-weight: 900;
            font-size: 1.25rem;
            color: var(--brand-mint);
            letter-spacing: -1px;
            display: flex;
            align-items: center;
        }

        .nav-logo span {
            color: var(--brand-lavender);
        }

        .nav-links {
            display: flex;
            gap: 2.5rem;
        }

        .nav-links a {
            color: var(--text-muted);
            text-decoration: none;
            transition: all 0.3s;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }

        .nav-links a:hover {
            color: #fff;
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 0%;
            height: 2px;
            background: var(--brand-lavender);
            transition: width 0.3s ease;
        }

        .nav-links a:hover::after {
            width: 100%;
        }

        /* Layout */
        section {
            padding: var(--section-spacing) 2rem;
            min-height: auto;
            position: relative;
        }

        section#hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-top: 120px;
        }

        .container {
            max-width: var(--container-width);
            width: 100%;
            margin: 0 auto;
        }

        /* Card System (Glassmorphism) */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 24px;
        }

        .control-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2.5rem;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .control-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(800px circle at var(--mouse-x) var(--mouse-y), rgba(255, 255, 255, 0.06), transparent 40%);
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            z-index: 0;
        }

        .control-card:hover {
            transform: translateY(-8px);
            border-color: var(--border-hover);
            background: var(--bg-card-hover);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
        }

        .control-card:hover::before {
            opacity: 1;
        }

        .control-card>* {
            position: relative;
            z-index: 1;
        }

        .control-icon {
            font-size: 3.5rem;
            margin-bottom: 1.5rem;
            filter: drop-shadow(0 0 20px rgba(140, 129, 223, 0.2));
            transition: transform 0.3s ease;
        }

        .control-card:hover .control-icon {
            transform: scale(1.1);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35em 0.8em;
            background: rgba(140, 129, 223, 0.15);
            border: 1px solid rgba(140, 129, 223, 0.3);
            border-radius: 6px;
            color: var(--brand-mint);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 0.75rem;
            min-width: 90px;
            justify-content: center;
        }

        /* Step List (Tap Tempo) */
        .step-list {
            display: grid;
            gap: 2rem;
            position: relative;
        }

        .step-list::before {
            content: '';
            position: absolute;
            left: 24px;
            top: 20px;
            bottom: 20px;
            width: 2px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 0;
        }

        .step-item {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
            position: relative;
            z-index: 1;
        }

        .step-num {
            background: #111;
            border: 2px solid var(--brand-lavender);
            color: var(--brand-lavender);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 800;
            flex-shrink: 0;
            box-shadow: 0 0 20px rgba(140, 129, 223, 0.3);
        }

        /* Menu Tree (OLED) */
        .menu-tree {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .menu-item {
            background: rgba(255, 255, 255, 0.02);
            border-left: 3px solid var(--border);
            padding: 1.5rem;
            border-radius: 0 12px 12px 0;
            transition: all 0.3s;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: var(--brand-cyan);
            padding-left: 2rem;
        }

        .menu-title {
            color: #fff;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .menu-item p {
            font-size: 0.9rem;
            margin-bottom: 0;
        }

        /* Rhythm Patterns Tags */
        .rhythm-patterns {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .pattern-tag {
            background: #222;
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 0.8rem;
            color: #ccc;
            border: 1px solid #333;
        }

        /* Footer */
        footer {
            padding: 4rem 2rem;
            text-align: center;
            border-top: 1px solid var(--border);
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        /* Utils */
        .text-accent {
            color: var(--brand-lavender);
        }

        .text-cyan {
            color: var(--brand-cyan);
        }

        .text-mint {
            color: var(--brand-mint);
        }

        /* Buttons & Badges */
        .btn-primary {
            background: linear-gradient(135deg, var(--brand-lavender), var(--brand-lavender-dim));
            color: #fff;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(140, 129, 223, 0.4);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
            text-decoration: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(140, 129, 223, 0.6);
            background: linear-gradient(135deg, var(--brand-lavender), #9d94ea);
        }

        .btn-primary:active {
            transform: translateY(1px);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #444;
            border-radius: 50%;
            display: inline-block;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
            transition: all 0.3s;
        }

        .status-dot.connected {
            background: #4ade80;
            box-shadow: 0 0 10px #4ade80, 0 0 20px #4ade80;
        }

        /* VIRTUAL CONTROLLER OVERRIDES */
        /* Keep existing controller vars but adjust container max-width if needed */
        .controller-wrapper {
            position: relative;
            /* Existing controller styling follows... */
            --chassis-ar: 44.5%;
            --chassis-w: 1080px;
            --chassis-rad: 40px;
            --oled-w: 18%;
            --oled-h: 22.5%;
            --oled-x: 74.5%;
            --oled-y: 50%;
            --btn-y-top: 21.5%;
            --btn-y-btm: 6%;
            --btn-spacing: 25%;
            --btn-size: 9%;
            --enc-x: 7%;
            --enc-y: 50%;
            --enc-size: 7%;
        }

        .chassis {
            position: relative;
            width: 100%;
            max-width: var(--chassis-w);
            margin: 0 auto;
            padding-bottom: var(--chassis-ar);
            background: transparent;
            overflow: visible;
        }

        .chassis-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1a1a1a;
            border-radius: var(--chassis-rad);
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8), 0 20px 50px rgba(0, 0, 0, 0.5), inset 0 0 0 2px #333;
            z-index: 1;
            pointer-events: none;
        }

        .chassis-components {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 5;
            pointer-events: none;
        }

        .chassis-components>* {
            pointer-events: auto;
        }

        /* Screws */
        .screw {
            position: absolute;
            width: 1.5%;
            height: 2.5%;
            background: radial-gradient(circle, #555, #222);
            border-radius: 50%;
            box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .screw::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            width: 80%;
            height: 15%;
            background: #111;
            transform: translateY(-50%) rotate(45deg);
        }

        .tl {
            top: 5%;
            left: 3%;
        }

        .tr {
            top: 5%;
            right: 3%;
        }

        .bl {
            bottom: 5%;
            left: 3%;
        }

        .br {
            bottom: 5%;
            right: 3%;
        }

        /* Buttons */
        .button-unit {
            position: absolute;
            width: var(--btn-size);
            padding-bottom: var(--btn-size);
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Button Positions via Vars (Uniform Spacing) */
        #btn-5 {
            top: var(--btn-y-top);
            left: calc(50% - 1.5 * var(--btn-spacing));
        }

        #btn-6 {
            top: var(--btn-y-top);
            left: calc(50% - 0.5 * var(--btn-spacing));
        }

        #btn-7 {
            top: var(--btn-y-top);
            left: calc(50% + 0.5 * var(--btn-spacing));
        }

        #btn-8 {
            top: var(--btn-y-top);
            left: calc(50% + 1.5 * var(--btn-spacing));
        }

        #btn-1 {
            bottom: var(--btn-y-btm);
            left: calc(50% - 1.5 * var(--btn-spacing));
        }

        #btn-2 {
            bottom: var(--btn-y-btm);
            left: calc(50% - 0.5 * var(--btn-spacing));
        }

        #btn-3 {
            bottom: var(--btn-y-btm);
            left: calc(50% + 0.5 * var(--btn-spacing));
        }

        #btn-4 {
            bottom: var(--btn-y-btm);
            left: calc(50% + 1.5 * var(--btn-spacing));
        }

        .footswitch {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #e0e0e0 10%, #999 40%, #666 100%);
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6), inset 0 1px 3px rgba(255, 255, 255, 0.5);
            cursor: pointer;
            border: 1px solid #111;
        }

        .footswitch:active {
            transform: scale(0.92);
        }

        .led-ring {
            position: absolute;
            top: -18%;
            left: -18%;
            right: -18%;
            bottom: -18%;
            border-radius: 50%;
            border: 3px solid #333;
            z-index: -1;
            transition: border-color 0.1s, box-shadow 0.1s;
            --led-color: #333;
        }

        .led-ring.led-on {
            border-color: var(--led-color);
            box-shadow: 0 0 15px var(--led-color), 0 0 30px var(--led-color);
        }

        /* Encoder */
        .encoder-unit {
            position: absolute;
            top: var(--enc-y);
            right: var(--enc-x);
            width: var(--enc-size);
            padding-bottom: var(--enc-size);
            transform: translate(50%, -50%);
            cursor: pointer;
        }

        .knob-cap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #222, #000);
            border-radius: 50%;
            border: 2px solid #444;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.7);
        }

        .knob-cap::after {
            content: '';
            position: absolute;
            top: 10%;
            left: 50%;
            width: 2px;
            height: 30%;
            background: #888;
            transform: translateX(-50%);
        }

        /* OLED */
        .oled-frame {
            position: absolute;
            top: var(--oled-y);
            left: var(--oled-x);
            width: var(--oled-w);
            height: var(--oled-h);
            transform: translate(-50%, -50%);
            background: #000;
            border-radius: 4px;
            padding: 2px;
            box-shadow: inset 0 0 2px rgba(255, 255, 255, 0.1);
            border: 1px solid #333;
            z-index: 5;
        }

        .oled-glass {
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
            position: relative;
        }

        .oled-pixel-grid {
            width: 100%;
            height: 100%;
            font-family: 'VT323', monospace;
            color: #00FFFF;
            text-shadow: 0 0 2px rgba(0, 255, 255, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 3px 5px;
            font-size: 1.1rem;
            line-height: 1;
        }

        .oled-row-top {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
        }

        .oled-row-btm {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            margin-top: auto;
        }

        .oled-main-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .oled-preset-name {
            font-size: 1.6em;
            font-weight: bold;
        }

        .oled-bpm {
            font-size: 1.0em;
            margin-top: 2px;
        }

        .oled-status {
            font-size: 1.2em;
            text-align: center;
            font-weight: bold;
            color: #00FFFF;
            margin-bottom: 4px;
        }

        .oled-labels {
            font-size: 0.7em;
            text-align: center;
            color: #00AAAA;
            letter-spacing: 1px;
        }

        .oled-menu-header {
            text-align: left;
            font-size: 0.8em;
            border-bottom: 1px solid #00AAAA;
            margin-bottom: 2px;
            color: #00FFFF;
        }

        .oled-menu-list {
            text-align: left;
            width: 100%;
            font-size: 0.9em;
        }

        .oled-menu-item {
            white-space: nowrap;
            overflow: hidden;
        }

        .oled-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            color: #00FFFF;
            z-index: 10;
        }

        @media (max-width: 600px) {
            .oled-pixel-grid {
                font-size: 0.8rem;
            }

            .oled-overlay {
                font-size: 1.5em;
            }
        }

        .v-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            padding: 5px 10px;
            border: 1px solid #00FFFF;
            color: #00FFFF;
            font-family: 'VT323', monospace;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s;
            z-index: 100;
            font-size: 1rem;
        }

        /* --- COMPONENT STYLES (Dynamic) --- */

        /* Button Shapes & Styles */
        .btn-round {
            border-radius: 50%;
        }

        .btn-square {
            border-radius: 4px;
        }

        .btn-rect {
            border-radius: 6px;
            width: 140% !important;
            height: 80% !important;
            margin-left: -20%;
            margin-top: 10%;
        }

        .btn-metal {
            /* Classic Chrome Footswitch */
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff, #ccc, #888);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5), inset 0 0 5px rgba(255, 255, 255, 0.8);
            border: 1px solid #666;
        }

        .btn-metal::after {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 60%;
            height: 60%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #eee, #999);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .btn-metal-flat {
            /* Flat Top Metal */
            border-radius: 50%;
            background: conic-gradient(#ccc, #fff, #ccc, #888, #ccc);
            box-shadow: 0 4px 0 #555, 0 8px 10px rgba(0, 0, 0, 0.6);
            border: 1px solid #444;
        }

        .btn-soft {
            /* Rubberized */
            border-radius: 4px;
            background: #333;
            box-shadow: inset 0 0 10px #000;
            border: 2px solid #222;
        }

        .btn-arcade {
            /* Convex Glossy */
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #ff4444, #cc0000);
            box-shadow: inset 2px 2px 5px rgba(255, 255, 255, 0.4), 0 5px 10px rgba(0, 0, 0, 0.5);
            border: 4px solid #880000;
        }

        .btn-illuminated {
            /* Full Glow */
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 10px var(--accent), inset 0 0 20px var(--accent);
        }

        .btn-hex {
            /* Hexagonal */
            border-radius: 0;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            background: #444;
            border: none;
        }

        .btn-transparent {
            /* Acrylic */
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(2px);
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.1);
        }

        /* NEW METAL FOOTSWITCH STYLES */
        .btn-3pdt {
            /* Classic 3PDT Chrome Stomp */
            border-radius: 50%;
            background: conic-gradient(from 0deg, #e8e8e8, #b8b8b8, #e8e8e8, #888, #e8e8e8);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.6), inset 0 2px 3px rgba(255, 255, 255, 0.8);
            border: 2px solid #666;
        }

        .btn-3pdt::after {
            content: '';
            position: absolute;
            top: 25%;
            left: 25%;
            width: 50%;
            height: 50%;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #f0f0f0, #aaa);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .btn-mxr {
            /* MXR Style - Raised dome */
            border-radius: 50%;
            background: radial-gradient(circle at 40% 30%, #d4d4d4, #888 60%, #555);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5), inset 0 -2px 5px rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
        }

        .btn-boss {
            /* Boss Style - Flat rubber top with metal ring */
            border-radius: 50%;
            background: #222;
            box-shadow: 0 0 0 4px #aaa, 0 0 0 5px #666, 0 4px 10px rgba(0, 0, 0, 0.6);
            border: none;
        }

        .btn-ehx {
            /* EHX Style - Chicken head pointer */
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #d0d0d0, #777);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            border: 2px solid #555;
        }

        .btn-ehx::before {
            content: '';
            position: absolute;
            top: 5%;
            left: 45%;
            width: 10%;
            height: 25%;
            background: #333;
            border-radius: 2px;
        }

        .btn-tc {
            /* TC Electronic Style - Soft touch */
            border-radius: 8px;
            background: linear-gradient(145deg, #3a3a3a, #1a1a1a);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6), inset 0 1px 2px rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
        }


        /* LED Formats */
        .led-ring {
            border-width: 5px;
            border-radius: inherit;
        }

        .btn-hex .led-ring {
            border: none;
            background-color: transparent;
            background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolygon points='50,3 97,27 97,73 50,97 3,73 3,27' fill='none' stroke='%23ffffff' stroke-width='5' /%3E%3C/svg%3E");
            background-size: 100% 100%;
            opacity: 0.5;
            /* Match ring opacity? */
        }


        .led-strip {
            border: none;
            border-radius: 2px;
            top: auto;
            bottom: -20%;
            left: 0;
            right: 0;
            height: 6px;
            width: 60%;
            margin: 0 auto;
            background-color: var(--led-color, #333);
            box-shadow: 0 0 3px var(--led-color, #333);
        }

        .led-dot {
            border: none;
            border-radius: 50%;
            bottom: auto;
            top: -20%;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 12px;
            height: 12px;
            background-color: var(--led-color, #333);
            box-shadow: 0 0 3px var(--led-color, #333);
        }

        .led-rect {
            border: none;
            border-radius: 1px;
            bottom: auto;
            top: -20%;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 20px;
            height: 10px;
            background-color: var(--led-color, #333);
            box-shadow: 0 0 3px var(--led-color, #333);
        }

        /* Active LED Strip/Dot/Rect needs stronger glow */
        .led-strip.active,
        .led-dot.active,
        .led-rect.active {
            box-shadow: 0 0 12px var(--led-color, #222) !important;
        }

        .led-inside {
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: none;
            border-radius: inherit;
            background: radial-gradient(circle, var(--led-color, transparent) 0%, transparent 60%);
            box-shadow: inset 0 0 15px var(--led-color, transparent);
            z-index: 2;
            pointer-events: none;
            opacity: 0.5;
        }

        .led-inside.active {
            opacity: 1;
            box-shadow: inset 0 0 25px var(--led-color, transparent);
        }

        /* Refined Button Styles */
        .btn-transparent {
            /* Acrylic */
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            /* Let LED shine through */
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(2px);
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.1);
        }

        .btn-arcade {
            /* Convex Glossy */
            border-radius: 50%;
            background: transparent;
            /* Inner transparent */
            box-shadow: inset 2px 2px 5px rgba(255, 255, 255, 0.1);
            border: 4px solid white;
            /* Outer ring white */
        }

        .btn-illuminated {
            /* Full Glow */
            border-radius: 4px;
            background: var(--active-led-color, rgba(255, 255, 255, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px var(--active-led-color, transparent);
            opacity: 0.8;
            transition: background 0.1s, box-shadow 0.1s;
        }

        /* Screen Models */
        .screen-oled .oled-pixel-grid {
            font-family: 'VT323', monospace;
            text-shadow: 0 0 2px rgba(0, 255, 255, 0.7);
        }

        .screen-tft {
            background: #222;
            border-color: #444;
        }

        .screen-tft .oled-pixel-grid {
            font-family: 'Outfit', sans-serif;
            color: #fff;
            text-shadow: none;
            font-weight: 300;
        }

        .screen-tft .oled-status {
            border-top: 1px solid #444;
            color: #888;
        }

        .screen-tft .oled-menu-header {
            border-bottom: 1px solid #444;
            color: var(--accent);
        }

        .screen-ips {
            background: #000;
            border: 1px solid #111;
        }

        .screen-ips .oled-pixel-grid {
            font-family: sans-serif;
            letter-spacing: 0.5px;
            text-shadow: none;
        }

        .screen-lcd {
            background: #9ea792;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .screen-lcd .oled-glass {
            background: transparent;
        }

        .screen-lcd .oled-pixel-grid {
            color: #111;
            font-family: 'VT323', monospace;
            text-shadow: none;
            opacity: 0.85;
        }

        .screen-lcd .oled-menu-header,
        .screen-lcd .oled-status {
            color: #000;
            border-color: #000;
        }

        .screen-lcd .oled-overlay {
            background: rgba(158, 167, 146, 0.95);
            color: #000;
        }

        /* NEW SCREEN STYLES */
        .screen-amoled {
            background: #000;
            border: 1px solid #111;
        }

        .screen-amoled .oled-pixel-grid {
            color: #fff;
            font-family: 'Outfit', sans-serif;
            text-shadow: 0 0 5px currentColor;
            font-weight: 400;
        }

        .screen-amoled .oled-status {
            color: #888;
            border-color: #333;
        }

        .screen-amoled .oled-menu-header {
            color: #0ff;
            border-color: #0ff;
        }

        .screen-vfd {
            background: linear-gradient(#001a1a, #000);
            border: 1px solid #003333;
        }

        .screen-vfd .oled-pixel-grid {
            color: #00ff88;
            font-family: 'VT323', monospace;
            text-shadow: 0 0 8px #00ff88;
        }

        .screen-vfd .oled-status {
            color: #006644;
            border-color: #004422;
        }

        .screen-vfd .oled-menu-header {
            color: #00ff88;
            border-color: #00aa55;
        }

        .screen-eink {
            background: #e8e4dc;
            border: 1px solid #999;
        }

        .screen-eink .oled-glass {
            background: transparent;
        }

        .screen-eink .oled-pixel-grid {
            color: #111;
            font-family: Georgia, serif;
            text-shadow: none;
        }

        .screen-eink .oled-status {
            color: #333;
            border-color: #999;
        }

        .screen-eink .oled-menu-header {
            color: #000;
            border-color: #666;
        }

        .screen-eink .oled-overlay {
            background: #e8e4dc;
            color: #000;
        }

        .screen-crt {
            background: #111;
            border: 2px solid #333;
            border-radius: 6px;
        }

        .screen-crt .oled-pixel-grid {
            color: #00ff00;
            font-family: 'VT323', monospace;
            text-shadow: 0 0 3px #00ff00, 0 0 10px rgba(0, 255, 0, 0.3);
            animation: crt-flicker 0.1s infinite;
        }

        @keyframes crt-flicker {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.98;
            }
        }

        .screen-crt .oled-status {
            color: #00aa00;
            border-color: #00aa00;
        }

        .screen-crt .oled-menu-header {
            color: #00ff00;
            border-color: #00aa00;
        }

        .screen-nixie {
            background: #1a0a00;
            border: 2px solid #3d2817;
        }

        .screen-nixie .oled-pixel-grid {
            color: #ff6611;
            font-family: 'VT323', monospace;
            text-shadow: 0 0 10px #ff4400, 0 0 20px rgba(255, 68, 0, 0.5);
        }

        .screen-nixie .oled-status {
            color: #aa4400;
            border-color: #aa4400;
        }

        .screen-nixie .oled-menu-header {
            color: #ff6611;
            border-color: #ff4400;
        }

        /* 1: Default */
        .enc-2 .knob-cap {
            background: #ddd;
            border: 1px solid #999;
        }

        /* Silver/White */
        .enc-2 .knob-cap::after {
            background: #333;
        }

        .enc-3 .knob-cap {
            background: radial-gradient(circle, #444, #111);
            border: 1px dashed #666;
        }

        /* Grip */

        .enc-4 .knob-cap {
            border-radius: 10%;
            background: #222;
            border: 1px solid #444;
        }

        /* Square-ish */

        .enc-5 .knob-cap {
            background: radial-gradient(circle at 30% 30%, #666, #000);
            box-shadow: 0 2px 5px #000;
            border: none;
        }

        /* Smooth Sphere */

        .enc-6 .knob-cap {
            background: repeating-conic-gradient(#222 0% 5%, #333 5% 10%);
            border: 1px solid #000;
        }

        /* Knurled */

        .enc-7 .knob-cap {
            background: #b87333;
            border: 1px solid #5c3a19;
        }

        /* Copper */

        .enc-8 .knob-cap {
            background: #000;
            border: 2px solid var(--accent);
            box-shadow: 0 0 10px var(--accent);
        }

        /* Gamer */
        .enc-8 .knob-cap::after {
            background: var(--accent);
            box-shadow: 0 0 5px var(--accent);
        }

        /* Screw Styles */
        .screw-2 {
            background: #ccc;
            box-shadow: inset 1px 1px 1px #fff;
        }

        /* Silver */
        .screw-2::after {
            transform: translateY(-50%) rotate(0deg);
            background: #888;
            width: 90%;
            height: 10%;
        }

        /* Flathead */

        .screw-3 {
            background: #111;
        }

        /* Black Hex */
        .screw-3::after {
            width: 50%;
            height: 50%;
            background: #000;
            border-radius: 10%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .screw-4 {
            background: #888;
        }

        /* Torx-ish (simplified) */
        .screw-4::after {
            width: 60%;
            height: 60%;
            background: radial-gradient(circle, #333, #888);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .screw-5 {
            background: #000;
        }

        /* Black Oxide */
        .screw-6 {
            background: linear-gradient(135deg, #ffd700, #b8860b);
        }

        /* Gold */
        .screw-7 {
            background: #8b4513;
        }

        /* Rusty */
        .screw-8 {
            display: none;
        }

        /* None */


        /* LAYOUT EDITOR Styles */
        #virtual-controller {
            position: relative;
        }

        #layout-editor {
            position: absolute;
            top: 130px;
            right: 0;
            left: auto;
            transform: none;
            margin-left: 0;
            margin-right: 20px;
            bottom: auto;
            background: rgba(20, 20, 30, 0.85);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(187, 134, 252, 0.3);
            padding: 20px;
            border-radius: 16px;
            color: #fff;
            z-index: 9999;
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
            width: 320px;
            max-height: 85%;
            overflow-y: auto;
            overflow-x: hidden;
            transition: all 0.3s ease;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
        }

        #layout-editor::-webkit-scrollbar {
            width: 6px;
        }

        #layout-editor::-webkit-scrollbar-track {
            background: transparent;
        }

        #layout-editor::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: 3px;
        }

        #layout-editor.minimized {
            width: 50px;
            height: 50px;
            padding: 0;
            border-radius: 8px 0 0 8px;
            /* Tab shape */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: rgba(20, 20, 30, 0.95);
            border-color: var(--accent);
        }

        #layout-editor.minimized h3 {
            margin: 0;
            padding: 0;
            font-size: 24px;
        }

        #layout-editor.minimized .layout-title-text {
            display: none;
        }

        #layout-editor.minimized .layout-content {
            display: none;
            opacity: 0;
            pointer-events: none;
        }

        #layout-editor h3 {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .layout-content {
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        #layout-editor h3 {
            margin: 0 0 10px 0;
            color: var(--accent);
        }

        #layout-editor h4 {
            margin: 10px 0 5px 0;
            border-bottom: 1px solid #333;
        }

        .editor-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            gap: 10px;
        }

        .editor-row span:first-child {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            min-width: 70px;
        }

        .editor-row select {
            flex: 1;
            background: #1a1a20;
            border: 1px solid rgba(187, 134, 252, 0.3);
            border-radius: 8px;
            padding: 6px 10px;
            color: #fff;
            font-size: 0.75rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23bb86fc' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 28px;
        }

        .editor-row select:hover {
            background: #222228;
            border-color: rgba(187, 134, 252, 0.5);
        }

        .editor-row select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(187, 134, 252, 0.2);
        }

        .editor-row input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        .editor-row input[type="range"]::-webkit-slider-track {
            background: #A78BFA;
            height: 6px;
            border-radius: 3px;
        }

        .editor-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 2px 8px rgba(187, 134, 252, 0.4);
        }

        .editor-row input[type="range"]::-moz-range-track {
            background: #A78BFA;
            height: 6px;
            border-radius: 3px;
        }

        .editor-row input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(187, 134, 252, 0.4);
        }

        .slider-value {
            min-width: 50px;
            text-align: right;
            font-size: 0.75rem;
            color: var(--accent);
            font-weight: 600;
            flex-shrink: 0;
        }

        .layout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        #copy-msg {
            color: #0f0;
            display: none;
            margin-top: 5px;
            text-align: center;
        }

        /* Footer */
        footer {
            padding: 2rem;
            text-align: center;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            background: var(--bg-dark);
        }

        /* --- NEW SLIDE LAYOUT STYLES (Ported from chocotone_slide.html) --- */
        .slide-hero-container {
            width: 100%;
            max-width: 1600px;
            aspect-ratio: 16/9;
            background: linear-gradient(135deg, #111 0%, #000 100%);
            border-radius: 24px;
            padding: 2.5%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            gap: 1.5%;
            margin: 0 auto;
        }

        .slide-header {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1%;
            flex: 0 0 25%;
            /* Fixed height percentage of container */
        }

        .slide-header-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            border-radius: 24px;
            padding: 4% 7%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .slide-title {
            font-size: clamp(2rem, 4cqi, 5rem);
            /* using cqi for container query-like scaling if possible, or vw/percent */
            font-size: clamp(2rem, 3.5vw, 4.5rem);
            font-weight: 900;
            letter-spacing: -6px;
            line-height: 1;
            margin: 0;
            text-transform: uppercase;
        }

        .slide-subtitle {
            font-size: clamp(0.8rem, 1.1vw, 1.5rem);
            color: #8ffdff;
            letter-spacing: 2px;
            margin-top: 1.5%;
        }

        .slide-byline {
            margin-top: auto;
            color: #6b7280;
            font-size: clamp(0.6rem, 0.75vw, 0.9rem);
        }

        .slide-grid {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 2.4% 1%;
            flex: 1;
            min-height: 0;
        }

        .slide-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            border-radius: 20px;
            padding: 8% 7%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, border-color 0.3s;
        }

        .slide-card:hover {
            transform: translateY(-5px);
            border-color: var(--border-hover);
            background: var(--bg-card-hover);
        }

        .slide-card-icon {
            font-size: clamp(1.5rem, 2.2vw, 3rem);
            margin-bottom: 5%;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.1));
        }

        .slide-card-title {
            font-size: clamp(0.9rem, 1.2vw, 1.6rem);
            font-weight: 600;
            color: #fff;
            margin-bottom: 4%;
            white-space: nowrap;
        }

        .slide-card-text {
            font-size: clamp(0.65rem, 0.8vw, 0.95rem);
            color: var(--text-muted);
            line-height: 1.4;
            margin: 0;
        }

        .slide-glow {
            position: absolute;
            pointer-events: none;
            z-index: 0;
        }

        .slide-glow-1 {
            width: 50%;
            height: 50%;
            background: radial-gradient(circle, rgba(140, 129, 223, 0.15) 0%, transparent 70%);
            top: -15%;
            right: -15%;
        }

        .slide-glow-2 {
            width: 40%;
            height: 40%;
            background: radial-gradient(circle, rgba(143, 253, 255, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: -10%;
        }
    </style>
</head>

<body>

    <nav>
        <div class="nav-logo">CHOCO<span>TONE</span></div>
        <div class="nav-links">
            <a href="#hero">Overview</a>
            <a href="#controls">Controls</a>
            <a href="#tap-tempo">Tap Tempo</a>
            <a href="#menu">Menu</a>
            <a href="#web">Config</a>
            <a href="#virtual-controller">Virtual Chocotone</a>
        </div>
    </nav>

    <!-- HERO: CHOCOTONE FEATURE SLIDE -->
    <!-- HERO: CHOCOTONE FEATURE SLIDE -->
    <section id="hero">
        <div class="container" style="max-width: 100%; display: flex; justify-content: center;">
            <div class="slide-hero-container">
                <!-- Background glows -->
                <div class="slide-glow slide-glow-1"></div>
                <div class="slide-glow slide-glow-2"></div>

                <!-- Header -->
                <header class="slide-header">
                    <div class="slide-header-card">
                        <h1 class="slide-title">
                            <span style="color: #e5fff2;">CHOCO</span><span style="color: #8c81df;">TONE</span>
                        </h1>
                        <div class="slide-subtitle">OPEN MIDI CONTROLLER</div>
                        <div class="slide-byline">Made by Andr√© Solis Albuquerque - 2025</div>
                    </div>
                    <div class="slide-header-card" style="padding:0;">
                        <img src="images/chocotone_header.png" alt="Chocotone Controller"
                            style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
                    </div>
                </header>

                <!-- Grid -->
                <div class="slide-grid">
                    <!-- Card 1: 8 Buttons -->
                    <div class="slide-card">
                        <div class="slide-card-icon" style="color: #f472b6;">üéõÔ∏è</div>
                        <h3 class="slide-card-title">RGB Buttons</h3>
                        <p class="slide-card-text">Fully configurable MIDI messages with RGB LED feedback for instant
                            visual status.</p>
                        <!-- Visual dots -->
                        <div
                            style="position: absolute; top: 10%; right: 10%; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; opacity:0.8;">
                            <div
                                style="width:8px; height:8px; background:#f472b6; border-radius:50%; box-shadow: 0 0 5px #f472b6;">
                            </div>
                            <div style="width:8px; height:8px; background:#333; border-radius:50%;"></div>
                            <div
                                style="width:8px; height:8px; background:#60a5fa; border-radius:50%; box-shadow: 0 0 5px #60a5fa;">
                            </div>
                            <div style="width:8px; height:8px; background:#333; border-radius:50%;"></div>
                            <div
                                style="width:8px; height:8px; background:#4ade80; border-radius:50%; box-shadow: 0 0 5px #4ade80;">
                            </div>
                            <div style="width:8px; height:8px; background:#333; border-radius:50%;"></div>
                        </div>
                    </div>

                    <!-- Card 2: BLE MIDI -->
                    <div class="slide-card">
                        <div class="slide-card-icon" style="color: #fbbf24;">‚ö°</div>
                        <h3 class="slide-card-title">BLE MIDI</h3>
                        <p class="slide-card-text">Wireless connectivity. Auto-connects to Sonicake Pocket Master &
                            other BLE devices.</p>
                    </div>

                    <!-- Card 3: OLED Display -->
                    <div class="slide-card">
                        <div class="slide-card-icon" style="color: #bef264;">üìü</div>
                        <h3 class="slide-card-title">OLED Display</h3>
                        <p class="slide-card-text">128x64 pixel screen for real-time status, presets, and menu
                            navigation.</p>
                        <!-- Mini pixel art mockup simplified -->
                        <div
                            style="background: #000; border: 2px solid #222; border-radius: 6px; padding: 4px 6px; font-family: 'VT323', monospace; color: #00ffff; text-shadow: 0 0 2px rgba(0, 255, 255, 0.6); font-size: 12px; line-height: 1; display: flex; flex-direction: column; justify-content: space-between; height: 80px; width: 120px; position: absolute; top: 28px; right: 28px; box-shadow: inset 0 0 15px rgba(0, 255, 255, 0.05); letter-spacing: 0.5px;">
                            <div style="display: flex; justify-content: space-between; width: 100%;">
                                <span>EQ</span><span>FX2</span><span>DLY</span><span>RVB</span>
                            </div>
                            <div
                                style="text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; padding: 2px 0;">
                                <div
                                    style="font-size: 20px; letter-spacing: 1px; margin-bottom: 0; transform: scaleY(0.9);">
                                    STOMP</div>
                                <div style="font-size: 12px; transform: scaleY(0.9);">BPM:83.6</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; width: 100%;">
                                <span>SPM:Y</span><span>WiFi:N</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; width: 100%;">
                                <span>NR</span><span>FX1</span><span>DRV</span><span>TAP</span>
                            </div>
                        </div>
                    </div>

                    <!-- Card 4: Rotary Encoder -->
                    <div class="slide-card">
                        <div class="slide-card-icon" style="color: #38bdf8;">üîÑ</div>
                        <h3 class="slide-card-title">Rotary Encoder</h3>
                        <p class="slide-card-text">Intuitive navigation and precise parameter adjustment with
                            push-button.</p>
                    </div>

                    <!-- Card 5: 4 Presets -->
                    <div class="slide-card">
                        <div class="slide-card-icon" style="color: #ddaebf;">üíæ</div> <!-- darker pink/grey -->
                        <h3 class="slide-card-title">4 Presets</h3>
                        <p class="slide-card-text">Store different configurations for banks or stomp mode. Easy
                            switching between setups.</p>
                    </div>

                    <!-- Card 6: Rechargeable Battery -->
                    <div class="slide-card">
                        <div class="slide-card-icon" style="color: #4ade80;">üîã</div>
                        <h3 class="slide-card-title">Rechargeable Battery</h3>
                        <p class="slide-card-text">Built-in rechargeable battery for portable operation without external
                            power.</p>
                    </div>

                    <!-- Card 7: Tap Tempo -->
                    <div class="slide-card">
                        <div class="slide-card-icon" style="color: #fb923c;">ü•Å</div>
                        <h3 class="slide-card-title">Tap Tempo</h3>
                        <p class="slide-card-text">Built-in tap tempo with multiple rhythm patterns (1/4, 1/8, 1/8d,
                            1/2).</p>
                    </div>

                    <!-- Card 8: Web Config -->
                    <div class="slide-card">
                        <div class="slide-card-icon" style="color: #60a5fa;">üåê</div>
                        <h3 class="slide-card-title">Web App Editor</h3>
                        <p class="slide-card-text">Use the app to configure mappings, name presets, and manage settings.
                            Send to the controller via Bluetooth, WIFI or .JSON file.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- VIRTUAL CONTROLLER -->
    <section id="virtual-controller">
        <div class="container">
            <h2>Virtual Chocotone</h2>
            <p style="text-align:center; margin-bottom:2rem;">
                Try it yourself! Fully interactive simulation.<br>
                <span style="font-size:0.9rem; color:var(--accent);">
                    <br><strong>üñ±Ô∏è Encoder Click:</strong> Change Preset |
                    <strong>‚è±Ô∏è Encoder Hold:</strong> Menu |
                    <strong>üñ±Ô∏è‚ÜïÔ∏è Encoder Scroll:</strong> Navigate
                </span>
                <br><br>
                <button id="btn-ble-connect" class="btn-primary" onclick="BLEMIDI.connect()">
                    <span class="status-dot" id="ble-status-dot"></span> Connect BLE MIDI
                </button>
            </p>

            <div class="controller-wrapper">
                <div class="chassis">
                    <div class="chassis-bg"></div>
                    <div class="chassis-components">
                        <div class="screw tl"></div>
                        <div class="screw tr"></div>
                        <div class="screw bl"></div>
                        <div class="screw br"></div>

                        <!-- Top Row -->
                        <div class="button-unit" id="btn-5" data-tooltip="Switch 5: Snapshot A">
                            <div class="footswitch">
                                <div class="led-ring" id="led-5"></div>
                            </div>
                        </div>
                        <div class="button-unit" id="btn-6" data-tooltip="Switch 6: Snapshot B">
                            <div class="footswitch">
                                <div class="led-ring" id="led-6"></div>
                            </div>
                        </div>
                        <div class="button-unit" id="btn-7" data-tooltip="Switch 7: Snapshot C">
                            <div class="footswitch">
                                <div class="led-ring" id="led-7"></div>
                            </div>
                        </div>
                        <div class="button-unit" id="btn-8" data-tooltip="Switch 8: Tap Tempo">
                            <div class="footswitch">
                                <div class="led-ring" id="led-8"></div>
                            </div>
                        </div>

                        <!-- Bottom Row -->
                        <div class="button-unit" id="btn-1" data-tooltip="Switch 1: Toggle Drive">
                            <div class="footswitch">
                                <div class="led-ring" id="led-1"></div>
                            </div>
                        </div>
                        <div class="button-unit" id="btn-2" data-tooltip="Switch 2: Toggle Mod">
                            <div class="footswitch">
                                <div class="led-ring" id="led-2"></div>
                            </div>
                        </div>
                        <div class="button-unit" id="btn-3" data-tooltip="Switch 3: Toggle Delay">
                            <div class="footswitch">
                                <div class="led-ring" id="led-3"></div>
                            </div>
                        </div>
                        <div class="button-unit" id="btn-4" data-tooltip="Switch 4: Toggle Reverb">
                            <div class="footswitch">
                                <div class="led-ring" id="led-4"></div>
                            </div>
                        </div>

                        <!-- OLED -->
                        <div class="oled-frame">
                            <div class="oled-glass">
                                <div class="oled-pixel-grid" id="oled-content"></div>
                            </div>
                        </div>

                        <!-- Encoder -->
                        <div class="encoder-unit" id="encoder-knob" data-tooltip="Encoder: Click/Scroll/Hold">
                            <div class="knob-cap"></div>
                        </div>

                        <!-- Tooltip -->
                        <div id="v-tooltip" class="v-tooltip">Info</div>
                    </div>
                </div>
            </div>
            <!-- LAYOUT EDITOR UI (Moved Outside Wrapper) -->
            <div id="layout-editor" class="minimized">
                <h3 onclick="toggleEditor()" title="Toggle Editor">üé® <span class="layout-title-text">Layout
                        Editor</span></h3>

                <div class="layout-content">
                    <h4>Components</h4>
                    <div class="editor-row"><span>Btn Fmt:</span>
                        <select id="sel-btn-fmt" onchange="updateStyle('btn', this.value)">
                            <option value="">Round</option>
                            <option value="btn-square">Square</option>
                            <option value="btn-rect">Rectangular</option>
                            <option value="btn-metal">Metal Footswitch</option>
                            <option value="btn-metal-flat">Metal Flat</option>
                            <option value="btn-soft">Soft Touch</option>
                            <option value="btn-arcade">Arcade</option>
                            <option value="btn-illuminated">Illuminated</option>
                            <option value="btn-transparent">Transparent</option>
                        </select>
                    </div>
                    <div class="editor-row"><span>LED Fmt:</span>
                        <select id="sel-led-fmt" onchange="updateStyle('led', this.value)">
                            <option value="led-ring">Ring</option>
                            <option value="led-strip" selected>Strip</option>
                            <option value="led-dot">Dot</option>
                            <option value="led-rect">Rect</option>
                            <option value="led-inside">Inside</option>
                        </select>
                    </div>
                    <div class="editor-row"><span>Encoder:</span>
                        <select id="sel-enc-model" onchange="updateStyle('enc', this.value)">
                            <option value="">Default</option>
                            <option value="enc-2">Silver</option>
                            <option value="enc-3">Grip</option>
                            <option value="enc-4">Square</option>
                            <option value="enc-5">Sphere</option>
                            <option value="enc-6">Knurled</option>
                            <option value="enc-7">Copper</option>
                            <option value="enc-8">Gamer</option>
                        </select>
                    </div>
                    <div class="editor-row"><span>Screws:</span>
                        <select id="sel-screw-model" onchange="updateStyle('screw', this.value)">
                            <option value="">Philips</option>
                            <option value="screw-2">Flathead</option>
                            <option value="screw-3">Hex</option>
                            <option value="screw-4">Torx</option>
                            <option value="screw-5">Black</option>
                            <option value="screw-6">Gold</option>
                            <option value="screw-7">Rusty</option>
                            <option value="screw-8">None</option>
                        </select>
                    </div>
                    <div class="editor-row"><span>Screen:</span>
                        <select id="sel-screen-model" onchange="updateStyle('screen', this.value)">
                            <option value="screen-oled">OLED</option>
                            <option value="screen-tft">TFT</option>
                            <option value="screen-ips">IPS</option>
                            <option value="screen-lcd">LCD</option>
                            <option value="screen-amoled" selected>AMOLED</option>
                            <option value="screen-vfd">VFD</option>
                        </select>
                    </div>
                    <hr style="border-color:#444;">

                    <h4>Colors</h4>
                    <div class="editor-row"><span>Faceplate:</span>
                        <input type="color" id="col-faceplate" value="#1a1a1a"
                            onchange="updateColor('faceplate', this.value)">
                    </div>
                    <div class="editor-row"><span>Contour:</span>
                        <input type="color" id="col-contour" value="#333333"
                            onchange="updateColor('contour', this.value)">
                    </div>
                    <div class="editor-row"><span>Screws:</span>
                        <input type="color" id="col-screw" value="#888888" onchange="updateColor('screw', this.value)">
                    </div>
                    <div class="editor-row"><span>Encoder:</span>
                        <input type="color" id="col-encoder" value="#222222"
                            onchange="updateColor('encoder', this.value)">
                    </div>
                    <div class="editor-row"><span>Screen:</span>
                        <input type="color" id="col-screen" value="#00ffff"
                            onchange="updateColor('screen', this.value)">
                    </div>
                    <div class="editor-row"><span>Contour Th:</span> <input type="range" id="sl-contour-th" min="1"
                            max="10" step="1" value="2" onchange="updateSizeControl('contour', this.value)"><span
                            class="slider-value" id="val-contour-th">2px</span></div>
                    <div class="editor-row"><span>Screw Size:</span> <input type="range" id="sl-screw-size" min="0.5"
                            max="3" step="0.1" value="1.5" onchange="updateSizeControl('screw', this.value)"><span
                            class="slider-value" id="val-screw-size">1.5%</span></div>
                    <div class="editor-row"><span>Chamfer:</span>
                        <input type="checkbox" id="chk-chamfer" onchange="updateChamfer()">
                        <input type="range" id="sl-chamfer" min="5" max="30" step="1" value="15"
                            onchange="updateChamfer()" disabled><span class="slider-value" id="val-chamfer">15px</span>
                    </div>
                    <div class="editor-row"><span>Slope Height:</span>
                        <input type="checkbox" id="chk-slope" onchange="updateSlope()">
                        <input type="range" id="sl-slope-y" min="10" max="400" step="5" value="40"
                            onchange="updateSlope()" disabled><span class="slider-value" id="val-slope-y">40px</span>
                    </div>
                    <div class="editor-row"><span>Slope Angle:</span>
                        <input type="range" id="sl-slope-angle" min="0" max="45" step="1" value="25"
                            onchange="updateSlope()" disabled><span class="slider-value"
                            id="val-slope-angle">25&deg;</span>
                    </div>
                    <hr style="border-color:#444;">

                    <div class="editor-row"><span>Buttons #:</span> <input type="range" id="sl-btn-count" min="1"
                            max="12" step="1" value="8" onchange="updateButtonCount(this.value)"><span
                            class="slider-value" id="val-btn-count">8</span></div>
                    <div class="editor-row"><span>Rows #:</span>
                        <select id="sel-btn-rows"
                            onchange="updateButtonCount(document.getElementById('sl-btn-count').value)">
                            <option value="1">1</option>
                            <option value="2" selected>2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                    <div class="editor-row"><span>Height:</span> <input type="range" id="sl-ar" min="20" max="80"
                            step="0.5"><span class="slider-value" id="val-ar"></span></div>
                    <div class="editor-row"><span>Width:</span> <input type="range" id="sl-w" min="400" max="1300"
                            step="10"><span class="slider-value" id="val-w"></span></div>
                    <div class="editor-row"><span>Corner R:</span> <input type="range" id="sl-rad" min="0" max="100"
                            step="1"><span class="slider-value" id="val-rad"></span></div>
                    <h4>OLED</h4>
                    <div class="editor-row"><span>Width:</span> <input type="range" id="sl-oled-w" min="10" max="80"
                            step="0.5"><span class="slider-value" id="val-oled-w"></span></div>
                    <div class="editor-row"><span>Height:</span> <input type="range" id="sl-oled-h" min="10" max="60"
                            step="0.5"><span class="slider-value" id="val-oled-h"></span></div>
                    <div class="editor-row"><span>Left X:</span> <input type="range" id="sl-oled-x" min="0" max="100"
                            step="0.5"><span class="slider-value" id="val-oled-x"></span></div>
                    <div class="editor-row"><span>Top Y:</span> <input type="range" id="sl-oled-y" min="0" max="80"
                            step="0.5"><span class="slider-value" id="val-oled-y"></span></div>
                    <h4>Text Sizes</h4>
                    <div class="editor-row"><span>Preset:</span> <input type="range" id="sl-font-preset" min="0.8"
                            max="3" step="0.1" value="1.6" onchange="updateFontSize('preset', this.value)"><span
                            class="slider-value" id="val-font-preset">1.6em</span></div>
                    <div class="editor-row"><span>Labels:</span> <input type="range" id="sl-font-labels" min="0.5"
                            max="1.5" step="0.05" value="0.8" onchange="updateFontSize('labels', this.value)"><span
                            class="slider-value" id="val-font-labels">0.8em</span></div>
                    <div class="editor-row"><span>Status:</span> <input type="range" id="sl-font-status" min="0.5"
                            max="1.2" step="0.05" value="0.7" onchange="updateFontSize('status', this.value)"><span
                            class="slider-value" id="val-font-status">0.7em</span></div>
                    <div class="editor-row"><span>BPM:</span> <input type="range" id="sl-font-bpm" min="0.6" max="2"
                            step="0.1" value="1.0" onchange="updateFontSize('bpm', this.value)"><span
                            class="slider-value" id="val-font-bpm">1.0em</span></div>
                    <div class="editor-row"><span>H Scale:</span> <input type="range" id="sl-font-h" min="0.7" max="1.5"
                            step="0.05" value="1" onchange="updateFontSize('h', this.value)"><span class="slider-value"
                            id="val-font-h">1x</span></div>
                    <div class="editor-row"><span>W Scale:</span> <input type="range" id="sl-font-w" min="0.7" max="1.5"
                            step="0.05" value="1" onchange="updateFontSize('w', this.value)"><span class="slider-value"
                            id="val-font-w">1x</span></div>
                    <h4>Buttons</h4>
                    <div class="editor-row"><span>Size:</span> <input type="range" id="sl-btn-size" min="5" max="20"
                            step="0.5"><span class="slider-value" id="val-btn-size"></span></div>
                    <div class="editor-row"><span>Top Row:</span> <input type="range" id="sl-btn-y1" min="5" max="70"
                            step="0.5"><span class="slider-value" id="val-btn-y1"></span></div>
                    <div class="editor-row"><span>Btm Row:</span> <input type="range" id="sl-btn-y2" min="0" max="50"
                            step="0.5"><span class="slider-value" id="val-btn-y2"></span></div>
                    <div class="editor-row"><span>Spacing:</span> <input type="range" id="sl-btn-spacing" min="10"
                            max="40" step="0.5"><span class="slider-value" id="val-btn-spacing"></span></div>
                    <h4>Encoder</h4>
                    <div class="editor-row"><span>Size:</span> <input type="range" id="sl-enc-size" min="5" max="20"
                            step="0.5"><span class="slider-value" id="val-enc-size"></span></div>
                    <div class="editor-row"><span>Right X:</span> <input type="range" id="sl-enc-x" min="0" max="90"
                            step="0.5"><span class="slider-value" id="val-enc-x"></span></div>
                    <div class="editor-row"><span>Center Y:</span> <input type="range" id="sl-enc-y" min="10" max="90"
                            step="0.5"><span class="slider-value" id="val-enc-y"></span></div>
                    <button onclick="copyConfig()" style="width:100%; margin-top:10px; cursor:pointer;">üìã Copy
                        Config</button>
                    <div id="copy-msg">Copied!</div>
                    <button onclick="document.getElementById('sl-import-input').click()"
                        style="width:100%; margin-top:10px; cursor:pointer;">üìÇ Load Config</button>
                    <input type="file" id="sl-import-input" style="display: none;" onchange="importConfig(this)">
                    <h4>SPM Sync</h4>
                    <div class="editor-row">
                        <span>Mode:</span>
                        <select id="sel-sync-mode" onchange="setSyncMode(this.value)">
                            <option value="NONE">None</option>
                            <option value="SPM">SPM</option>
                        </select>
                    </div>
                    <button id="btn-spm-request" onclick="requestSpmPresetState()"
                        style="width:100%; margin-top:5px; cursor:pointer; display:none;">üîÑ Request State</button>
                </div>
            </div>
    </section>

    <!-- LOGIC -->
    <script>
        // --- BLE MIDI LOGIC ---
        const BLEMIDI = {
            device: null,
            server: null,
            characteristic: null,
            isConnected: false,

            // Standard BLE MIDI Service & Characteristic UUIDs
            SERVICE_UUID: "03b80e5a-ede8-4b33-a751-6ce34ec4c700",
            CHARACTERISTIC_UUID: "7772e5db-3868-4112-a1a9-f2669d106bf3",

            async connect() {
                if (this.isConnected) {
                    this.disconnect();
                    return;
                }

                try {
                    console.log('Requesting Bluetooth Device...');
                    this.device = await navigator.bluetooth.requestDevice({
                        filters: [{ services: [this.SERVICE_UUID] }]
                    });

                    this.device.addEventListener('gattserverdisconnected', this.onDisconnected.bind(this));

                    console.log('Connecting to GATT Server...');
                    this.server = await this.device.gatt.connect();

                    console.log('Getting Service...');
                    const service = await this.server.getPrimaryService(this.SERVICE_UUID);

                    console.log('Getting Characteristic...');
                    this.characteristic = await service.getCharacteristic(this.CHARACTERISTIC_UUID);

                    // IMPORTANT: Enable Notifications to establish full MIDI link
                    // Many devices (like iOS or specific pedals) require this to "accept" the connection
                    console.log('Starting Notifications...');
                    await this.characteristic.startNotifications();
                    this.characteristic.addEventListener('characteristicvaluechanged', (event) => {
                        // Handle incoming MIDI
                        const data = new Uint8Array(event.target.value.buffer);
                        console.log(`[BLE RECV] ${Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ')}`);
                        // Check for SysEx (starts with 80 80 F0) and route to SPM parser
                        if (data.length > 3 && data[0] === 0x80 && data[1] === 0x80 && data[2] === 0xF0) {
                            if (typeof parseSpmResponse === 'function') {
                                parseSpmResponse(data);
                            }
                        }
                    });

                    this.isConnected = true;
                    this.updateUI();
                    console.log('BLE MIDI Connected & Active');

                    // AUTO-DETECT POCKET MASTER
                    if (this.device.name === "Pocket Master BLE") {
                        console.log("Pocket Master BLE detected! Enabling SPM Sync automatically.");
                        setSyncMode('SPM');
                        // Update the dropdown UI to reflect the change
                        const syncSel = document.getElementById('sel-sync-mode');
                        if (syncSel) syncSel.value = 'SPM';
                    }

                } catch (error) {
                    console.log('Argh! ' + error);
                    alert('Connection failed: ' + error);
                }
            },

            disconnect() {
                if (this.device && this.device.gatt.connected) {
                    this.device.gatt.disconnect();
                }
            },

            onDisconnected() {
                console.log('Device disconnected');
                this.isConnected = false;
                this.device = null;
                this.server = null;
                this.characteristic = null;
                this.updateUI();
            },

            updateUI() {
                const btn = document.getElementById('btn-ble-connect');
                const dot = document.getElementById('ble-status-dot');
                if (this.isConnected && this.device) {
                    btn.innerHTML = `<span class="status-dot connected" id="ble-status-dot"></span> Connected to ${this.device.name}`;
                    // Remove red background override so it uses default .btn-primary style
                    btn.style.background = '';
                } else {
                    btn.innerHTML = '<span class="status-dot" id="ble-status-dot"></span> Connect BLE MIDI';
                    btn.style.background = ''; // reset to default class style
                }
            },

            // Queue for serializing GATT writes
            _msgQueue: [],
            _isSending: false,

            sendPacket(midiData) {
                if (!this.isConnected || !this.characteristic) {
                    console.warn('BLE Not Connected');
                    return;
                }

                // Add to queue
                this._msgQueue.push(midiData);
                // Sanity check: prevent infinite queue
                if (this._msgQueue.length > 20) {
                    console.warn('BLE Queue full, dropping old packets');
                    this._msgQueue.shift();
                }

                this._processQueue();
            },

            async _processQueue() {
                if (this._isSending || this._msgQueue.length === 0) return;

                this._isSending = true;

                try {
                    while (this._msgQueue.length > 0) {
                        const midiData = this._msgQueue.shift();

                        // BLE MIDI Packet: Header (0x80) + Timestamp (0x80) + Data
                        const packet = new Uint8Array([0x80, 0x80, ...midiData]);
                        console.log(`[BLE SEND] ${Array.from(packet).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ')} (Q: ${this._msgQueue.length})`);

                        await this.characteristic.writeValueWithoutResponse(packet);

                        // THOTTLE: Small delay to ensure stack clears and pedal processes
                        await new Promise(r => setTimeout(r, 20));
                    }
                } catch (error) {
                    console.error('BLE Write Error:', error);
                    // Do NOT alert on single packet failure, it interrupts flow
                    const oledStatus = document.querySelector('.oled-status');
                    if (oledStatus) {
                        oledStatus.textContent = "BLE BUSY";
                        oledStatus.style.color = "orange";
                    }
                } finally {
                    this._isSending = false;
                    // Check if more arrived while processing
                    if (this._msgQueue.length > 0) this._processQueue();
                }
            },

            sendCC(channel, controller, value) {
                // Status byte for CC: 0xB0 | (channel - 1)
                const status = 0xB0 | ((channel - 1) & 0x0F);
                this.sendPacket([status, controller & 0x7F, value & 0x7F]);
            },

            sendPC(channel, program) {
                // Status for PC: 0xC0 | (channel - 1)
                const status = 0xC0 | ((channel - 1) & 0x0F);
                this.sendPacket([status, program & 0x7F]);
            },

            sendNoteOn(channel, note, velocity) {
                const status = 0x90 | ((channel - 1) & 0x0F);
                this.sendPacket([status, note & 0x7F, velocity & 0x7F]);
            },

            sendNoteOff(channel, note) {
                // Note off or Note on with vel 0
                const status = 0x80 | ((channel - 1) & 0x0F);
                this.sendPacket([status, note & 0x7F, 0]);
            },

            // SysEx for SPM communication
            sendSysex(data) {
                if (!this.isConnected || !this.characteristic) {
                    console.warn('BLE Not Connected - Cannot send SysEx');
                    return;
                }
                // SysEx is sent as-is with BLE MIDI header
                const packet = new Uint8Array([0x80, 0x80, ...data]);
                console.log(`[BLE SYSEX] ${Array.from(packet).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ')}`);
                this.characteristic.writeValueWithoutResponse(packet);
            },

            // Setup notification handler for incoming data
            async setupNotifications() {
                if (!this.characteristic) return;
                try {
                    await this.characteristic.startNotifications();
                    this.characteristic.addEventListener('characteristicvaluechanged', (event) => {
                        const data = new Uint8Array(event.target.value.buffer);
                        console.log(`[BLE RECV] ${Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ')}`);
                        // Check for SysEx (starts with 80 80 F0)
                        if (data.length > 3 && data[0] === 0x80 && data[1] === 0x80 && data[2] === 0xF0) {
                            parseSpmResponse(data);
                        }
                    });
                    console.log('BLE Notifications enabled');
                } catch (error) {
                    console.error('Failed to setup notifications:', error);
                }
            }
        };

        // ============================================
        // SPM SYNC PROTOCOL FUNCTIONS
        // ============================================

        function requestSpmPresetState() {
            if (!BLEMIDI.isConnected) {
                console.warn('Cannot request SPM state - not connected');
                return;
            }

            // Debounce - don't request too frequently
            const now = Date.now();
            if (now - state.lastSpmStateRequest < 500) {
                return;
            }
            state.lastSpmStateRequest = now;

            // SPM Request Preset Dump command
            const request = [0xF0, 0x00, 0x09, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x01, 0x02, 0x04, 0x01, 0xF7];
            BLEMIDI.sendSysex(request);
            console.log('SPM: Requested preset state');

            const oledStatus = document.querySelector('.oled-status');
            if (oledStatus) {
                oledStatus.textContent = "SPM SYNC...";
                oledStatus.style.color = "#ffff00";
            }
        }

        function parseSpmResponse(data) {
            // Only process if sync mode is SPM
            if (state.syncMode !== 'SPM') return;

            console.log(`SPM Response: ${data.length} bytes`);

            // Check for 212+ byte preset dump with header 00 05 00 00
            if (data.length >= 200 && data[5] === 0x00 && data[6] === 0x05 &&
                data[7] === 0x00 && data[8] === 0x00) {

                console.log('SPM: First preset dump packet - processing states...');

                // Search for 0A 00 00 00 chain marker from END
                let chainMarkerPos = -1;
                for (let i = data.length - 5; i >= 10; i--) {
                    if (data[i] === 0x0A && data[i + 1] === 0x00 && data[i + 2] === 0x00 && data[i + 3] === 0x00) {
                        chainMarkerPos = i;
                        break;
                    }
                }

                if (chainMarkerPos >= 0) {
                    // Calculate payload position (payload starts at raw[5])
                    const chainByteIndex = chainMarkerPos - 5;
                    console.log(`SPM: Chain marker at raw[${chainMarkerPos}], payload[${chainByteIndex}]`);

                    // State bytes relative to chain marker
                    const nibble1Pos = chainMarkerPos - 13 + 5 - 5; // Adjust for header
                    const nibble2Pos = chainMarkerPos - 12 + 5 - 5;
                    const globalStatePos = chainMarkerPos - 10 + 5 - 5;

                    // Simplify: use raw positions matching C++ logic
                    const n1Pos = chainByteIndex - 13 + 5;
                    const n2Pos = chainByteIndex - 12 + 5;
                    const gsPos = chainByteIndex - 10 + 5;

                    if (n1Pos >= 5 && gsPos < data.length) {
                        const nibble1Byte = data[n1Pos];
                        const nibble2Byte = data[n2Pos];
                        const globalStateByte = data[gsPos];

                        console.log(`SPM: Raw values - nibble1=0x${nibble1Byte.toString(16)} nibble2=0x${nibble2Byte.toString(16)} globalState=0x${globalStateByte.toString(16)}`);

                        // Decode bitmask (low nibble of each byte)
                        const lowNibble1 = nibble1Byte & 0x0F;
                        const lowNibble2 = nibble2Byte & 0x0F;
                        const mainBitmask = (lowNibble1 << 4) | lowNibble2;

                        console.log(`SPM: Bitmask = 0x${mainBitmask.toString(16)} (${mainBitmask.toString(2).padStart(8, '0')})`);

                        // RVB and Clone mode from globalStateByte
                        const isRvbOn = (globalStateByte & 0x01) !== 0;
                        const isCloneMode = (globalStateByte & 0x02) !== 0;

                        // Decode effect states
                        state.spmEffectStates[0] = (mainBitmask & (1 << 0)) !== 0;  // NR
                        state.spmEffectStates[1] = (mainBitmask & (1 << 1)) !== 0;  // FX1
                        state.spmEffectStates[2] = (mainBitmask & (1 << 2)) !== 0;  // DRV
                        state.spmEffectStates[3] = (mainBitmask & (1 << 3)) !== 0;  // AMP
                        state.spmEffectStates[4] = (mainBitmask & (1 << 4)) !== 0;  // IR
                        state.spmEffectStates[5] = (mainBitmask & (1 << 5)) !== 0;  // EQ
                        state.spmEffectStates[6] = (mainBitmask & (1 << 6)) !== 0;  // FX2
                        state.spmEffectStates[7] = (mainBitmask & (1 << 7)) !== 0;  // DLY
                        state.spmEffectStates[8] = isRvbOn;                          // RVB

                        // If Clone mode, IR is always ON
                        if (isCloneMode) {
                            state.spmEffectStates[4] = true;
                        }

                        state.spmStateReceived = true;

                        console.log('SPM State:', state.spmEffectStates.map((s, i) =>
                            ['NR', 'FX1', 'DRV', 'AMP', 'IR', 'EQ', 'FX2', 'DLY', 'RVB'][i] + '=' + (s ? 'ON' : 'OFF')).join(' '));

                        // Apply to buttons
                        applySpmStateToButtons();
                    }
                }
                return; // Processed preset dump
            }

            // Check for PRESET CHANGE notification (24 bytes with 06 01 02 04 03 pattern)
            // Pattern: bytes[10-14] = 06 01 02 04 03
            if (data.length >= 20 && data.length <= 30) {
                if (data[10] === 0x06 && data[11] === 0x01 && data[12] === 0x02 &&
                    data[13] === 0x04 && data[14] === 0x03) {
                    const presetNum = data[16] || 0;
                    console.log(`SPM: Preset changed on device! New preset: ${presetNum}`);

                    const oledStatus = document.querySelector('.oled-status');
                    if (oledStatus) {
                        oledStatus.textContent = `SPM P${presetNum}`;
                        oledStatus.style.color = "#ffff00";
                    }

                    // Auto-request fresh state after short delay
                    setTimeout(() => {
                        requestSpmPresetState();
                    }, 100);
                    return;
                }
            }
        }

        function applySpmStateToButtons() {
            if (state.syncMode !== 'SPM') return;

            console.log('SPM Sync: Applying state to buttons...');

            const p = presets[state.presetIndex];

            // CC number to effect index mapping (43-51 -> 0-8)
            p.buttons.forEach((btn, idx) => {
                // Only process toggle buttons (those with 2ND_PRESS action)
                if (!btn.messages) return;
                const has2ndPress = btn.messages.some(m => m.action === '2ND_PRESS');
                if (!has2ndPress) return;

                const pressAction = btn.messages.find(m => m.action === 'PRESS');
                if (!pressAction || pressAction.type !== CC) return;

                // Check if CC is in range 43-51
                const ccNum = pressAction.val1 || pressAction.data1;
                if (ccNum >= 43 && ccNum <= 51) {
                    const effectIndex = ccNum - 43;
                    const effectIsOn = state.spmEffectStates[effectIndex];

                    // Update button state
                    state.buttonActive[idx] = effectIsOn;
                    btn.isAlternate = effectIsOn;

                    console.log(`  BTN ${idx} (${btn.n}): CC${ccNum} -> Effect[${effectIndex}] = ${effectIsOn ? 'ON' : 'OFF'}`);
                }
            });

            // Update LEDs and display
            updateLeds();
            render();

            const oledStatus = document.querySelector('.oled-status');
            if (oledStatus) {
                oledStatus.textContent = "SPM SYNCED";
                oledStatus.style.color = "#00ff00";
                setTimeout(() => {
                    if (oledStatus.textContent === "SPM SYNCED") {
                        oledStatus.textContent = "";
                        oledStatus.style.color = "";
                    }
                }, 2000);
            }

            console.log('SPM Sync: State applied successfully');
        }

        function setSyncMode(mode) {
            state.syncMode = mode;
            console.log('Sync Mode set to:', mode);

            // Show/hide Request State button
            const btn = document.getElementById('btn-spm-request');
            if (btn) {
                btn.style.display = mode === 'SPM' ? 'block' : 'none';
            }

            // If SPM and connected, request state immediately
            if (mode === 'SPM' && BLEMIDI.isConnected) {
                requestSpmPresetState();
            }
        }

        // --- EDITOR LOGIC ---
        const wrapper = document.querySelector('.controller-wrapper');

        // ==========================================
        // PRESET DATA (Matches DefaultPresets.h)
        // ==========================================
        const LED_TOGGLE = 'toggle';
        const LED_MOMENTARY = 'momentary';
        const LED_SELECTION = 'selection';

        const PRESET_LED_NORMAL = 'NORMAL';
        const PRESET_LED_SELECTION = 'SELECTION';

        // Message Types
        const CC = 'CC';
        const PC = 'PC';
        const NOTE = 'NOTE';
        const TAP_TEMPO = 'TAP_TEMPO';

        const defaultPresets = [
            {
                name: "STOMP",
                ledMode: PRESET_LED_NORMAL,
                buttons: [
                    {
                        name: "NR", color: [0xFF, 0xFF, 0xFF], ledMode: LED_TOGGLE,
                        messages: [
                            { action: 'PRESS', type: CC, ch: 1, val1: 43, val2: 127 },
                            { action: '2ND_PRESS', type: CC, ch: 1, val1: 43, val2: 0 }
                        ]
                    },
                    {
                        name: "FX1", color: [0x3F, 0x67, 0xFF], ledMode: LED_TOGGLE,
                        messages: [
                            { action: 'PRESS', type: CC, ch: 1, val1: 44, val2: 127 },
                            { action: '2ND_PRESS', type: CC, ch: 1, val1: 44, val2: 0 }
                        ]
                    },
                    {
                        name: "DRV", color: [0xFC, 0x2C, 0x00], ledMode: LED_TOGGLE,
                        messages: [
                            { action: 'PRESS', type: CC, ch: 1, val1: 45, val2: 127 },
                            { action: '2ND_PRESS', type: CC, ch: 1, val1: 45, val2: 0 }
                        ]
                    },
                    {
                        name: "TAP", color: [0xFF, 0xFF, 0xFF], ledMode: LED_MOMENTARY,
                        messages: [
                            { action: 'PRESS', type: TAP_TEMPO, ch: 1, val1: 0, val2: 0 }
                        ]
                    },
                    {
                        name: "EQ", color: [0x0A, 0xF5, 0x00], ledMode: LED_TOGGLE,
                        messages: [
                            { action: 'PRESS', type: CC, ch: 1, val1: 48, val2: 127 },
                            { action: '2ND_PRESS', type: CC, ch: 1, val1: 48, val2: 0 }
                        ]
                    },
                    {
                        name: "FX2", color: [0x11, 0xF3, 0xFF], ledMode: LED_TOGGLE,
                        messages: [
                            { action: 'PRESS', type: CC, ch: 1, val1: 49, val2: 127 },
                            { action: '2ND_PRESS', type: CC, ch: 1, val1: 49, val2: 0 }
                        ]
                    },
                    {
                        name: "DLY", color: [0x33, 0x2A, 0xFF], ledMode: LED_TOGGLE,
                        messages: [
                            { action: 'PRESS', type: CC, ch: 1, val1: 50, val2: 127 },
                            { action: '2ND_PRESS', type: CC, ch: 1, val1: 50, val2: 0 }
                        ]
                    },
                    {
                        name: "RVB", color: [0x84, 0x00, 0xF7], ledMode: LED_TOGGLE,
                        messages: [
                            { action: 'PRESS', type: CC, ch: 1, val1: 51, val2: 127 },
                            { action: '2ND_PRESS', type: CC, ch: 1, val1: 51, val2: 0 }
                        ]
                    }
                ]
            },
            {
                name: "BANKS 1-8",
                ledMode: PRESET_LED_SELECTION,
                buttons: [
                    { name: "B1", color: [0xFF, 0xFF, 0xFF], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 1 }] },
                    { name: "B2", color: [0xFF, 0xFF, 0xFF], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 2 }] },
                    { name: "B3", color: [0xFF, 0xFF, 0xFF], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 3 }] },
                    { name: "B4", color: [0xFF, 0xFF, 0xFF], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 4 }] },
                    { name: "B5", color: [0x0A, 0xF5, 0x00], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 5 }] },
                    { name: "B6", color: [0x0A, 0xF5, 0x00], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 6 }] },
                    { name: "B7", color: [0x0A, 0xF5, 0x00], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 7 }] },
                    { name: "B8", color: [0x0A, 0xF5, 0x00], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 8 }] }
                ]
            },
            {
                name: "BANKS 9-16",
                ledMode: PRESET_LED_SELECTION,
                buttons: [
                    { name: "B9", color: [0x11, 0xF3, 0xFF], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 9 }] },
                    { name: "B10", color: [0x11, 0xF3, 0xFF], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 10 }] },
                    { name: "B11", color: [0x11, 0xF3, 0xFF], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 11 }] },
                    { name: "B12", color: [0x11, 0xF3, 0xFF], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 12 }] },
                    { name: "B13", color: [0xAA, 0x00, 0xFF], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 13 }] },
                    { name: "B14", color: [0xAA, 0x00, 0xFF], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 14 }] },
                    { name: "B15", color: [0xAA, 0x00, 0xFF], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 15 }] },
                    { name: "B16", color: [0xAA, 0x00, 0xFF], ledMode: LED_SELECTION, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 16 }] }
                ]
            },
            {
                name: "Note",
                ledMode: PRESET_LED_SELECTION,
                buttons: [
                    { name: "1st", color: [0xFD, 0x00, 0x00], ledMode: LED_MOMENTARY, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 40 }] },
                    { name: "2nd", color: [0xFD, 0x00, 0x00], ledMode: LED_MOMENTARY, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 41 }] },
                    { name: "3rd", color: [0xFD, 0x00, 0x00], ledMode: LED_MOMENTARY, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 42 }] },
                    { name: "4th", color: [0xFD, 0x00, 0x00], ledMode: LED_MOMENTARY, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 43 }] },
                    { name: "5th", color: [0xFD, 0x00, 0x00], ledMode: LED_MOMENTARY, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 44 }] },
                    { name: "6th", color: [0xFD, 0x00, 0x00], ledMode: LED_MOMENTARY, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 45 }] },
                    { name: "7th", color: [0xFD, 0x00, 0x00], ledMode: LED_MOMENTARY, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 46 }] },
                    { name: "8up", color: [0xFD, 0x00, 0x00], ledMode: LED_MOMENTARY, messages: [{ action: 'PRESS', type: CC, ch: 1, val1: 1, val2: 47 }] }
                ]
            }
        ];

        // State tracking
        let currentPreset = 0;
        let ledToggleState = [false, false, false, false, false, false, false, false];
        let selectionState = -1; // For SELECTION mode, which button is selected

        // ==========================================
        // OLED DISPLAY
        // ==========================================
        function updateOLED() {
            const oled = document.getElementById('oled-content');
            const preset = defaultPresets[currentPreset];
            const buttonCount = parseInt(document.getElementById('sl-btn-count')?.value || 8);

            // Build labels for visible buttons
            const labels = preset.buttons.slice(0, Math.min(buttonCount, 8)).map(b => b.name);

            // Pad or distribute labels evenly
            const topLabels = labels.slice(Math.ceil(labels.length / 2)).reverse();
            const btmLabels = labels.slice(0, Math.ceil(labels.length / 2));

            oled.innerHTML = `
                <div class="oled-status">${preset.name}</div>
                <div class="oled-labels">${topLabels.join(' ')}</div>
                <div class="oled-labels">${btmLabels.join(' ')}</div>
            `;
        }

        // ==========================================
        // LED CONTROL
        // ==========================================
        function rgbToHex(r, g, b) {
            return `rgb(${r}, ${g}, ${b})`;
        }

        function setLedColor(btnIndex, on) {
            const led = document.getElementById(`led-${btnIndex + 1}`);
            if (!led) return;

            const preset = defaultPresets[currentPreset];
            const btn = preset.buttons[btnIndex];
            if (!btn) return;

            if (on) {
                const [r, g, b] = btn.color;
                led.style.setProperty('--led-color', rgbToHex(r, g, b));
                led.classList.add('led-on');
            } else {
                led.style.removeProperty('--led-color');
                led.classList.remove('led-on');
            }
        }

        function updateLeds() {
            const preset = defaultPresets[currentPreset];
            const buttonCount = parseInt(document.getElementById('sl-btn-count')?.value || 8);

            for (let i = 0; i < buttonCount; i++) {
                const btn = preset.buttons[i];
                if (!btn) continue;

                if (preset.ledMode === PRESET_LED_SELECTION) {
                    // In selection mode, only selected button is lit
                    setLedColor(i, selectionState === i);
                } else {
                    // Normal mode - show toggle state
                    setLedColor(i, ledToggleState[i]);
                }
            }
        }

        // ==========================================
        // BUTTON CLICK HANDLING
        // ==========================================
        // handleButtonClick REMOVED (Duplicate logic)
        // Active logic: handleButtonMouseDown (bottom of file)

        let oledRevertTimer = null; // Store timer globally

        // Helper to deduplicate sending logic
        function sendMidiMessage(msg) {
            if (msg) {
                // Normalize keys (support val1/val2 AND data1/data2)
                const v1 = (msg.val1 !== undefined) ? msg.val1 : msg.data1;
                const v2 = (msg.val2 !== undefined) ? msg.val2 : msg.data2;

                // Human readable debug
                const typeStr = (msg.type === CC) ? 'CC' : (msg.type === PC) ? 'PC' : (msg.type === TAP_TEMPO) ? 'TAP' : 'UNKNOWN';

                // VISUAL FEEDBACK ON OLED
                const oledStatus = document.querySelector('.oled-status');
                if (oledStatus) {
                    oledStatus.textContent = `${typeStr} #${msg.ch} : ${v1}/${v2}`;
                    oledStatus.style.color = '#00ff00';

                    // Clear existing timer to prevent premature reset
                    if (oledRevertTimer) clearTimeout(oledRevertTimer);

                    // Revert after 1s
                    oledRevertTimer = setTimeout(() => {
                        // Use global presets if available or clear
                        if (oledStatus) {
                            oledStatus.textContent = "READY";
                            oledStatus.style.color = '';
                        }
                    }, 1000);
                }

                console.log(`%c[MIDI COMMAND] ${typeStr} | Ch: ${msg.ch} | Val1: ${v1} | Val2: ${v2}`, 'color: #00ff00; font-weight: bold;');

                if (!BLEMIDI.isConnected) {
                    console.warn('%c[BLE] Device not connected. Command not sent.', 'color: orange;');
                    if (oledStatus) oledStatus.style.color = 'orange';
                }

                if (msg.type === CC) {
                    BLEMIDI.sendCC(msg.ch, v1, v2);
                } else if (msg.type === PC) {
                    BLEMIDI.sendPC(msg.ch, v2 || v1); // PC often uses data1
                } else if (msg.type === TAP_TEMPO) {
                    // Start: handled in logic. Stop: maybe logic?
                }
            }
        }

        // handleButtonDown REMOVED (Duplicate logic)


        function handleButtonUp(btnIndex) {
            const preset = defaultPresets[currentPreset];
            const btn = preset.buttons[btnIndex];
            if (!btn) return;

            if (btn.ledMode === LED_MOMENTARY) {
                setLedColor(btnIndex, false);

                // Send Release Message if strictly momentary and needed?
                // Usually for Momentary CC switches: Press=127, Release=0
                // Our data structure for Note preset has PRESS defined.
                // Does it have RELEASE? Not explicitly in our simplified array.
                // But for momentary behavior, we usually want Note Off or CC 0.

                const pressMsg = btn.messages?.find(m => m.action === 'PRESS');
                if (pressMsg && pressMsg.type === CC) {
                    BLEMIDI.sendCC(pressMsg.ch, pressMsg.val1, 0); // Send 0 on release
                }
            }
        }

        // ==========================================
        // ENCODER NAVIGATION
        // ==========================================
        function changePreset(delta) {
            currentPreset = (currentPreset + delta + 4) % 4;
            // Reset states when changing presets
            ledToggleState = [false, false, false, false, false, false, false, false];
            selectionState = -1;
            updateOLED();
            updateLeds();
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        function initializeButtonHandlers() {
            document.querySelectorAll('.button-unit').forEach(btn => {
                const match = btn.id.match(/btn-(\d+)/);
                if (!match) return;
                const idx = parseInt(match[1]) - 1;

                btn.addEventListener('click', () => handleButtonClick(idx));
                btn.addEventListener('mousedown', () => handleButtonDown(idx));
                btn.addEventListener('mouseup', () => handleButtonUp(idx));
                btn.addEventListener('mouseleave', () => handleButtonUp(idx));
            });

            // Encoder click = change preset, scroll = navigate + rotate
            const encoder = document.getElementById('encoder-knob');
            const knobCap = encoder?.querySelector('.knob-cap');
            let encoderRotation = 0;
            if (encoder && knobCap) {
                // Add smooth transition for rotation
                knobCap.style.transition = 'transform 0.1s ease-out';

                encoder.addEventListener('click', () => changePreset(1));
                encoder.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 1 : -1;
                    changePreset(delta);
                    // Rotate encoder knob visually
                    encoderRotation += delta * 15; // 15 degrees per scroll step
                    knobCap.style.transform = `rotate(${encoderRotation}deg)`;
                });
            }

            // Initialize display
            updateOLED();
            updateLeds();
        }

        // Call after DOM is ready
        document.addEventListener('DOMContentLoaded', initializeButtonHandlers);

        function toggleEditor() {
            document.getElementById('layout-editor').classList.toggle('minimized');
        }
        const inputMap = {
            '--chassis-ar': ['sl-ar', '%'],
            '--chassis-w': ['sl-w', 'px'],
            '--chassis-rad': ['sl-rad', 'px'],
            '--oled-w': ['sl-oled-w', '%'],
            '--oled-h': ['sl-oled-h', '%'],
            '--oled-x': ['sl-oled-x', '%'],
            '--oled-y': ['sl-oled-y', '%'],
            '--btn-size': ['sl-btn-size', '%'],
            '--btn-y-top': ['sl-btn-y1', '%'],
            '--btn-y-btm': ['sl-btn-y2', '%'],
            '--btn-spacing': ['sl-btn-spacing', '%'],
            '--enc-size': ['sl-enc-size', '%'],
            '--enc-x': ['sl-enc-x', '%'],
            '--enc-y': ['sl-enc-y', '%']
        };

        const style = getComputedStyle(wrapper);
        for (const [v, [id, unit]] of Object.entries(inputMap)) {
            const el = document.getElementById(id);
            const valEl = document.getElementById('val-' + id.replace('sl-', ''));
            if (!el) continue;
            let val = style.getPropertyValue(v).trim();
            if (val.includes(unit)) val = val.replace(unit, '');
            val = parseFloat(val) || 0;
            // Clamp value to slider's min/max range
            const slMin = parseFloat(el.min) || 0;
            const slMax = parseFloat(el.max) || 100;
            val = Math.max(slMin, Math.min(slMax, val));
            el.value = val;
            if (valEl) valEl.textContent = val + unit;
            el.addEventListener('input', (e) => {
                wrapper.style.setProperty(v, e.target.value + unit);
                if (valEl) valEl.textContent = e.target.value + unit;
            });
        }

        // --- DYNAMIC COMPONENT STYLES ---
        let currentLedStyle = '';
        function updateStyle(type, value) {
            const chassis = document.querySelector('.chassis');

            if (type === 'btn') {
                document.querySelectorAll('.footswitch').forEach(el => {
                    el.classList.remove('btn-round', 'btn-square', 'btn-rect', 'btn-metal', 'btn-metal-flat', 'btn-soft', 'btn-arcade', 'btn-illuminated', 'btn-hex', 'btn-transparent', 'btn-3pdt', 'btn-mxr', 'btn-boss', 'btn-ehx', 'btn-tc');
                    if (value) el.classList.add(value);
                });
            } else if (type === 'led') {
                document.querySelectorAll('.led-ring').forEach(el => {
                    currentLedStyle = value;
                    el.className = 'led-ring ' + value;
                    if (value === 'led-ring') el.className = 'led-ring';
                });
            } else if (type === 'enc') {
                const encUnit = document.querySelector('.encoder-unit');
                encUnit.classList.forEach(c => { if (c.startsWith('enc-')) encUnit.classList.remove(c); });
                if (value) encUnit.classList.add(value);
            } else if (type === 'screw') {
                document.querySelectorAll('.screw').forEach(el => {
                    el.classList.forEach(c => { if (c.startsWith('screw-') && c !== 'screw') el.classList.remove(c); });
                    if (value) el.classList.add(value);
                });
            } else if (type === 'screen') {
                const oledFrame = document.querySelector('.oled-frame');
                oledFrame.classList.forEach(c => { if (c.startsWith('screen-')) oledFrame.classList.remove(c); });
                if (value) oledFrame.classList.add(value);
            }
        }

        // Apply default component styles on page load
        document.addEventListener('DOMContentLoaded', function () {
            updateStyle('led', 'led-strip');
            updateStyle('screen', 'screen-amoled');
            // Init Screen Color state
            state.screenColor = document.getElementById('col-screen').value;
            applyScreenColor(state.screenColor);
        });

        function updateColor(target, color) {
            const chassisBg = document.querySelector('.chassis-bg');
            const screws = document.querySelectorAll('.screw');
            const encoder = document.querySelector('.knob-cap');

            if (target === 'faceplate') {
                chassisBg.style.background = color;
            } else if (target === 'contour') {
                const thickness = document.getElementById('sl-contour-th')?.value || 2;
                chassisBg.style.boxShadow = `inset 0 0 50px rgba(0,0,0,0.8), 0 20px 50px rgba(0,0,0,0.5), inset 0 0 0 ${thickness}px ${color}`;
                const frontFace = document.querySelector('.front-face');
                if (frontFace) {
                    frontFace.style.boxShadow = `
                        inset ${thickness}px 0 0 0 ${color}, 
                        inset -${thickness}px 0 0 0 ${color}, 
                        inset 0 -${thickness}px 0 0 ${color},
                        inset 0 -3px 8px rgba(255,255,255,0.05),
                        0 20px 40px rgba(0,0,0,0.6)
                    `;
                }
            } else if (target === 'screw') {
                screws.forEach(s => s.style.background = color);
            } else if (target === 'encoder') {
                encoder.style.background = `radial-gradient(circle, ${color}, #000)`;
            } else if (target === 'screen') {
                // Store screen color for persistence
                state.screenColor = color;
                applyScreenColor(color);
                render();
            }
        }

        function applyScreenColor(color) {
            const oledPixelGrid = document.querySelector('.oled-pixel-grid');
            if (oledPixelGrid) {
                oledPixelGrid.style.setProperty('color', color, 'important');
                oledPixelGrid.style.textShadow = `0 0 3px ${color}`;
            }
            // Also apply to status line which may have its own color
            document.querySelectorAll('.oled-status').forEach(el => {
                el.style.setProperty('color', color, 'important');
            });
        }

        function updateSizeControl(target, value) {
            const chassisBg = document.querySelector('.chassis-bg');
            const screws = document.querySelectorAll('.screw');
            const contourColor = document.getElementById('col-contour')?.value || '#333333';

            if (target === 'contour') {
                chassisBg.style.boxShadow = `inset 0 0 50px rgba(0,0,0,0.8), 0 20px 50px rgba(0,0,0,0.5), inset 0 0 0 ${value}px ${contourColor}`;
                const frontFace = document.querySelector('.front-face');
                if (frontFace) {
                    frontFace.style.boxShadow = `
                        inset ${value}px 0 0 0 ${contourColor}, 
                        inset -${value}px 0 0 0 ${contourColor}, 
                        inset 0 -${value}px 0 0 ${contourColor},
                        inset 0 -3px 8px rgba(255,255,255,0.05),
                        0 20px 40px rgba(0,0,0,0.6)
                    `;
                }
                document.getElementById('val-contour-th').textContent = value + 'px';
            } else if (target === 'screw') {
                screws.forEach(s => {
                    s.style.width = value + '%';
                    s.style.height = (parseFloat(value) * 1.5) + '%';
                });
                document.getElementById('val-screw-size').textContent = value + '%';
            }
        }

        function updateChamfer() {
            const checkbox = document.getElementById('chk-chamfer');
            const slider = document.getElementById('sl-chamfer');
            const chassisBg = document.querySelector('.chassis-bg');
            const contourColor = document.getElementById('col-contour')?.value || '#333333';
            const contourThickness = document.getElementById('sl-contour-th')?.value || 2;

            slider.disabled = !checkbox.checked;

            if (checkbox.checked) {
                const size = parseInt(slider.value);
                // Bevel effect using inset shadows to simulate chamfered/beveled edges
                chassisBg.style.boxShadow = `
                    inset 0 0 50px rgba(0,0,0,0.8),
                    inset ${size}px ${size}px ${size * 2}px rgba(80,80,80,0.4),
                    inset -${size}px -${size}px ${size * 2}px rgba(0,0,0,0.6),
                    0 20px 50px rgba(0,0,0,0.5),
                    inset 0 0 0 ${contourThickness}px ${contourColor}
                `;
                document.getElementById('val-chamfer').textContent = size + 'px';
            } else {
                // Reset to default shadow
                chassisBg.style.boxShadow = `inset 0 0 50px rgba(0,0,0,0.8), 0 20px 50px rgba(0,0,0,0.5), inset 0 0 0 ${contourThickness}px ${contourColor}`;
            }
        }

        function updateSlope() {
            const checkbox = document.getElementById('chk-slope');
            const sliderHeight = document.getElementById('sl-slope-y');
            const sliderAngle = document.getElementById('sl-slope-angle');
            const chassisBg = document.querySelector('.chassis-bg');
            const wrapper = document.querySelector('.controller-wrapper');

            const isEnabled = checkbox.checked;
            sliderHeight.disabled = !isEnabled;
            if (sliderAngle) sliderAngle.disabled = !isEnabled;

            document.getElementById('val-slope-y').textContent = sliderHeight.value + 'px';
            if (sliderAngle) document.getElementById('val-slope-angle').textContent = sliderAngle.value + '¬∞';

            // Remove existing front face if any
            const existingFace = wrapper.querySelector('.front-face');
            if (existingFace) existingFace.remove();

            // Reset clip-path on background plate
            chassisBg.style.clipPath = 'none';

            if (isEnabled) {
                const faceHeight = parseInt(sliderHeight.value);
                const angle = parseInt(sliderAngle ? sliderAngle.value : 0);
                const contourColor = document.getElementById('col-contour')?.value || '#333333';
                const contourThickness = parseInt(document.getElementById('sl-contour-th')?.value || 2);
                const cornerRadius = parseInt(document.getElementById('sl-rad')?.value || 40);

                // Crop only the background plate
                chassisBg.style.clipPath = `inset(0 0 ${faceHeight}px 0)`;

                // Create the front face element
                const frontFace = document.createElement('div');
                frontFace.className = 'front-face';

                frontFace.style.cssText = `
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    width: 100%;
                    max-width: var(--chassis-w);
                    margin: 0 auto;
                    height: ${faceHeight + 2}px;
                    background: linear-gradient(to bottom, #1a1a1a 0%, #0d0d0d 60%, #050505 100%);
                    border-radius: 0 0 ${cornerRadius}px ${cornerRadius}px;
                    /* Use multiple inset shadows for sides and bottom to avoid a 'line' at the join */
                    box-shadow: 
                        inset ${contourThickness}px 0 0 0 ${contourColor}, 
                        inset -${contourThickness}px 0 0 0 ${contourColor}, 
                        inset 0 -${contourThickness}px 0 0 ${contourColor},
                        inset 0 -3px 8px rgba(255,255,255,0.05),
                        0 20px 40px rgba(0,0,0,0.6);
                    z-index: 2;
                    pointer-events: none;
                    transform-origin: top center;
                    transform: perspective(1000px) rotateX(-${angle}deg);
                `;

                wrapper.appendChild(frontFace);
            }
        }

        function updateButtonCount(count) {
            count = parseInt(count);
            document.getElementById('val-btn-count').textContent = count;

            const components = document.querySelector('.chassis-components');
            const chassis = document.querySelector('.chassis');
            const wrapper = document.querySelector('.controller-wrapper');
            const rowCount = parseInt(document.getElementById('sel-btn-rows')?.value || 2);

            // Remove all existing button units from the components layer
            components.querySelectorAll('.button-unit').forEach(b => b.remove());

            // Distribute buttons across rows (bottom to top)
            // For 1 row: all buttons on bottom
            // For 2 rows: split evenly (btm first, then top)
            // For 3 rows: split evenly (btm, mid, top)
            let rowDistribution = [];
            if (rowCount === 1) {
                rowDistribution = [count]; // all on bottom
            } else if (rowCount === 2) {
                const btm = Math.ceil(count / 2);
                const top = count - btm;
                rowDistribution = [btm, top]; // bottom, top
            } else if (rowCount === 3) {
                const perRow = Math.floor(count / 3);
                const remainder = count % 3;
                // Distribute remainder starting from bottom
                const btm = perRow + (remainder >= 1 ? 1 : 0);
                const mid = perRow + (remainder >= 2 ? 1 : 0);
                const top = perRow;
                rowDistribution = [btm, mid, top]; // bottom, middle, top
            }

            // SAFETY: For 10 buttons, ensure layout fits by clamping values.
            // Restore original user values when returning to < 10.
            if (count >= 10) {
                // Save current values if not already saved (and only if we are actually clamping something, 
                // but simpler to just save current state if we are entering high-density mode)
                if (!wrapper.dataset.savedSettings) {
                    wrapper.dataset.savedSettings = JSON.stringify({
                        spacing: document.getElementById('sl-btn-spacing').value,
                        size: document.getElementById('sl-btn-size').value,
                        encX: document.getElementById('sl-enc-x').value
                    });
                }

                // 1. Clamp Spacing
                const spacingSlider = document.getElementById('sl-btn-spacing');
                if (parseFloat(spacingSlider.value) > 17) {
                    spacingSlider.value = 17;
                    document.getElementById('val-btn-spacing').textContent = '17%';
                    wrapper.style.setProperty('--btn-spacing', '17%');
                }

                // 2. Reduce Button Size
                const sizeSlider = document.getElementById('sl-btn-size');
                if (parseFloat(sizeSlider.value) > 7.5) {
                    sizeSlider.value = 7.5;
                    document.getElementById('val-btn-size').textContent = '7.5%';
                    wrapper.style.setProperty('--btn-size', '7.5%');
                }

                // 3. Move Encoder to Edge
                const encXSlider = document.getElementById('sl-enc-x');
                if (parseFloat(encXSlider.value) > 2.5) {
                    encXSlider.value = 2.5;
                    document.getElementById('val-enc-x').textContent = '2.5%';
                    wrapper.style.setProperty('--enc-x', '2.5%');
                }
            } else {
                // Restore values if they were saved (exiting high-density mode)
                if (wrapper.dataset.savedSettings) {
                    try {
                        const saved = JSON.parse(wrapper.dataset.savedSettings);

                        // Restore Spacing
                        const spacingSlider = document.getElementById('sl-btn-spacing');
                        spacingSlider.value = saved.spacing;
                        document.getElementById('val-btn-spacing').textContent = saved.spacing + '%';
                        wrapper.style.setProperty('--btn-spacing', saved.spacing + '%');

                        // Restore Size
                        const sizeSlider = document.getElementById('sl-btn-size');
                        sizeSlider.value = saved.size;
                        document.getElementById('val-btn-size').textContent = saved.size + '%';
                        wrapper.style.setProperty('--btn-size', saved.size + '%');

                        // Restore Encoder
                        const encXSlider = document.getElementById('sl-enc-x');
                        encXSlider.value = saved.encX;
                        document.getElementById('val-enc-x').textContent = saved.encX + '%';
                        wrapper.style.setProperty('--enc-x', saved.encX + '%');

                    } catch (e) { console.error("Error restoring settings", e); }

                    delete wrapper.dataset.savedSettings;
                }
            }

            // Get current styles
            const btnStyle = document.getElementById('sel-btn-fmt')?.value || '';
            const ledStyle = document.getElementById('sel-led-fmt')?.value || 'led-ring';

            // Calculate multipliers for positioning: for N buttons, use -(N-1)/2, -(N-3)/2, ..., (N-1)/2
            // For 4 buttons: -1.5, -0.5, 0.5, 1.5
            // For 3 buttons: -1, 0, 1
            // For 5 buttons: -2, -1, 0, 1, 2
            function getMultipliers(n) {
                const mults = [];
                const halfSpan = (n - 1) / 2;
                for (let i = 0; i < n; i++) {
                    mults.push(-halfSpan + i);
                }
                return mults;
            }

            // Row positioning: top (default), mid (center), btm (bottom)
            // For 3 rows: top = --btn-y-top, mid = 50%, btm = --btn-y-btm
            // For 2 rows: top = --btn-y-top, btm = --btn-y-btm
            // For 1 row: btm = --btn-y-btm
            const rowPositions = rowCount === 3 ? ['btm', 'mid', 'top'] :
                rowCount === 2 ? ['btm', 'top'] : ['btm'];

            let btnNum = 1;
            for (let r = 0; r < rowDistribution.length; r++) {
                const numInRow = rowDistribution[r];
                const rowPos = rowPositions[r];
                const mults = getMultipliers(numInRow);

                for (let i = 0; i < numInRow; i++) {
                    const mult = mults[i];
                    const btn = createButtonElement(btnNum, rowPos, mult, btnStyle, ledStyle);
                    components.appendChild(btn);
                    btnNum++;
                }
            }

            // Update presets with correct button count
            updatePresetsForButtonCount(count);

            // Reinitialize leds and handlers
            initializeLeds();
            initializeButtonHandlers();
            updateLeds();
            render();
        }

        function createButtonElement(num, row, multiplier, btnStyle, ledStyle) {
            const btn = document.createElement('div');
            btn.className = 'button-unit';
            btn.id = `btn-${num}`;
            btn.dataset.tooltip = `Switch ${num}`;

            // Use same formula as CSS: left: calc(50% + multiplier * var(--btn-spacing))
            // The multiplier positions: -1.5, -0.5, 0.5, 1.5 for 4 buttons
            // The CSS class .button-unit already has transform: translate(-50%, -50%) for centering
            // Need to set bottom:auto for top/mid rows to override static CSS rules for #btn-1 through #btn-4
            // Need to set top:auto for bottom row to override static CSS rules for #btn-5 through #btn-8
            if (row === 'top') {
                btn.style.cssText = `position:absolute; top:var(--btn-y-top); bottom:auto; left:calc(50% + ${multiplier} * var(--btn-spacing));`;
            } else if (row === 'mid') {
                // top:50% + the existing translate(-50%,-50%) centers the button vertically
                btn.style.cssText = `position:absolute; top:50%; bottom:auto; left:calc(50% + ${multiplier} * var(--btn-spacing));`;
            } else {
                btn.style.cssText = `position:absolute; top:auto; bottom:var(--btn-y-btm); left:calc(50% + ${multiplier} * var(--btn-spacing));`;
            }

            const footswitch = document.createElement('div');
            footswitch.className = 'footswitch' + (btnStyle ? ' ' + btnStyle : '');

            const led = document.createElement('div');
            led.className = ledStyle === 'led-ring' ? 'led-ring' : 'led-ring ' + ledStyle;
            led.id = `led-${num}`;

            footswitch.appendChild(led);
            btn.appendChild(footswitch);

            return btn;
        }

        function updatePresetsForButtonCount(count) {
            // Update each preset's buttons array to match count
            // For STOMP with count > 8, add IR (yellow) and AMP (orange) buttons
            const extraButtons = [
                { n: 'IR', rgb: [0xFF, 0xD7, 0x00], type: 'CC', isAlternate: true },   // Yellow
                { n: 'AMP', rgb: [0xFF, 0x8C, 0x00], type: 'CC', isAlternate: true }    // Orange
            ];

            presets.forEach((preset, presetIdx) => {
                // Ensure preset has enough buttons
                while (preset.buttons.length < count) {
                    if (presetIdx === 0) {
                        // STOMP: add IR and AMP
                        const extraIdx = preset.buttons.length - 8;
                        if (extraIdx < extraButtons.length) {
                            preset.buttons.push({ ...extraButtons[extraIdx] });
                        } else {
                            preset.buttons.push({ n: `B${preset.buttons.length + 1}`, rgb: [0x80, 0x80, 0x80], type: 'CC', isAlternate: true });
                        }
                    } else {
                        // Other presets: add generic buttons
                        preset.buttons.push({ n: `B${preset.buttons.length + 1}`, rgb: [0xFF, 0xFF, 0xFF], type: 'CC' });
                    }
                }
                // Trim if too many
                if (preset.buttons.length > count) {
                    preset.buttons.length = count;
                }
            });

            // Reset button active states
            state.buttonActive = new Array(count).fill(false);
        }

        function initializeLeds() {
            const ledElements = document.querySelectorAll('[id^="led-"]');
            ledElements.forEach(el => {
                const num = parseInt(el.id.replace('led-', ''));
                leds[num] = el;
            });
        }

        // Store font settings for persistence across renders
        const fontSettings = {
            preset: 1.6,
            labels: 0.8,
            status: 0.7,
            bpm: 1.0,
            h: 1,
            w: 1
        };

        function updateFontSize(target, value) {
            const oledContent = document.getElementById('oled-content');
            fontSettings[target] = parseFloat(value);

            if (target === 'preset') {
                document.querySelectorAll('.oled-preset-name').forEach(el => el.style.fontSize = value + 'em');
                document.getElementById('val-font-preset').textContent = value + 'em';
            } else if (target === 'labels') {
                document.querySelectorAll('.oled-row-top, .oled-row-btm').forEach(el => el.style.fontSize = value + 'em');
                document.getElementById('val-font-labels').textContent = value + 'em';
            } else if (target === 'status') {
                document.querySelectorAll('.oled-status').forEach(el => el.style.fontSize = value + 'em');
                document.getElementById('val-font-status').textContent = value + 'em';
            } else if (target === 'bpm') {
                document.querySelectorAll('.oled-bpm').forEach(el => el.style.fontSize = value + 'em');
                document.getElementById('val-font-bpm').textContent = value + 'em';
            } else if (target === 'h') {
                // Character height - use scaleY on text
                oledContent.style.transform = `scaleY(${value}) scaleX(${fontSettings.w})`;
                document.getElementById('val-font-h').textContent = value + 'x';
            } else if (target === 'w') {
                // Character width and spacing
                const wVal = parseFloat(value);
                oledContent.style.transform = `scaleY(${fontSettings.h}) scaleX(${value})`;
                oledContent.style.letterSpacing = ((wVal - 1) * 3) + 'px'; // Adjust spacing based on width
                document.getElementById('val-font-w').textContent = value + 'x';
            }
        }

        // Apply stored font settings after each render
        function applyFontSettings() {
            document.querySelectorAll('.oled-preset-name').forEach(el => el.style.fontSize = fontSettings.preset + 'em');
            document.querySelectorAll('.oled-row-top, .oled-row-btm').forEach(el => el.style.fontSize = fontSettings.labels + 'em');
            document.querySelectorAll('.oled-status').forEach(el => el.style.fontSize = fontSettings.status + 'em');
            document.querySelectorAll('.oled-bpm').forEach(el => el.style.fontSize = fontSettings.bpm + 'em');
            const oledContent = document.getElementById('oled-content');
            if (oledContent) {
                oledContent.style.transform = `scaleY(${fontSettings.h}) scaleX(${fontSettings.w})`;
                oledContent.style.letterSpacing = ((fontSettings.w - 1) * 3) + 'px';
            }
            // Re-apply screen color if set
            if (state.screenColor) {
                applyScreenColor(state.screenColor);
            }
        }

        // ==========================================
        // IMPORT CONFIGURATION
        // ==========================================
        function importConfig(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const config = JSON.parse(e.target.result);
                    console.log("Importing Config:", config);

                    // 1. Update System Settings (Button Count usually)
                    if (config.system && config.system.buttonCount) {
                        const count = config.system.buttonCount;
                        document.getElementById('sl-btn-count').value = count;
                        document.getElementById('val-btn-count').textContent = count;
                        updateButtonCount(count);
                    }

                    // 2. Update Presets
                    if (config.presets && Array.isArray(config.presets)) {
                        config.presets.forEach((impPreset, idx) => {
                            if (idx < presets.length) {
                                const intPreset = presets[idx];
                                intPreset.name = impPreset.name;
                                intPreset.ledMode = impPreset.ledMode;

                                if (impPreset.buttons && Array.isArray(impPreset.buttons)) {
                                    impPreset.buttons.forEach((impBtn, bIdx) => {
                                        if (bIdx < intPreset.buttons.length) {
                                            const intBtn = intPreset.buttons[bIdx];
                                            intBtn.n = impBtn.name;
                                            if (Array.isArray(impBtn.color)) intBtn.rgb = impBtn.color;
                                            intBtn.ledMode = impBtn.ledMode;

                                            // Robust Message Logic
                                            if (impBtn.messages && Array.isArray(impBtn.messages)) {
                                                intBtn.messages = impBtn.messages;
                                            }

                                            intBtn.isAlternate = (impBtn.ledMode === 'toggle');
                                        }
                                    });
                                }
                            }
                        });
                        alert("Configuration Loaded!");
                        updateLeds();
                        render();
                    }
                } catch (err) {
                    console.error("Import Error:", err);
                    alert("Error loading config: " + err.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function copyConfig() {
            const configText = JSON.stringify({
                system: { buttonCount: parseInt(document.getElementById('sl-btn-count').value) },
                presets: presets.map(p => ({
                    name: p.name,
                    ledMode: p.ledMode,
                    buttons: p.buttons.map(b => ({
                        name: b.n,
                        color: b.rgb,
                        ledMode: b.ledMode,
                        messages: b.messages
                    }))
                }))
            }, null, 2);
            navigator.clipboard.writeText(configText).then(() => {
                const msg = document.getElementById('copy-msg');
                msg.style.opacity = 1;
                setTimeout(() => msg.style.opacity = 0, 2000);
            });
        }


        // --- VIRTUAL CONTROLLER LOGIC ---
        const oledContent = document.getElementById('oled-content');
        const tooltip = document.getElementById('v-tooltip');
        const encoder = document.getElementById('encoder-knob');

        const ledIds = [1, 2, 3, 4, 5, 6, 7, 8];
        const leds = {};
        ledIds.forEach(id => leds[id] = document.getElementById('led-' + id));

        // ============================================
        // FIRMWARE-ACCURATE PRESET DATA
        // From DefaultPresets.h - exact RGB values
        // ============================================
        const presets = [
            // Preset 0: STOMP
            {
                name: 'STOMP',
                buttons: [
                    { n: 'NR', rgb: [0xFF, 0xFF, 0xFF], type: 'CC', isAlternate: true, messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 43, val2: 127 }, { action: '2ND_PRESS', type: 'CC', ch: 1, val1: 43, val2: 0 }] },
                    { n: 'FX1', rgb: [0x3F, 0x67, 0xFF], type: 'CC', isAlternate: true, messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 44, val2: 127 }, { action: '2ND_PRESS', type: 'CC', ch: 1, val1: 44, val2: 0 }] },
                    { n: 'DRV', rgb: [0xFC, 0x2C, 0x00], type: 'CC', isAlternate: true, messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 45, val2: 127 }, { action: '2ND_PRESS', type: 'CC', ch: 1, val1: 45, val2: 0 }] },
                    { n: 'TAP', rgb: [0xFF, 0xFF, 0xFF], type: 'TAP_TEMPO', messages: [{ action: 'PRESS', type: 'TAP_TEMPO', ch: 1, val1: 0, val2: 0 }] },
                    { n: 'EQ', rgb: [0x0A, 0xF5, 0x00], type: 'CC', isAlternate: true, messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 48, val2: 127 }, { action: '2ND_PRESS', type: 'CC', ch: 1, val1: 48, val2: 0 }] },
                    { n: 'FX2', rgb: [0x11, 0xF3, 0xFF], type: 'CC', isAlternate: true, messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 49, val2: 127 }, { action: '2ND_PRESS', type: 'CC', ch: 1, val1: 49, val2: 0 }] },
                    { n: 'DLY', rgb: [0x33, 0x2A, 0xFF], type: 'CC', isAlternate: true, messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 50, val2: 127 }, { action: '2ND_PRESS', type: 'CC', ch: 1, val1: 50, val2: 0 }] },
                    { n: 'RVB', rgb: [0x84, 0x00, 0xF7], type: 'CC', isAlternate: true, messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 51, val2: 127 }, { action: '2ND_PRESS', type: 'CC', ch: 1, val1: 51, val2: 0 }] }
                ]
            },
            // Preset 1: BANKS 1-8
            {
                name: 'BANKS 1-8',
                buttons: [
                    { n: 'B1', rgb: [0xFF, 0xFF, 0xFF], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 1 }] },
                    { n: 'B2', rgb: [0xFF, 0xFF, 0xFF], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 2 }] },
                    { n: 'B3', rgb: [0xFF, 0xFF, 0xFF], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 3 }] },
                    { n: 'B4', rgb: [0xFF, 0xFF, 0xFF], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 4 }] },
                    { n: 'B5', rgb: [0x0A, 0xF5, 0x00], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 5 }] },
                    { n: 'B6', rgb: [0x0A, 0xF5, 0x00], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 6 }] },
                    { n: 'B7', rgb: [0x0A, 0xF5, 0x00], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 7 }] },
                    { n: 'B8', rgb: [0x0A, 0xF5, 0x00], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 8 }] }
                ]
            },
            // Preset 2: BANKS 9-16
            {
                name: 'BANKS 9-16',
                buttons: [
                    { n: 'B9', rgb: [0x11, 0xF3, 0xFF], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 9 }] },
                    { n: 'B10', rgb: [0x11, 0xF3, 0xFF], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 10 }] },
                    { n: 'B11', rgb: [0x11, 0xF3, 0xFF], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 11 }] },
                    { n: 'B12', rgb: [0x11, 0xF3, 0xFF], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 12 }] },
                    { n: 'B13', rgb: [0xAA, 0x00, 0xFF], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 13 }] },
                    { n: 'B14', rgb: [0xAA, 0x00, 0xFF], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 14 }] },
                    { n: 'B15', rgb: [0xAA, 0x00, 0xFF], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 15 }] },
                    { n: 'B16', rgb: [0xAA, 0x00, 0xFF], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 16 }] }
                ]
            },
            // Preset 3: Note
            {
                name: 'Note',
                buttons: [
                    { n: '1st', rgb: [0xFD, 0x00, 0x00], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 40 }] },
                    { n: '2nd', rgb: [0xFD, 0x00, 0x00], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 41 }] },
                    { n: '3rd', rgb: [0xFD, 0x00, 0x00], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 42 }] },
                    { n: '4th', rgb: [0xFD, 0x00, 0x00], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 43 }] },
                    { n: '5th', rgb: [0xFD, 0x00, 0x00], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 44 }] },
                    { n: '6th', rgb: [0xFD, 0x00, 0x00], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 45 }] },
                    { n: '7th', rgb: [0xFD, 0x00, 0x00], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 46 }] },
                    { n: '8up', rgb: [0xFD, 0x00, 0x00], type: 'CC', messages: [{ action: 'PRESS', type: 'CC', ch: 1, val1: 1, val2: 47 }] }
                ]
            }
        ];

        // Rhythm patterns from Globals.h
        const rhythmMultipliers = [1.0, 0.5, 0.75, 2.0];
        const rhythmNames = ["1/4", "1/8", "1/8d", "1/2"];

        // ============================================
        // SYSTEM STATE (mirrors firmware globals)
        // ============================================
        let state = {
            // Mode: 0=Preset, 1=Menu (matches firmware currentMode)
            currentMode: 0,
            presetIndex: 0,
            menuSelection: 0,
            inSubMenu: false,
            editingValue: 0,

            // Button name overlay
            buttonNameToShow: '',
            buttonNameDisplayUntil: 0,

            // UI Settings (from firmware)
            buttonNameFontSize: 5,
            ledBrightnessOn: 255,
            ledBrightnessDim: 120,
            buttonDebounce: 20,

            // Connection status
            bleConnected: true,
            wifiOn: false,
            wifiOnAtBoot: false,
            bleMode: 'CLIENT', // CLIENT, SERVER, DUAL

            // Button states (for LED tracking)
            buttonActive: [false, false, false, false, false, false, false, false],
            buttonNextIsB: [false, false, false, false, false, false, false, false],

            // Tap Tempo
            inTapTempoMode: false,
            tapModeLocked: false,
            lastTapTime: 0,
            tapModeTimeout: 0,
            currentBPM: 120.0,
            rhythmPattern: 0,

            // LED blink state
            tapBlinkState: false,
            lastTapBlinkTime: 0,

            // Last MIDI sent
            lastSentMidi: '',

            // SYNC SPM State
            syncMode: 'SPM', // 'NONE', 'SPM', 'GP5' - Default to SPM
            spmEffectStates: [false, false, false, false, false, false, false, false, false], // NR, FX1, DRV, AMP, IR, EQ, FX2, DLY, RVB
            spmStateReceived: false,
            lastSpmStateRequest: 0
        };

        // ============================================
        // MENU ITEMS (from displayMenu() in UI_Display.cpp)
        // ============================================
        function getMenuItems() {
            const bleModeStr = state.bleMode === 'CLIENT' ? 'CLIENT' :
                state.bleMode === 'DUAL' ? 'DUAL' : 'SERVER';
            return [
                'Save and Exit',
                'Exit without Saving',
                `Wi-Fi Editor (${state.wifiOn ? 'ON' : 'OFF'})`,
                'LED Bright (On)',
                'LED Bright (Dim)',
                'Pad Debounce',
                'Clear BLE Bonds',
                'Reboot',
                'Factory Reset',
                'Name Font Size',
                `Wifi ${state.wifiOnAtBoot ? 'ON' : 'OFF'} at Boot`,
                `BLE: ${bleModeStr}`
            ];
        }

        // ============================================
        // MAIN LOOP (runs every 100ms)
        // ============================================
        setInterval(() => {
            const now = Date.now();

            // Tap mode timeout (if not locked)
            if (state.inTapTempoMode && !state.tapModeLocked && now > state.tapModeTimeout) {
                state.inTapTempoMode = false;
                state.tapModeLocked = false;
                render();
            }

            // Clear button name overlay
            if (state.buttonNameDisplayUntil > 0 && now > state.buttonNameDisplayUntil) {
                state.buttonNameDisplayUntil = 0;
                state.buttonNameToShow = '';
                render();
            }

            // Tap tempo LED blink (rhythm-aligned)
            if (state.currentMode === 0 && state.currentBPM > 0) {
                const finalDelayMs = (60000.0 / state.currentBPM) * rhythmMultipliers[state.rhythmPattern];

                if (state.tapBlinkState && (now - state.lastTapBlinkTime >= 50)) {
                    state.tapBlinkState = false;
                    updateLeds();
                } else if (!state.tapBlinkState && (now - state.lastTapBlinkTime >= finalDelayMs)) {
                    state.tapBlinkState = true;
                    state.lastTapBlinkTime = now;
                    updateLeds();
                }
            }
        }, 50);

        // ============================================
        // RENDER FUNCTIONS (from UI_Display.cpp)
        // ============================================
        function render() {
            // Button name overlay (displayButtonName)
            if (state.buttonNameDisplayUntil > 0 && state.buttonNameToShow) {
                const sizeEm = state.buttonNameFontSize * 0.8;
                oledContent.innerHTML = `<div class="oled-overlay" style="font-size:${sizeEm}em">${state.buttonNameToShow}</div>`;
                return;
            }

            // Tap Tempo Mode (displayTapTempoMode)
            if (state.inTapTempoMode) {
                renderTapTempoMode();
                return;
            }

            // Menu Mode (displayMenu)
            if (state.currentMode === 1) {
                renderMenuMode();
                return;
            }

            // Preset Mode (displayOLED)
            renderPresetMode();
        }

        function renderTapTempoMode() {
            const finalDelayMs = Math.round((60000.0 / state.currentBPM) * rhythmMultipliers[state.rhythmPattern]);
            const bpmStr = state.currentBPM.toFixed(1);

            oledContent.innerHTML = `
                <div class="oled-row-top">
                    <span>NEXT</span>
                    <span>${state.tapModeLocked ? 'LOCKED' : 'LOCK'}</span>
                </div>
                <div class="oled-main-area" style="justify-content:center;">
                    <div style="font-size:2.5em; line-height:1;">${bpmStr}</div>
                </div>
                <div class="oled-status" style="border:none;">
                    <span>Pattern: ${rhythmNames[state.rhythmPattern]}</span>
                    <span>${finalDelayMs}ms</span>
                </div>
                <div class="oled-row-btm">
                    <span>PREV</span>
                    <span>TAP</span>
                </div>
            `;
            applyFontSettings();
            updateLeds();
        }

        function renderMenuMode() {
            const menuItems = getMenuItems();

            if (state.inSubMenu) {
                let valueStr = state.editingValue;
                oledContent.innerHTML = `
                    <div class="oled-menu-header">-- Menu CHOCOTONE --</div>
                    <div style="padding:8px; text-align:center;">
                        <div style="font-size:0.8em; color:#888;">Editing:</div>
                        <div style="margin:5px 0;">${menuItems[state.menuSelection].split('(')[0]}</div>
                        <div style="font-size:1.8em; color:#fff; margin-top:10px;">${valueStr}</div>
                    </div>
                `;
            } else {
                // Show 5 lines at a time, scrolling
                let lineOffset = state.menuSelection - 2;
                if (lineOffset < 0) lineOffset = 0;
                if (lineOffset > menuItems.length - 5) lineOffset = menuItems.length - 5;

                let html = '<div class="oled-menu-header">-- Menu CHOCOTONE --</div><div class="oled-menu-list">';
                for (let i = 0; i < menuItems.length; i++) {
                    const displayLine = i - lineOffset;
                    if (displayLine >= 0 && displayLine < 5) {
                        const sel = (i === state.menuSelection) ? '> ' : '  ';
                        html += `<div class="oled-menu-item">${sel}${menuItems[i]}</div>`;
                    }
                }
                html += '</div>';
                oledContent.innerHTML = html;
            }

            // LEDs off in menu mode
            applyFontSettings();
            Object.values(leds).forEach(l => {
                l.style.borderColor = '#222';
                l.style.boxShadow = 'none';
            });
        }

        function renderPresetMode() {
            // Check for Message Overlay (Button Name / Action)
            if (state.buttonNameToShow && Date.now() < state.buttonNameDisplayUntil) {
                const domColor = document.getElementById('col-screen') ? document.getElementById('col-screen').value : '#00FFFF';
                const sc = state.screenColor || domColor;
                oledContent.innerHTML = `
                    <div style="display:flex; justify-content:center; align-items:center; height:100%; font-size:2em; font-weight:bold; text-align:center; color:${sc}; text-shadow:0 0 3px ${sc};">
                        ${state.buttonNameToShow}
                    </div>
                `;
                // Apply font settings creates standard scaling, which is fine.
                applyFontSettings();
                updateLeds();
                return;
            }

            const p = presets[state.presetIndex];
            const btnCount = p.buttons.length;
            const btmRowCount = Math.floor(btnCount / 2);
            const topRowCount = Math.ceil(btnCount / 2);

            // Top Row - higher numbered buttons (btmRowCount+1 to btnCount)
            let topLabels = '';
            for (let i = btmRowCount; i < btnCount; i++) {
                topLabels += `<span>${cutName(p.buttons[i].n)}</span>`;
            }
            const topRow = `<div class="oled-row-top">${topLabels}</div>`;

            // Main area - Preset name and BPM
            const main = `<div class="oled-main-area">
                <div class="oled-preset-name">${p.name.substring(0, 10)}</div>
                <div class="oled-bpm">BPM:${state.currentBPM.toFixed(1)}</div>
            </div>`;

            // Status line
            const status = `<div class="oled-status">
                <span>BLE:${state.bleConnected ? 'Y' : 'N'}</span>
                <span>WiFi:${state.wifiOn ? 'Y' : 'N'}</span>
            </div>`;

            // Bottom Row - lower numbered buttons (0 to btmRowCount-1)
            let btmLabels = '';
            for (let i = 0; i < btmRowCount; i++) {
                btmLabels += `<span>${cutName(p.buttons[i].n)}</span>`;
            }
            const btmRow = `<div class="oled-row-btm">${btmLabels}</div>`;

            oledContent.innerHTML = topRow + main + status + btmRow;
            applyFontSettings();
            updateLeds();
        }

        function cutName(name) { return name.substring(0, 4); }

        function rgbToHex(rgb) {
            return '#' + rgb.map(c => c.toString(16).padStart(2, '0')).join('');
        }

        function updateLeds() {
            const preset = presets[state.presetIndex];

            preset.buttons.forEach((btn, idx) => {
                const l = leds[idx + 1];
                if (!l) return;

                const isTapTempo = btn.type === 'TAP_TEMPO';
                const isActive = state.buttonActive[idx];

                // Brightness calculation
                let brightness;
                if (isTapTempo && state.tapBlinkState) {
                    brightness = 255; // Full bright during flash
                } else {
                    brightness = isActive ? state.ledBrightnessOn : state.ledBrightnessDim;
                }

                // Apply brightness to RGB
                const r = Math.round((btn.rgb[0] * brightness) / 255);
                const g = Math.round((btn.rgb[1] * brightness) / 255);
                const b = Math.round((btn.rgb[2] * brightness) / 255);
                const color = `rgb(${r}, ${g}, ${b})`;

                l.className = 'led-ring ' + currentLedStyle + (isActive ? ' active' : '');
                if (currentLedStyle === 'led-ring') l.className = 'led-ring' + (isActive ? ' active' : '');

                l.style.setProperty('--led-color', color);
                l.parentElement.style.setProperty('--active-led-color', color);
                l.style.borderColor = color;

                if (isActive || (isTapTempo && state.tapBlinkState)) {
                    l.style.boxShadow = `0 0 15px ${color}`;
                } else {
                    l.style.boxShadow = `0 0 5px ${color}`;
                }
            });
        }

        // ============================================
        // TAP TEMPO HANDLING (from handleTapTempo in Input.cpp)
        // ============================================
        function handleTapTempo() {
            const now = Date.now();

            // Reset if more than 3 seconds since last tap
            if (!state.inTapTempoMode || (now - state.lastTapTime > 3000)) {
                state.lastTapTime = now;
                state.inTapTempoMode = true;
                state.tapModeTimeout = now + 3000;
                render();
                return;
            }

            // Calculate BPM from interval
            const interval = now - state.lastTapTime;
            state.lastTapTime = now;
            state.currentBPM = 60000.0 / interval;
            state.currentBPM = Math.max(40, Math.min(300, state.currentBPM));

            state.tapModeTimeout = now + 3000;
            render();
        }

        // ============================================
        // MENU SELECTION HANDLING (from handleMenuSelection in Input.cpp)
        // ============================================
        function handleMenuSelection() {
            const menuItems = getMenuItems();

            if (!state.inSubMenu) {
                switch (state.menuSelection) {
                    case 0: // Save and Exit
                        state.currentMode = 0;
                        render();
                        break;
                    case 1: // Exit without Saving
                        state.currentMode = 0;
                        render();
                        break;
                    case 2: // Wi-Fi Toggle
                        state.wifiOn = !state.wifiOn;
                        render();
                        break;
                    case 3: // LED Bright On
                        state.inSubMenu = true;
                        state.editingValue = state.ledBrightnessOn;
                        break;
                    case 4: // LED Bright Dim
                        state.inSubMenu = true;
                        state.editingValue = state.ledBrightnessDim;
                        break;
                    case 5: // Pad Debounce
                        state.inSubMenu = true;
                        state.editingValue = state.buttonDebounce;
                        break;
                    case 6: // Clear BLE Bonds
                        state.buttonNameToShow = 'BLE CLR';
                        state.buttonNameDisplayUntil = Date.now() + 1000;
                        state.currentMode = 0;
                        break;
                    case 7: // Reboot
                        state.buttonNameToShow = 'REBOOT';
                        state.buttonNameDisplayUntil = Date.now() + 1000;
                        state.currentMode = 0;
                        break;
                    case 8: // Factory Reset
                        state.buttonNameToShow = 'RESET';
                        state.buttonNameDisplayUntil = Date.now() + 1000;
                        state.currentMode = 0;
                        break;
                    case 9: // Name Font Size
                        state.inSubMenu = true;
                        state.editingValue = state.buttonNameFontSize;
                        break;
                    case 10: // WiFi On at Boot
                        state.wifiOnAtBoot = !state.wifiOnAtBoot;
                        render();
                        break;
                    case 11: // BLE Mode
                        if (state.bleMode === 'CLIENT') state.bleMode = 'DUAL';
                        else if (state.bleMode === 'DUAL') state.bleMode = 'SERVER';
                        else state.bleMode = 'CLIENT';
                        render();
                        break;
                }
            } else {
                // Exiting submenu - apply value
                state.inSubMenu = false;
                switch (state.menuSelection) {
                    case 3: state.ledBrightnessOn = state.editingValue; break;
                    case 4: state.ledBrightnessDim = state.editingValue; break;
                    case 5: state.buttonDebounce = state.editingValue; break;
                    case 9: state.buttonNameFontSize = state.editingValue; break;
                }
                updateLeds();
            }
            render();
        }

        // ============================================
        // INPUT HANDLERS
        // ============================================

        function handleButtonMouseDown(btnLogicIndex) {
            if (state.currentMode !== 0) return; // Only in preset mode

            const p = presets[state.presetIndex];
            const btnConfig = p.buttons[btnLogicIndex];
            if (!btnConfig) return;

            // 1. Check for TAP TEMPO Action
            const pressAction = btnConfig.messages ? btnConfig.messages.find(m => m.action === 'PRESS') : null;
            if (pressAction && pressAction.type === 'TAP_TEMPO') {
                handleTapTempo(btnLogicIndex);
                // Also set button name for tap?
                state.buttonNameToShow = "TAP";
                state.buttonNameDisplayUntil = Date.now() + 500;
                render();
                return;
            }

            // 2. Handle Tap Mode Shortcuts (Lock, Prev, Next)
            if (state.inTapTempoMode) {
                // Check if this button is mapped to Lock (RVB / Button 8 / Index 7)
                if (btnConfig.n === 'RVB' || btnLogicIndex === 7) {
                    // Toggle Lock
                    state.tapModeLocked = !state.tapModeLocked;
                    state.buttonNameToShow = state.tapModeLocked ? "LOCKED" : "UNLOCKED";
                    state.buttonNameDisplayUntil = Date.now() + 1000;
                    if (state.tapModeLocked) state.tapModeTimeout = 0;
                    else state.tapModeTimeout = Date.now() + 3000;

                    render();
                    return;
                }
            }

            // 3. Normal / Toggle State Logic
            if (btnConfig.ledMode === 'momentary') {
                state.buttonActive[btnLogicIndex] = true;
                updateLeds();
            } else if (btnConfig.ledMode === 'selection') {
                state.selectionState = btnLogicIndex;
            } else {
                // Toggle mode
                if (btnConfig.isAlternate) {
                    state.buttonActive[btnLogicIndex] = !state.buttonActive[btnLogicIndex];
                } else {
                    state.buttonActive[btnLogicIndex] = !state.buttonActive[btnLogicIndex];
                }
            }

            // 4. Send MIDI
            if (btnConfig.messages) {
                let msgToSend = null;
                // Determine which message (PRESS vs 2ND_PRESS)
                if (btnConfig.ledMode === 'toggle' || (btnConfig.isAlternate && btnConfig.ledMode !== 'momentary')) {
                    const isGoingOn = state.buttonActive[btnLogicIndex];
                    msgToSend = isGoingOn
                        ? btnConfig.messages.find(m => m.action === 'PRESS')
                        : btnConfig.messages.find(m => m.action === '2ND_PRESS');
                } else {
                    msgToSend = btnConfig.messages.find(m => m.action === 'PRESS');
                }

                if (msgToSend) {
                    sendMidiMessage(msgToSend);
                }
            }

            // 5. Visual Feedback (OLED Name)
            state.buttonNameToShow = btnConfig.n;
            state.buttonNameDisplayUntil = Date.now() + 500;

            render();
        }

        function handleButtonMouseUp(btnLogicIndex) {
            if (state.currentMode !== 0) return;

            const p = presets[state.presetIndex];
            const btnConfig = p.buttons[btnLogicIndex];
            if (!btnConfig) return;

            // Only release non-alternate (momentary) buttons after brief delay
            if (!btnConfig.isAlternate && btnConfig.type !== 'TAP_TEMPO') {
                setTimeout(() => {
                    state.buttonActive[btnLogicIndex] = false;
                    render();
                }, 100);
            }
        }

        // Initialize button handlers
        // Initialize button handlers
        function initializeButtonHandlers() {
            document.querySelectorAll('.button-unit').forEach((unit) => {
                const btnId = parseInt(unit.id.replace('btn-', ''));
                // Convert button ID to logic index (1-based to 0-based)
                const btnLogicIndex = btnId - 1;

                // Check if listener is already attached? No easy way.
                // Rely on updateButtonCount recreating the element, 
                // OR ensure this is only called once per element creation.
                // Since this function is called by updateButtonCount, we do NOT need to call it globally.

                unit.addEventListener('mousedown', () => handleButtonMouseDown(btnLogicIndex));
                unit.addEventListener('mouseup', () => handleButtonMouseUp(btnLogicIndex));
                unit.addEventListener('mouseleave', () => handleButtonMouseUp(btnLogicIndex));
            });
        }
        // initializeButtonHandlers(); // REMOVED: Caused double-binding because updateButtonCount also calls it.

        // Encoder handling
        let encTimer = null;
        let isLongPress = false;
        let encoderRotation = 0;
        // Setup smooth rotation transition for encoder
        const knobCap = document.querySelector('.knob-cap');
        if (knobCap) {
            knobCap.style.transition = 'transform 0.1s ease-out';
        }

        encoder.addEventListener('mousedown', () => {
            isLongPress = false;
            encTimer = setTimeout(() => {
                isLongPress = true;
                // Long press: Toggle menu mode
                if (state.currentMode === 0) {
                    state.currentMode = 1;
                    state.menuSelection = 0;
                    state.inSubMenu = false;
                    state.inTapTempoMode = false;
                } else {
                    state.currentMode = 0;
                }
                render();
            }, 600);
        });

        encoder.addEventListener('mouseup', () => {
            clearTimeout(encTimer);
            if (!isLongPress) {
                if (state.inTapTempoMode) {
                    // Cycle rhythm pattern
                    state.rhythmPattern = (state.rhythmPattern + 1) % 4;
                    if (!state.tapModeLocked) state.tapModeTimeout = Date.now() + 3000;
                    render();
                } else if (state.currentMode === 1) {
                    // Menu mode: select item
                    handleMenuSelection();
                } else {
                    // Preset mode: cycle presets
                    state.presetIndex = (state.presetIndex + 1) % presets.length;
                    // Reset button states when changing presets
                    state.buttonActive = [false, false, false, false, false, false, false, false];
                    render();
                }
            }
        });

        encoder.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 1 : -1;

            if (state.inTapTempoMode) {
                // Adjust BPM by 0.5 per tick
                state.currentBPM += (delta * -0.5);
                state.currentBPM = Math.max(40, Math.min(300, state.currentBPM));
                state.currentBPM = Math.round(state.currentBPM * 2) / 2; // Snap to 0.5
                if (!state.tapModeLocked) state.tapModeTimeout = Date.now() + 3000;
            } else if (state.currentMode === 1) {
                // Menu mode
                if (state.inSubMenu) {
                    // Adjust editing value
                    state.editingValue += delta;
                    if (state.menuSelection === 3 || state.menuSelection === 4) {
                        state.editingValue = Math.max(0, Math.min(255, state.editingValue));
                    } else if (state.menuSelection === 5) {
                        state.editingValue = Math.max(1, Math.min(500, state.editingValue));
                    } else if (state.menuSelection === 9) {
                        state.editingValue = Math.max(1, Math.min(5, state.editingValue));
                    }
                } else {
                    // Navigate menu
                    const menuItems = getMenuItems();
                    state.menuSelection = Math.max(0, Math.min(menuItems.length - 1, state.menuSelection + delta));
                }
            } else {
                // Preset mode: scroll presets (firmware doesn't do this, but nice UX)
                state.presetIndex = (state.presetIndex + delta + presets.length) % presets.length;
                state.buttonActive = [false, false, false, false, false, false, false, false];
            }

            // Rotate encoder knob visually
            encoderRotation += delta * 15; // 15 degrees per scroll step
            if (knobCap) {
                knobCap.style.transform = `rotate(${encoderRotation}deg)`;
            }

            render();
        });

        // Tooltips
        document.querySelectorAll('.button-unit, .encoder-unit').forEach(el => {
            el.addEventListener('mousemove', (e) => {
                tooltip.style.opacity = 1;
                tooltip.innerText = el.dataset.tooltip;
                tooltip.style.left = (e.pageX + 15) + 'px';
                tooltip.style.top = (e.pageY + 15) + 'px';
            });
            el.addEventListener('mouseleave', () => {
                tooltip.style.opacity = 0;
            });
        });

        // Mouse tracking for glassmorphism cards
        document.querySelectorAll('.control-card').forEach(card => {
            card.addEventListener('mousemove', e => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                card.style.setProperty('--mouse-x', `${x}px`);
                card.style.setProperty('--mouse-y', `${y}px`);
            });
        });

        // Initial render
        render();
    </script>

    <!-- CONTROLS -->
    <section id="controls">
        <div class="container">
            <h2>Mastering Control</h2>
            <div class="controls-grid">
                <!-- BUTTONS -->
                <div class="control-card">
                    <div class="control-icon">üéõÔ∏è</div>
                    <h3>Button Actions</h3>
                    <p>Each button supports 5 configurable action types:</p>
                    <div style="margin-top: 1rem;">
                        <p><span class="badge">PRESS</span> Primary action - toggles effects, sends CC/PC</p>
                        <p><span class="badge">RELEASE</span> Triggers on button release (momentary behavior)</p>
                        <p><span class="badge">LONG PRESS</span> Alternate action after holding 500ms+</p>
                        <p><span class="badge">DOUBLE TAP</span> Quick double-press for fast switching</p>
                        <p><span class="badge">COMBO</span> Press multiple buttons simultaneously</p>
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.85rem; color: #8ffdff;"><strong>LED Modes:</strong> Toggle,
                        Fixed, Sync, Blink for visual feedback</p>
                </div>

                <!-- ENCODER -->
                <div class="control-card">
                    <div class="control-icon">üîÑ</div>
                    <h3>The Encoder</h3>
                    <p>Navigate the system without a computer:</p>
                    <div style="margin-top: 1rem;">
                        <p><span class="badge">ROTATE</span><br>Adjusts parameters (like BPM) or scrolls through menu
                            items.</p>
                        <p><span class="badge">CLICK</span><br>Selects the current menu item or cycles options (like
                            Rhythm Patterns in Tap Mode).</p>
                        <p><span class="badge">LONG PRESS</span><br>Enters or Exits the Main Menu.</p>
                    </div>
                </div>

                <!-- PRESETS -->
                <div class="control-card">
                    <div class="control-icon">üíæ</div>
                    <h3>Switching Presets</h3>
                    <p>Store up to 4 complete configurations.</p>
                    <p>To switch presets:</p>
                    <ol style="margin-left:1.5rem; color:#888;">
                        <li>Assign a button to "Preset +" or "Preset -".</li>
                        <li>OR use the Encoder click in the main view.</li>
                    </ol>
                    <p style="margin-top:1rem;"><em>Pro Tip: Each preset has its own name, button count (4-10), and LED
                            color scheme.</em></p>
                </div>
            </div>
        </div>
    </section>

    <!-- TAP TEMPO DEEP DIVE -->
    <section id="tap-tempo">
        <div class="container">
            <h2>Tap Tempo System</h2>
            <div class="step-list">
                <div class="step-item">
                    <div class="step-num">1</div>
                    <div>
                        <h3>Enter Tap Mode</h3>
                        <p>Press any button assigned to <strong>TAP_TEMPO</strong>. The screen switches to BPM view
                            showing current tempo and delay time in milliseconds.</p>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-num">2</div>
                    <div>
                        <h3>Tap it in</h3>
                        <p>Tap the button rhythmically. The controller calculates the <strong>rolling average
                                BPM</strong> for smooth, accurate timing.</p>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-num">3</div>
                    <div>
                        <h3>Fine Tune</h3>
                        <p>Rotate the encoder to adjust BPM in <strong>0.5</strong> increments. Hold encoder + rotate
                            for faster ¬±5 BPM adjustment.</p>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-num">4</div>
                    <div>
                        <h3>Rhythm Patterns</h3>
                        <p>Click encoder or use <strong>R.prev/R.next</strong> buttons to cycle subdivisions:</p>
                        <div class="rhythm-patterns">
                            <span class="pattern-tag">1/4 (Quarter)</span>
                            <span class="pattern-tag">1/8 (Eighth)</span>
                            <span class="pattern-tag">1/8d (Dotted)</span>
                            <span class="pattern-tag">1/2 (Half)</span>
                        </div>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-num">5</div>
                    <div>
                        <h3>Lock Mode</h3>
                        <p>Configure <strong>TAP_MODE_LOCK</strong> in the button settings to stay in tap tempo mode
                            indefinitely. Perfect for live performers who need constant BPM access.</p>
                        <p style="color: #8ffdff; font-size: 0.9rem; margin-top: 0.5rem;">Tap tempo sends MIDI CC to
                            your connected device in real-time!</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- OLED MENU MAP -->
    <section id="menu">
        <div class="container">
            <h2>OLED System Menu</h2>
            <p style="text-align: center; max-width:600px; margin: 0 auto 2rem auto;">
                Long-press the Encoder to enter the menu. Rotate to navigate, click to select. Here are the options:
            </p>

            <div class="menu-tree">
                <div class="menu-item">
                    <div class="menu-title">Save and Exit</div>
                    <p>Saves all changes to permanent memory (EEPROM) and returns to play mode.</p>
                </div>
                <div class="menu-item">
                    <div class="menu-title">Wi-Fi Config</div>
                    <p>Toggles the WiFi Access Point on/off. <em>Enable to access the web editor at 192.168.4.1</em></p>
                </div>
                <div class="menu-item">
                    <div class="menu-title">BLE Mode</div>
                    <p>Select Bluetooth behavior: <strong>CLIENT</strong> (connect to pedals), <strong>SERVER</strong>
                        (accept connections), or <strong>DUAL</strong> (both).</p>
                </div>
                <div class="menu-item">
                    <div class="menu-title">LED Brightness On</div>
                    <p>Adjusts the brightness level for active LEDs (0-255). Controls how bright buttons glow when
                        effects are ON.</p>
                </div>
                <div class="menu-item">
                    <div class="menu-title">LED Brightness Off</div>
                    <p>Adjusts the dim level for inactive LEDs (0-255). Set to 0 for fully off, or low value for visible
                        but dim.</p>
                </div>
                <div class="menu-item">
                    <div class="menu-title">Button Count</div>
                    <p>Configure number of buttons per preset (4-10). Allows different presets to have different
                        layouts.</p>
                </div>
                <div class="menu-item">
                    <div class="menu-title">Pad Debounce</div>
                    <p>Adjusts button sensitivity delay (1-500ms) to prevent double-triggering.</p>
                </div>
                <div class="menu-item">
                    <div class="menu-title">Display Timeout</div>
                    <p>Screen sleep timer (1-60 seconds). Screen dims after inactivity to save power.</p>
                </div>
                <div class="menu-item">
                    <div class="menu-title">Screen Contrast</div>
                    <p>Adjust OLED brightness/contrast for different lighting conditions.</p>
                </div>
                <div class="menu-item">
                    <div class="menu-title">Clear BLE Bonds</div>
                    <p>Forgets all paired Bluetooth devices. Useful if connection issues occur.</p>
                </div>
                <div class="menu-item">
                    <div class="menu-title">Factory Reset</div>
                    <p>Wipes all settings and presets back to default. <strong>Cannot be
                            undone!</strong></p>
                </div>
            </div>
        </div>
    </section>

    <!-- WEB CONFIG -->
    <section id="web" style="background: radial-gradient(circle at center, #222 0%, #111 100%);">
        <div class="container" style="text-align: center;">
            <h2>Web App Editor</h2>
            <img src="images/chocotone_editor_1v2.png" alt="Web Editor"
                style="max-width: 1200px; width:100%; border-radius:12px; margin-bottom: 2rem; border:1px solid #444;">

            <h3 style="color:var(--accent); margin-bottom: 3rem;">Four Ways to Configure</h3>

            <div class="controls-grid" style="text-align: left; max-width: 1200px; margin: 0 auto 3rem auto;">
                <div class="control-card">
                    <div class="control-icon" style="font-size: 3rem; margin-bottom: 1rem;">üåê</div>
                    <h3 class="text-accent">WiFi Loader</h3>
                    <p>Connect to WiFi AP <strong>CHOCOTONE</strong> (password:
                        <code>12345678</code>). Use this to <strong>Import/Export</strong> your full configuration as a
                        <code>.json</code> file.
                    </p>
                </div>
                <div class="control-card">
                    <div class="control-icon" style="font-size: 3rem; margin-bottom: 1rem;">üîå</div>
                    <h3 class="text-cyan">USB Serial</h3>
                    <p>Connect via USB and use the Web App Editor's Serial connection. No
                        WiFi needed!</p>
                </div>
                <div class="control-card">
                    <div class="control-icon" style="font-size: 3rem; margin-bottom: 1rem;">üì°</div>
                    <h3 class="text-mint">BT Serial</h3>
                    <p>Connect via Bluetooth Serial (SPP) for a wireless connection identical to USB Serial.</p>
                </div>
                <div class="control-card">
                    <div class="control-icon" style="font-size: 3rem; margin-bottom: 1rem;">‚ö°</div>
                    <h3 class="text-accent">BLE Config</h3>
                    <p>Lightweight configuration via Web Bluetooth (BLE). Perfect for quick adjustments on mobile.</p>
                </div>
            </div>

            <p style="color: #888; font-size: 0.9rem;">Use the Web App Editor (<code>chocotone_midi_editor.html</code>)
                for
                full access to all configuration options including JSON import/export.</p>
        </div>
    </section>

    <footer>
        <p>Chocotone MIDI Controller &copy; 2025</p>
    </footer>
</body>

</html>