<!DOCTYPE html>
<html>

<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width,initial-scale=1'>
    <title>Chocotone MIDI Editor v2</title>
    <style>
        :root {
            --bg: #0a0a0f;
            --card: #16161e;
            --card-hover: #1e1e2a;
            --text: #e4e4e7;
            --text-dim: #71717a;
            --acc: #a78bfa;
            --acc-dim: #7c3aed;
            --inp: #27272a;
            --brd: #3f3f46;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --radius: 10px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--brd);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, var(--acc));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .sub {
            color: var(--text-dim);
            font-size: 0.8rem;
            margin-top: 4px;
        }

        /* Section Cards */
        .section {
            background: var(--card);
            border-radius: var(--radius);
            border: 1px solid var(--brd);
            padding: 16px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--acc);
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Row layouts - CSS Grid */
        .row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            align-items: start;
            margin-bottom: 10px;
        }

        /* Form Fields */
        .field {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .field label {
            width: 55px;
            font-size: 0.8rem;
            color: var(--text-dim);
            flex-shrink: 0;
            text-align: right;
        }

        /* Inputs */
        .field input,
        .field select {
            width: 100%;
            min-width: 0;
            background: var(--inp);
            border: 1px solid var(--brd);
            color: var(--text);
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            outline: none;
            transition: border 0.1s;
        }

        .field input:focus,
        .field select:focus {
            border-color: var(--acc);
        }

        .field input[type="color"] {
            height: 34px;
            padding: 2px;
            cursor: pointer;
        }

        .field input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex: none;
        }

        .field.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        /* Button Quick Menu - 2 rows layout */
        .btn-grid {
            display: grid;
            gap: 8px;
            margin-bottom: 8px;
        }

        .btn-tile {
            background: var(--inp);
            border: 2px solid var(--brd);
            border-radius: 8px;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            overflow: hidden;
        }

        .btn-tile:hover {
            background: var(--card-hover);
            border-color: var(--acc-dim);
        }

        .btn-tile.active {
            border-color: var(--acc);
            background: var(--card-hover);
        }

        .btn-tile .num {
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        .btn-tile .name {
            font-size: 0.8rem;
            font-weight: 600;
            margin: 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-tile .info {
            font-size: 0.6rem;
            color: var(--text-dim);
        }

        .btn-tile .colors {
            display: flex;
            justify-content: center;
            gap: 2px;
            margin-top: 4px;
        }

        .btn-tile .colors .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid #fff3;
        }

        /* System Tile - Full width, outside cards */
        .sys-tile-wrap {
            margin: 16px 0;
        }

        .sys-tile {
            background: var(--card);
            border: 1px solid var(--brd);
            border-radius: var(--radius);
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }

        .sys-tile:hover {
            border-color: var(--acc);
            background: var(--card-hover);
        }

        .sys-tile.active {
            border-color: var(--acc);
            background: linear-gradient(135deg, #3700b3, #7c3aed);
        }

        .sys-tile .icon {
            font-size: 1.2rem;
        }

        .sys-tile .label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #fff;
        }

        /* Message Box */
        .msg-box {
            background: var(--inp);
            border: 1px solid var(--brd);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
        }

        .msg-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--acc);
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--brd);
            padding-bottom: 6px;
        }

        /* Delete button */
        .msg-box .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            z-index: 10;
        }

        .msg-box .remove-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* Action Buttons */
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn.primary {
            background: var(--acc);
            color: #fff;
        }

        .btn.primary:hover {
            background: var(--acc-dim);
        }

        .btn.secondary {
            background: var(--inp);
            color: var(--text);
            border: 1px solid var(--brd);
        }

        .btn.success {
            background: var(--success);
            color: #fff;
        }

        .btn.warning {
            background: var(--warning);
            color: #000;
        }

        .btn.sm {
            padding: 4px 10px;
            font-size: 0.75rem;
        }

        /* JSON Area */
        .json-area {
            width: 100%;
            height: 120px;
            background: var(--inp);
            border: 1px solid var(--brd);
            color: var(--text);
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.8rem;
            resize: vertical;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.2rem;
            }
        }
    </style>
    <script src="devices_database.js"></script>
</head>

<body>
    <div class="header">
        <h1>Chocotone MIDI Editor</h1>
        <div class="sub">v2.0 - Hybrid Action System</div>
    </div>

    <div id="app"></div>

    <script>
        // ===============================================================
        // STATE
        // ===============================================================
        var selectedBtn = 0;
        var showSystem = false;

        var actionTypes = ['NO_ACTION', 'PRESS', '2ND_PRESS', 'RELEASE', 'LONG_PRESS', 'DOUBLE_TAP', 'COMBO'];
        var midiTypes = ['OFF', 'NOTE_MOMENTARY', 'NOTE_ON', 'NOTE_OFF', 'CC', 'PC', 'SYSEX', 'TAP_TEMPO', 'PRESET_UP', 'PRESET_DOWN', 'PRESET_1', 'PRESET_2', 'PRESET_3', 'PRESET_4', 'CLEAR_BLE_BONDS', 'WIFI_TOGGLE'];

        // ===============================================================
        // DATA
        // ===============================================================
        var presetData = {
            presets: [
                {
                    name: "STOMP", presetLedMode: "NORMAL", buttons: [
                        { name: "NR", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 43, data2: 127, rgb: "#ffffff" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 43, data2: 0, rgb: "#ffffff" }] },
                        { name: "FX1", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 44, data2: 127, rgb: "#3f67ff" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 44, data2: 0, rgb: "#3f67ff" }] },
                        { name: "DRV", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 45, data2: 127, rgb: "#fc2c00" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 45, data2: 0, rgb: "#ff0000" }] },
                        { name: "TAP", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "TAP_TEMPO", channel: 1, data1: 13, data2: 127, rhythmPrev: 0, rhythmNext: 4, tapLock: 7, rgb: "#ffffff" }] },
                        { name: "EQ", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 48, data2: 127, rgb: "#0af500" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 48, data2: 0, rgb: "#0af500" }, { action: "COMBO", partner: 0, type: "PRESET_DOWN", channel: 1, data1: 0, data2: 0, label: "" }] },
                        { name: "FX2", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 49, data2: 127, rgb: "#11f3ff" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 49, data2: 0, rgb: "#11f3ff" }] },
                        { name: "DLY", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 50, data2: 127, rgb: "#332aff" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 50, data2: 0, rgb: "#332aff" }, { action: "COMBO", partner: 7, type: "WIFI_TOGGLE", channel: 1, data1: 0, data2: 0, label: "" }] },
                        { name: "RVB", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 51, data2: 127, rgb: "#8400f7" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 51, data2: 0, rgb: "#8400f7" }, { action: "COMBO", partner: 3, type: "PRESET_UP", channel: 1, data1: 0, data2: 0, label: "" }] }
                    ]
                },
                {
                    name: "BANKS 1-8", presetLedMode: "SELECTION", buttons: [
                        { name: "B1", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 1, rgb: "#ffffff" }] },
                        { name: "B2", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 2, rgb: "#ffffff" }] },
                        { name: "B3", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 3, rgb: "#ffffff" }] },
                        { name: "B4", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 4, rgb: "#ffffff" }] },
                        { name: "B5", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 5, rgb: "#0af500" }, { action: "COMBO", partner: 0, type: "PRESET_DOWN" }] },
                        { name: "B6", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 6, rgb: "#0af500" }] },
                        { name: "B7", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 7, rgb: "#0af500" }, { action: "COMBO", partner: 7, type: "WIFI_TOGGLE" }] },
                        { name: "B8", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 8, rgb: "#0af500" }, { action: "COMBO", partner: 3, type: "PRESET_UP" }] }
                    ]
                },
                {
                    name: "BANKS 9-16", presetLedMode: "SELECTION", buttons: [
                        { name: "B9", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 9, rgb: "#11f3ff" }] },
                        { name: "B10", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 10, rgb: "#11f3ff" }] },
                        { name: "B11", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 11, rgb: "#11f3ff" }] },
                        { name: "B12", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 12, rgb: "#11f3ff" }] },
                        { name: "B13", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 13, rgb: "#aa00ff" }, { action: "COMBO", partner: 0, type: "PRESET_DOWN" }] },
                        { name: "B14", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 14, rgb: "#aa00ff" }] },
                        { name: "B15", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 15, rgb: "#aa00ff" }, { action: "COMBO", partner: 7, type: "WIFI_TOGGLE" }] },
                        { name: "B16", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 16, rgb: "#aa00ff" }, { action: "COMBO", partner: 3, type: "PRESET_UP" }] }
                    ]
                },
                {
                    name: "Note", presetLedMode: "SELECTION", buttons: [
                        { name: "1st", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "NOTE_MOMENTARY", channel: 1, data1: 60, data2: 127, rgb: "#fd0000" }] },
                        { name: "2nd", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "NOTE_MOMENTARY", channel: 1, data1: 62, data2: 127, rgb: "#fd0000" }] },
                        { name: "3rd", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "NOTE_MOMENTARY", channel: 1, data1: 64, data2: 127, rgb: "#fd0000" }] },
                        { name: "4th", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "NOTE_MOMENTARY", channel: 1, data1: 65, data2: 127, rgb: "#fd0000" }] },
                        { name: "5th", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "NOTE_MOMENTARY", channel: 1, data1: 67, data2: 127, rgb: "#fd0000" }, { action: "COMBO", partner: 0, type: "PRESET_DOWN" }] },
                        { name: "6th", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "NOTE_MOMENTARY", channel: 1, data1: 69, data2: 127, rgb: "#fd0000" }] },
                        { name: "7th", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "NOTE_MOMENTARY", channel: 1, data1: 71, data2: 127, rgb: "#fd0000" }, { action: "COMBO", partner: 7, type: "WIFI_TOGGLE" }] },
                        { name: "8up", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "NOTE_MOMENTARY", channel: 1, data1: 72, data2: 127, rgb: "#fd0000" }, { action: "COMBO", partner: 3, type: "PRESET_UP" }] }
                    ]
                }
            ],
            currentPreset: 0,
            system: {
                bleDeviceName: "CHOCOTONE",
                apSSID: "CHOCOTONE",
                apPassword: "12345678",
                buttonCount: 8,
                buttonPins: "14,27,26,25,33,32,16,17",
                ledPin: 15,
                ledsPerButton: 1,
                ledMap: "0,1,2,3,7,6,5,4,8,9",
                encoderA: 18,
                encoderB: 19,
                encoderBtn: 23,
                bleMode: "CLIENT"
            }
        };

        function fillEmptyPresets() {
            for (let p = 0; p < presetData.presets.length; p++) {
                if (!presetData.presets[p].buttons.length) {
                    for (let i = 0; i < 8; i++) presetData.presets[p].buttons.push(createDefaultButton(i));
                }
            }
        }
        fillEmptyPresets();

        // ===============================================================
        // OPEN MIDI FUNCTIONS
        // ===============================================================
        function getDeviceSelectOptions() {
            var devices = typeof getDeviceList === 'function' ? getDeviceList() : ['Generic MIDI Device'];
            var current = typeof loadSavedDevice === 'function' ? loadSavedDevice() : 'Sonicake Pocket Master';
            return devices.map(function (d) {
                return '<option value="' + d + '"' + (d === current ? ' selected' : '') + '>' + d + '</option>';
            }).join('');
        }
        function getTemplateSelectOptions() {
            var current = typeof loadSavedDevice === 'function' ? loadSavedDevice() : 'Sonicake Pocket Master';
            var templates = typeof getDeviceTemplates === 'function' ? getDeviceTemplates(current) : {};
            var fullConfigs = typeof getFullConfigList === 'function' ? getFullConfigList() : [];

            var html = '<option value="">-- Select Template --</option>';

            // Full Configurations (load everything)
            if (fullConfigs.length > 0) {
                html += '<optgroup label="[Full Configurations]">';
                for (var i = 0; i < fullConfigs.length; i++) {
                    html += '<option value="FULL:' + fullConfigs[i] + '">' + fullConfigs[i] + '</option>';
                }
                html += '</optgroup>';
            }

            // Device-specific partial templates
            html += '<optgroup label="[Button Layouts: ' + current + ']">';
            for (var name in templates) {
                html += '<option value="' + name + '">' + name + '</option>';
            }
            html += '</optgroup>';

            return html;
        }
        function getCCPickerOptions(selectedVal) {
            if (typeof buildCCSelectOptions === 'function') {
                return buildCCSelectOptions(selectedVal);
            }
            // Fallback: simple 0-127
            var html = '';
            for (var i = 0; i <= 127; i++) {
                html += '<option value="' + i + '"' + (i === selectedVal ? ' selected' : '') + '>CC ' + i + '</option>';
            }
            return html;
        }
        function loadDeviceTemplate() {
            var sel = document.getElementById('tmplSelect');
            if (!sel || !sel.value) return alert('Please select a template');
            var tmplName = sel.value;

            // Check if this is a full configuration
            if (tmplName.startsWith('FULL:')) {
                var configName = tmplName.substring(5);
                var fullConfig = typeof getFullConfig === 'function' ? getFullConfig(configName) : null;
                if (!fullConfig) return alert('Full configuration not found');

                // Load system config
                if (fullConfig.system) {
                    for (var key in fullConfig.system) {
                        presetData.system[key] = fullConfig.system[key];
                    }
                }

                // Load all presets
                if (fullConfig.presets) {
                    for (var p = 0; p < fullConfig.presets.length && p < 4; p++) {
                        var srcPreset = fullConfig.presets[p];
                        presetData.presets[p].name = srcPreset.name;
                        presetData.presets[p].presetLedMode = srcPreset.presetLedMode || 'NORMAL';
                        presetData.presets[p].buttons = JSON.parse(JSON.stringify(srcPreset.buttons));
                    }
                }

                selectedBtn = 0;
                render();
                alert('Full configuration "' + configName + '" loaded!\n\nIncludes:\n- System config (10 buttons)\n- All 4 presets');
                return;
            }

            // Regular partial template (only loads buttons for current preset)
            var currentDevice = typeof loadSavedDevice === 'function' ? loadSavedDevice() : 'Sonicake Pocket Master';
            var templates = typeof getDeviceTemplates === 'function' ? getDeviceTemplates(currentDevice) : {};
            var tmpl = templates[tmplName];
            if (!tmpl) return alert('Template not found');

            var p = presetData.currentPreset;
            var count = Math.min(tmpl.length, presetData.system.buttonCount);
            for (var i = 0; i < count; i++) {
                var src = tmpl[i];
                var btn = presetData.presets[p].buttons[i];
                btn.name = src.name;
                btn.messages = [];

                // Check for SysEx template (has sysexOn/sysexOff)
                if (src.sysexOn && src.sysexOff) {
                    // SysEx toggle button - PRESS sends ON, 2ND_PRESS sends OFF
                    btn.messages.push({
                        action: 'PRESS',
                        type: 'SYSEX',
                        channel: 1,
                        data1: 0,
                        data2: 0,
                        rgb: src.color,
                        sysex: src.sysexOn  // Hex string
                    });
                    btn.messages.push({
                        action: '2ND_PRESS',
                        type: 'SYSEX',
                        channel: 1,
                        data1: 0,
                        data2: 0,
                        rgb: src.color,
                        sysex: src.sysexOff  // Hex string
                    });
                    btn.ledMode = 'TOGGLE';
                } else if (src.special) {
                    // Special action (TAP_TEMPO, etc.)
                    var msg1 = { action: 'PRESS', type: src.special, channel: 1, data1: 0, data2: 127, rgb: src.color };
                    btn.messages.push(msg1);
                    btn.ledMode = 'MOMENTARY';
                } else {
                    // Regular CC toggle
                    var msg1 = { action: 'PRESS', type: 'CC', channel: 1, data1: src.cc, data2: (src.d2 !== undefined ? src.d2 : 127), rgb: src.color };
                    btn.messages.push(msg1);
                    btn.messages.push({ action: '2ND_PRESS', type: 'CC', channel: 1, data1: src.cc, data2: 0, rgb: src.color });
                    btn.ledMode = 'TOGGLE';
                }
            }
            render();
            alert('Template "' + tmplName + '" loaded!');
        }
        function changeTargetDevice(d) {
            if (typeof setCurrentDevice === 'function') setCurrentDevice(d);
            render();
        }

        // ===============================================================
        // RENDER UI
        // ===============================================================
        function render() {
            var p = presetData.currentPreset;
            var preset = presetData.presets[p];
            var btn = preset.buttons[selectedBtn];
            var presetMode = preset.presetLedMode || 'NORMAL';
            var showLedMode = (presetMode === 'NORMAL' || presetMode === 'HYBRID');
            var showSelGroup = (presetMode === 'HYBRID');
            var html = '';

            // --- PRESET CONFIG -------------------------------------------
            html += '<div class="section">';
            html += '<div class="section-title">Preset Configuration</div>';
            html += '<div class="row">';
            html += '<div class="field"><label>Preset</label><select onchange="chgPreset(this.value)">';
            for (var i = 0; i < 4; i++) html += '<option value="' + i + '"' + (i === p ? ' selected' : '') + '>' + presetData.presets[i].name + '</option>';
            html += '</select></div>';
            html += '<div class="field"><label>Name</label><input type="text" value="' + preset.name + '" maxlength="20" onchange="preset.name=this.value"></div>';
            html += '<div class="field"><label>LED Mode</label><select onchange="chgPresetLedMode(this.value)">';
            html += '<option value="NORMAL"' + (presetMode === 'NORMAL' ? ' selected' : '') + '>Normal</option>';
            html += '<option value="SELECTION"' + (presetMode === 'SELECTION' ? ' selected' : '') + '>Selection</option>';
            html += '<option value="HYBRID"' + (presetMode === 'HYBRID' ? ' selected' : '') + '>Hybrid</option>';
            html += '</select></div>';
            html += '</div></div>';

            // --- BUTTONS (2 ROWS) ----------------------------------------
            html += '<div class="section">';
            html += '<div class="section-title">Buttons</div>';
            var btnCount = presetData.system.buttonCount || 8;
            var cols = Math.ceil(btnCount / 2); // 2 rows = half columns
            html += '<div class="btn-grid" style="grid-template-columns: repeat(' + cols + ', 1fr)">';
            // Render second half first (top row: 5,6,7,8), then first half (bottom row: 1,2,3,4)
            var half = Math.ceil(btnCount / 2);
            var order = [];
            for (var i = half; i < btnCount; i++) order.push(i); // Top row: indices 4,5,6,7
            for (var i = 0; i < half; i++) order.push(i);        // Bottom row: indices 0,1,2,3
            for (var idx = 0; idx < order.length; idx++) {
                var b = order[idx];
                var bt = preset.buttons[b];
                if (!bt) continue;
                var isActive = (b === selectedBtn && !showSystem);
                var msg1 = (bt.messages && bt.messages[0]) ? bt.messages[0] : { type: 'OFF', data1: 0, rgb: '#555' };

                html += '<div class="btn-tile' + (isActive ? ' active' : '') + '" onclick="selBtn(' + b + ')">';
                html += '<div class="num">BTN ' + (b + 1) + '</div>';
                html += '<div class="name">' + bt.name + '</div>';
                html += '<div class="info">' + msg1.type + ' ' + msg1.data1 + '</div>';
                html += '<div class="colors">';
                html += '<div class="dot" style="background:' + msg1.rgb + '"></div>';
                html += '</div></div>';
            }
            html += '</div>';
            html += '</div>'; // Close Buttons section

            // System Tile - OUTSIDE the Buttons card
            html += '<div class="sys-tile-wrap">';
            html += '<div class="sys-tile' + (showSystem ? ' active' : '') + '" onclick="toggleSystem()">';
            html += '<span class="label">System Configuration</span>';
            html += '</div></div>';

            // --- MAIN CONTENT --------------------------------------------
            if (showSystem) {
                html += renderSystemConfig();
            } else {
                html += renderButtonDetail(btn, selectedBtn, showLedMode, showSelGroup);
            }

            // --- JSON ----------------------------------------------------
            html += '<div class="section">';
            html += '<div class="section-title">Import / Export</div>';
            html += '<textarea class="json-area" id="jsonArea" placeholder="Paste JSON here..."></textarea>';
            html += '<div class="actions" style="margin-top:10px">';
            html += '<button class="btn success" onclick="exportJSON()">Export</button>';
            html += '<button class="btn secondary" onclick="importJSON()">Import</button>';
            html += '<button class="btn secondary" onclick="copyJSON()">Copy</button>';
            html += '<button class="btn warning" onclick="downloadJSON()">Download</button>';
            html += '</div></div>';

            html += '<div style="text-align:center;color:#555;font-size:0.7rem;margin-top:10px">Chocotone v2.0 - Hybrid Editor</div>';
            document.getElementById('app').innerHTML = html;
        }

        function renderButtonDetail(btn, idx, showLedMode, showSelGroup) {
            var html = '<div class="section">';
            html += '<div class="section-title">Button ' + (idx + 1) + ': ' + btn.name + '</div>';

            html += '<div class="row">';
            html += '<div class="field"><label>Label</label><input type="text" value="' + btn.name + '" maxlength="20" onchange="updBtn(\'name\',this.value)"></div>';
            if (showLedMode) {
                html += '<div class="field"><label>LED</label><select onchange="updBtn(\'ledMode\',this.value)">';
                html += '<option value="MOMENTARY"' + (btn.ledMode === 'MOMENTARY' ? ' selected' : '') + '>Momentary</option>';
                html += '<option value="TOGGLE"' + (btn.ledMode === 'TOGGLE' ? ' selected' : '') + '>Toggle</option>';
                html += '</select></div>';
            }
            if (showSelGroup) {
                html += '<div class="field"><label>Sel.Grp</label><input type="checkbox"' + (btn.inSelectionGroup ? ' checked' : '') + ' onchange="updBtn(\'inSelectionGroup\',this.checked)"></div>';
            }
            html += '</div>';

            html += '<div class="section-title" style="margin-top:16px; border-bottom:1px solid #333; padding-bottom:4px">Action List <button class="btn primary sm" style="margin-left:auto" onclick="addMsg()">+</button></div>';

            var msgs = btn.messages || [];
            for (var i = 0; i < msgs.length; i++) html += renderActionCard(msgs[i], i);

            // Save Changes Button
            html += '<div class="actions" style="margin-top:16px; justify-content:center">';
            html += '<button class="btn success" onclick="saveChanges()">Save Changes</button>';
            html += '</div>';

            html += '</div>';
            return html;
        }

        function renderActionCard(msg, i) {
            var html = '<div class="msg-box">';
            html += '<div class="remove-btn" onclick="delMsg(' + i + ')">Ã—</div>';

            // Action Type
            html += '<div class="field" style="margin-bottom:8px; padding-right:30px"><label style="font-weight:600;color:var(--acc)">ACTION</label><select style="font-weight:600" onchange="updMsg(' + i + ',\'action\',this.value)">' + actionOpts(msg.action) + '</select></div>';

            // Conditional fields
            if (msg.action === 'COMBO') {
                html += '<div class="row">';
                html += '<div class="field"><label>Partner</label><select onchange="updMsg(' + i + ',\'partner\',parseInt(this.value))">';
                var cnt = presetData.system.buttonCount;
                for (let b = 0; b < cnt; b++) {
                    if (b !== selectedBtn) html += '<option value="' + b + '"' + (msg.partner === b ? ' selected' : '') + '>BTN ' + (b + 1) + '</option>';
                }
                html += '</select></div>';
                html += '<div class="field"><label>Label</label><input type="text" maxlength="6" value="' + (msg.label || '') + '" placeholder="Auto" onchange="updMsg(' + i + ',\'label\',this.value)"></div>';
                html += '</div>';
            }
            else if (msg.action === 'LONG_PRESS') {
                html += '<div class="row">';
                html += '<div class="field"><label>Hold ms</label><input type="number" min="200" max="3000" step="100" value="' + (msg.holdMs || 500) + '" onchange="updMsg(' + i + ',\'holdMs\',parseInt(this.value))"></div>';
                html += '</div>';
            }

            // MIDI Content
            html += '<div class="row">';
            html += '<div class="field"><label>Type</label><select onchange="updMsg(' + i + ',\'type\',this.value)">' + typeOpts(msg.type) + '</select></div>';
            html += '<div class="field"><label>Ch</label><input type="number" min="1" max="16" value="' + (msg.channel || 1) + '" onchange="updMsg(' + i + ',\'channel\',parseInt(this.value))"></div>';
            // D1 as CC Picker dropdown for CC type
            if (msg.type === 'CC') {
                html += '<div class="field"><label>CC</label><select onchange="updMsg(' + i + ',\'data1\',parseInt(this.value))">' + getCCPickerOptions(msg.data1 || 0) + '</select></div>';
            } else {
                html += '<div class="field"><label>D1</label><input type="number" min="0" max="127" value="' + (msg.data1 || 0) + '" onchange="updMsg(' + i + ',\'data1\',parseInt(this.value))"></div>';
            }
            html += '<div class="field"><label>D2</label><input type="number" min="0" max="127" value="' + (msg.data2 || 0) + '" onchange="updMsg(' + i + ',\'data2\',parseInt(this.value))"></div>';
            html += '<div class="field"><label>RGB</label><input type="color" value="' + (msg.rgb || '#bb86fc') + '" onchange="updMsg(' + i + ',\'rgb\',this.value)"></div>';
            html += '</div>';

            if (msg.type === 'TAP_TEMPO') {
                html += '<div class="row" style="margin-top:8px">';
                html += '<div class="field"><label>R.Prev</label><input type="number" min="0" max="9" value="' + (msg.rhythmPrev || 0) + '" onchange="updMsg(' + i + ',\'rhythmPrev\',parseInt(this.value))"></div>';
                html += '<div class="field"><label>R.Next</label><input type="number" min="0" max="9" value="' + (msg.rhythmNext || 4) + '" onchange="updMsg(' + i + ',\'rhythmNext\',parseInt(this.value))"></div>';
                html += '<div class="field"><label>Lock</label><input type="number" min="0" max="9" value="' + (msg.tapLock || 7) + '" onchange="updMsg(' + i + ',\'tapLock\',parseInt(this.value))"></div>';
                html += '</div>';
            }

            // SysEx hex input field
            if (msg.type === 'SYSEX') {
                html += '<div class="row" style="margin-top:8px">';
                html += '<div class="field" style="flex:1"><label>SysEx Hex (e.g. f00f0f00...f7)</label><input type="text" style="font-family:monospace;font-size:11px" placeholder="f0...f7" value="' + (msg.sysex || '') + '" onchange="updMsg(' + i + ',\'sysex\',this.value.toLowerCase().replace(/[^0-9a-f]/g,\'\'))"></div>';
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function renderSystemConfig() {
            var sys = presetData.system;
            var html = '<div class="section">';
            html += '<div class="section-title">System Configuration</div>';

            // Templates
            html += '<div class="msg-box"><div class="msg-title">Templates</div>';
            html += '<div class="row">';
            html += '<div class="field"><label>Device</label><select onchange="changeTargetDevice(this.value)">' + getDeviceSelectOptions() + '</select></div>';
            html += '</div><div class="row">';
            html += '<div class="field"><label>Template</label><select id="tmplSelect">' + getTemplateSelectOptions() + '</select></div>';
            html += '<div class="field" style="max-width:100px"><button class="btn primary sm" onclick="loadDeviceTemplate()">Load</button></div>';
            html += '</div></div>';

            html += '<div class="msg-box"><div class="msg-title">Bluetooth / WiFi</div>';
            html += '<div class="row">';
            html += '<div class="field"><label>BLE Name</label><input type="text" value="' + sys.bleDeviceName + '" maxlength="20" onchange="updSys(\'bleDeviceName\',this.value)"></div>';
            html += '<div class="field"><label>BLE Mode</label><select onchange="updSys(\'bleMode\',this.value)">';
            html += '<option value="CLIENT"' + (sys.bleMode === 'CLIENT' ? ' selected' : '') + '>Client</option>';
            html += '<option value="SERVER"' + (sys.bleMode === 'SERVER' ? ' selected' : '') + '>Server</option>';
            html += '<option value="DUAL"' + (sys.bleMode === 'DUAL' ? ' selected' : '') + '>Dual</option>';
            html += '</select></div>';
            html += '</div>';
            html += '<div class="row">';
            html += '<div class="field"><label>WiFi SSID</label><input type="text" value="' + sys.apSSID + '" onchange="updSys(\'apSSID\',this.value)"></div>';
            html += '<div class="field"><label>Password</label><input type="text" value="' + sys.apPassword + '" onchange="updSys(\'apPassword\',this.value)"></div>';
            html += '</div></div>';

            html += '<div class="msg-box"><div class="msg-title">Hardware</div>';
            html += '<div class="row">';
            html += '<div class="field"><label>Buttons #</label><input type="number" min="4" max="10" value="' + sys.buttonCount + '" onchange="updBtnCount(parseInt(this.value))"></div>';
            html += '<div class="field"><label>Btn Pins</label><input type="text" value="' + sys.buttonPins + '" onchange="updSys(\'buttonPins\',this.value)"></div>';
            html += '</div>';
            html += '<div class="row">';
            html += '<div class="field"><label>LED Pin</label><input type="number" min="0" max="39" value="' + sys.ledPin + '" onchange="updSys(\'ledPin\',parseInt(this.value))"></div>';
            html += '<div class="field"><label>LEDs/Btn</label><input type="number" min="1" max="32" value="' + sys.ledsPerButton + '" onchange="updSys(\'ledsPerButton\',parseInt(this.value))"></div>';
            html += '<div class="field"><label>LED Map</label><input type="text" value="' + sys.ledMap + '" onchange="updSys(\'ledMap\',this.value)"></div>';
            html += '</div></div>';

            html += '<div class="msg-box"><div class="msg-title">Encoder</div>';
            html += '<div class="row">';
            html += '<div class="field"><label>Enc A</label><input type="number" min="0" max="39" value="' + sys.encoderA + '" onchange="updSys(\'encoderA\',parseInt(this.value))"></div>';
            html += '<div class="field"><label>Enc B</label><input type="number" min="0" max="39" value="' + sys.encoderB + '" onchange="updSys(\'encoderB\',parseInt(this.value))"></div>';
            html += '<div class="field"><label>Enc Btn</label><input type="number" min="0" max="39" value="' + sys.encoderBtn + '" onchange="updSys(\'encoderBtn\',parseInt(this.value))"></div>';
            html += '</div></div>';

            html += '</div>';
            return html;
        }

        function typeOpts(sel) { return midiTypes.map(function (t) { return '<option value="' + t + '"' + (t === sel ? ' selected' : '') + '>' + t + '</option>'; }).join(''); }
        function actionOpts(sel) { return actionTypes.map(function (t) { return '<option value="' + t + '"' + (t === sel ? ' selected' : '') + '>' + t.replace('_', ' ') + '</option>'; }).join(''); }

        function chgPreset(v) { presetData.currentPreset = parseInt(v); selectedBtn = 0; showSystem = false; render(); fetch('/preset?p=' + v).catch(e => { }); if (serialWriter) { serialWriter.write(new TextEncoder().encode('SET_PRESET:' + v + '\n')).catch(e => { }); } }
        function chgPresetLedMode(v) { presetData.presets[presetData.currentPreset].presetLedMode = v; render(); }
        function selBtn(b) { selectedBtn = b; showSystem = false; render(); }
        function toggleSystem() { showSystem = !showSystem; render(); }

        function updBtn(k, v) { presetData.presets[presetData.currentPreset].buttons[selectedBtn][k] = v; render(); }
        function updMsg(idx, k, v) {
            presetData.presets[presetData.currentPreset].buttons[selectedBtn].messages[idx][k] = v;
            if (k === 'type' || k === 'action') render();
        }
        function addMsg() {
            var p = presetData.currentPreset;
            var btn = presetData.presets[p].buttons[selectedBtn];
            if (!btn.messages) btn.messages = [];
            btn.messages.push({ action: 'PRESS', type: 'CC', channel: 1, data1: 0, data2: 127, rgb: '#bb86fc' });
            render();
        }
        function delMsg(idx) {
            var p = presetData.currentPreset;
            presetData.presets[p].buttons[selectedBtn].messages.splice(idx, 1);
            render();
        }
        function updSys(k, v) { presetData.system[k] = v; }
        function saveChanges() {
            // In offline mode, save means export to JSON area
            exportJSON();
            alert('Changes saved! JSON has been updated in the Export area below.');
        }
        function updBtnCount(count) {
            presetData.system.buttonCount = count;
            for (var p = 0; p < presetData.presets.length; p++) {
                var btns = presetData.presets[p].buttons;
                while (btns.length < count) btns.push(createDefaultButton(btns.length));
                while (btns.length > count) btns.pop();
            }
            if (selectedBtn >= count) selectedBtn = count - 1;
            render();
        }
        function createDefaultButton(idx) {
            var colors = ['#ff6b6b', '#feca57', '#48dbfb', '#1dd1a1', '#5f27cd', '#ff9ff3', '#54a0ff', '#00d2d3'];
            var c = colors[idx % colors.length];
            return {
                name: 'BTN' + (idx + 1), ledMode: 'MOMENTARY', inSelectionGroup: false,
                messages: [{ action: 'PRESS', type: 'CC', channel: 1, data1: 20 + idx, data2: 127, rgb: c }]
            };
        }

        function exportJSON() { document.getElementById('jsonArea').value = JSON.stringify(presetData, null, 2); }
        function importJSON() { try { var data = JSON.parse(document.getElementById('jsonArea').value); if (data.presets) { presetData = data; selectedBtn = 0; showSystem = false; render(); alert('Imported!'); } else alert('Invalid format'); } catch (e) { alert('Error: ' + e.message); } }
        function copyJSON() { exportJSON(); navigator.clipboard.writeText(document.getElementById('jsonArea').value); alert('Copied!'); }
        function downloadJSON() { exportJSON(); var blob = new Blob([document.getElementById('jsonArea').value], { type: 'application/json' }); var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'chocotone_config.json'; a.click(); }

        // ===============================================================
        // WEB SERIAL API - USB Connection to Chocotone
        // ===============================================================
        var serialPort = null;
        var serialReader = null;
        var serialWriter = null;
        var serialBuffer = '';

        async function connectUSB() {
            if (!('serial' in navigator)) {
                alert('Web Serial not supported. Use Chrome or Edge.');
                return;
            }
            try {
                serialPort = await navigator.serial.requestPort();
                await serialPort.open({ baudRate: 115200 });
                serialWriter = serialPort.writable.getWriter();
                serialReader = serialPort.readable.getReader();
                document.getElementById('usbStatus').textContent = 'Connected';
                document.getElementById('usbStatus').style.color = '#22c55e';
                document.getElementById('btnConnect').textContent = 'Disconnect';
                // Start reading
                readSerial();
            } catch (e) {
                console.error('Serial error:', e);
                alert('Connection failed: ' + e.message);
            }
        }

        async function disconnectUSB() {
            if (serialReader) { await serialReader.cancel(); serialReader = null; }
            if (serialWriter) { await serialWriter.close(); serialWriter = null; }
            if (serialPort) { await serialPort.close(); serialPort = null; }
            document.getElementById('usbStatus').textContent = 'Not connected';
            document.getElementById('usbStatus').style.color = '#71717a';
            document.getElementById('btnConnect').textContent = 'Connect USB';
        }

        function toggleUSB() {
            if (serialPort) disconnectUSB();
            else connectUSB();
        }

        async function readSerial() {
            while (serialPort && serialReader) {
                try {
                    const { value, done } = await serialReader.read();
                    if (done) break;
                    serialBuffer += new TextDecoder().decode(value);
                    processSerialData();
                } catch (e) { break; }
            }
        }

        var expectingConfig = false;
        var configJson = '';

        function processSerialData() {
            var lines = serialBuffer.split('\n');
            serialBuffer = lines.pop(); // Keep incomplete line
            for (var line of lines) {
                line = line.trim();
                if (line === 'CONFIG_START') {
                    expectingConfig = true;
                    configJson = '';
                } else if (line === 'CONFIG_END') {
                    expectingConfig = false;
                    try {
                        var data = JSON.parse(configJson);
                        console.log('Received config:', data);
                        if (data.presets) {
                            // Merge with existing structure to preserve required fields
                            presetData.presets = data.presets;
                            if (data.system) {
                                // Merge system properties
                                if (data.system.bleDeviceName) presetData.system.bleDeviceName = data.system.bleDeviceName;
                                if (data.system.apSSID) presetData.system.apSSID = data.system.apSSID;
                                if (data.system.apPassword) presetData.system.apPassword = data.system.apPassword;
                                if (data.system.buttonCount) presetData.system.buttonCount = data.system.buttonCount;
                                if (data.system.ledPin) presetData.system.ledPin = data.system.ledPin;
                                if (data.system.ledsPerButton) presetData.system.ledsPerButton = data.system.ledsPerButton;
                                if (data.system.brightness) presetData.system.brightness = data.system.brightness;
                            }
                            presetData.currentPreset = data.currentPreset || 0;
                            selectedBtn = 0;
                            showSystem = false;
                            render();
                            alert('Config loaded from device!');
                        } else {
                            alert('Invalid config: no presets found');
                        }
                    } catch (e) {
                        console.error('Parse error:', e, 'JSON:', configJson);
                        alert('Parse error: ' + e.message);
                    }
                } else if (expectingConfig) {
                    configJson += line;
                }
            }
        }

        async function readFromDevice() {
            if (!serialWriter) { alert('Connect USB first'); return; }
            await serialWriter.write(new TextEncoder().encode('GET_CONFIG\n'));
        }

        async function sendToDevice() {
            if (!serialWriter) { alert('Connect USB first'); return; }
            var json = JSON.stringify(presetData);
            var CHUNK_SIZE = 500; // Send in 500-byte chunks

            try {
                // Start upload
                await serialWriter.write(new TextEncoder().encode('SET_CONFIG_START\n'));
                await sleep(100);

                // Send chunks
                for (var i = 0; i < json.length; i += CHUNK_SIZE) {
                    var chunk = json.substring(i, i + CHUNK_SIZE);
                    await serialWriter.write(new TextEncoder().encode('SET_CONFIG_CHUNK:' + chunk + '\n'));
                    await sleep(50); // Small delay between chunks
                }

                // End upload
                await serialWriter.write(new TextEncoder().encode('SET_CONFIG_END\n'));
                alert('Config sent to device! Check serial monitor for status.');
            } catch (e) {
                alert('Send error: ' + e.message);
            }
        }

        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        // Add USB section to render
        var origRender = render;
        render = function () {
            origRender();
            // Add USB section after header - use actual connection state
            var app = document.getElementById('app');
            var isConnected = serialPort !== null;
            var statusText = isConnected ? 'Connected' : 'Not connected';
            var statusColor = isConnected ? '#22c55e' : '#71717a';
            var btnText = isConnected ? 'Disconnect' : 'Connect USB';

            var usbHtml = '<div class="section" style="background:#1a1a2e;border:1px solid #7c3aed">';
            usbHtml += '<div class="section-title" style="color:#a78bfa">USB Serial Connection</div>';
            usbHtml += '<div class="row" style="align-items:center">';
            usbHtml += '<button id="btnConnect" class="btn" onclick="toggleUSB()" style="background:#7c3aed">' + btnText + '</button>';
            usbHtml += '<span style="color:#71717a">Status: <span id="usbStatus" style="color:' + statusColor + '">' + statusText + '</span></span>';
            usbHtml += '</div>';
            usbHtml += '<div class="actions" style="margin-top:10px">';
            usbHtml += '<button class="btn success" onclick="readFromDevice()">Read from Device</button>';
            usbHtml += '<button class="btn warning" onclick="sendToDevice()">Send to Device</button>';
            usbHtml += '</div>';
            usbHtml += '<div style="margin-top:8px;font-size:0.75rem;color:#71717a">Requires Chrome/Edge. Read and Send work via USB serial.</div>';
            usbHtml += '</div>';
            app.insertAdjacentHTML('afterbegin', usbHtml);
        };

        render();
    </script>
</body>

</html>