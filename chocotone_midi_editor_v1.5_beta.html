<!DOCTYPE html>
<html>

<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width,initial-scale=1'>
    <title>Chocotone MIDI Editor v1.5 Redesign</title>
    <style>
        /* Import Montserrat Font */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');

        :root {
            --bg: #000000;
            --card: #111111;
            --card-hover: #1a1a1a;
            --text: #e5fff2;
            --text-dim: #8ffdff;
            --acc: #8c81df;
            --acc-dim: #6b62b0;
            --inp: #1a1a1a;
            --brd: #333333;
            --success: #22c55e;
            --warning: #8c81df;
            --danger: #ef4444;
            --radius: 10px;
            --cyan: #8ffdff;
            --mint: #e5fff2;
            --orange: #8c81df;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header / Logo */
        .header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--brd);
        }

        .logo-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 42px;
            font-weight: 900;
            letter-spacing: -4px;
            text-transform: uppercase;
            margin: 0;
            line-height: 1;
        }

        .logo-part-1 {
            color: var(--mint);
        }

        .logo-part-2 {
            color: var(--orange);
        }

        .logo-subline {
            font-family: 'Montserrat', sans-serif;
            color: var(--cyan);
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 3px;
            margin-top: 6px;
        }

        /* Two-Column Desktop Layout */
        .two-col-layout {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .col-left,
        .col-right {
            flex: 1;
            min-width: 0;
        }

        @media (min-width: 1024px) {
            .two-col-layout {
                flex-direction: row;
                gap: 12px;
            }

            .col-left,
            .col-right {
                flex: 0 0 calc(50% - 6px);
                width: calc(50% - 6px);
                min-width: 280px;
            }
        }

        /* Wide Desktop 16:9 optimization */
        @media (min-width: 1400px) {
            body {
                max-width: 1400px;
                padding: 30px 50px;
            }
        }

        /* Connection Cards */
        .conn-card-usb {
            border-color: var(--orange) !important;
        }

        .conn-card-ble {
            border-color: var(--cyan) !important;
        }

        /* Section Cards */
        .section {
            background: var(--card);
            border-radius: var(--radius);
            border: 1px solid var(--brd);
            padding: 16px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--acc);
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Row layouts - CSS Grid */
        .row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            align-items: start;
            margin-bottom: 10px;
        }

        /* Form Fields */
        .field {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .field label {
            min-width: 32px;
            font-size: 0.8rem;
            color: var(--text-dim);
            flex-shrink: 0;
        }

        /* Inputs */
        .field input,
        .field select {
            width: 100%;
            min-width: 0;
            background: var(--inp);
            border: 1px solid var(--brd);
            color: var(--text);
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            outline: none;
            transition: border 0.1s;
        }

        .field input:focus,
        .field select:focus {
            border-color: var(--acc);
        }

        .field input[type="color"] {
            height: 34px;
            padding: 2px;
            cursor: pointer;
        }

        .field input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex: none;
        }

        .field input[type="range"] {
            padding: 0;
            height: 6px;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            background: var(--brd);
            border-radius: 3px;
            border: none;
        }

        .field input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--acc);
            cursor: pointer;
        }

        .field input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--acc);
            cursor: pointer;
            border: none;
        }

        .field.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        /* Button Quick Menu - 2 rows layout */
        .btn-grid {
            display: grid;
            gap: 8px;
            margin-bottom: 8px;
        }

        .btn-tile {
            background: var(--inp);
            border: 2px solid var(--brd);
            border-radius: 8px;
            padding: 12px 14px;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s;
            overflow: hidden;
            display: flex;
            align-items: center;
            /* Desktop: vertically center contents */
            justify-content: space-between;
        }

        .btn-tile:hover {
            background: var(--card-hover);
            border-color: var(--acc-dim);
        }

        .btn-tile.active {
            border-color: var(--acc);
            background: var(--card-hover);
        }

        .btn-tile .num {
            font-size: 0.9rem;
            /* Small Number (Base) */
            font-weight: bold;
            color: var(--text-dim);
        }

        .btn-tile .name {
            font-size: 1.2rem;
            /* Big Label (Base) */
            font-weight: 600;
            margin: 2px 0;
            white-space: normal;
            /* Wrap text */
            line-height: 1.1;
        }

        .btn-tile .info {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .btn-tile .color-dot {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid #fff3;
            flex-shrink: 0;
            margin-left: 8px;
            /* Desktop: vertically centered by parent's align-items: center */
        }

        /* System Tile - Full width, outside cards */
        .sys-tile-wrap {
            margin: 16px 0;
        }

        .sys-tile {
            background: var(--card);
            border: 1px solid var(--brd);
            border-radius: var(--radius);
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }

        .sys-tile:hover {
            border-color: var(--acc);
            background: var(--card-hover);
        }

        .sys-tile.active {
            border-color: var(--acc);
            background: linear-gradient(135deg, var(--acc-dim), var(--acc));
        }

        .sys-tile .icon {
            font-size: 1.2rem;
        }

        .sys-tile .label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #fff;
        }

        /* Message Box */
        .msg-box {
            background: var(--inp);
            border: 1px solid var(--brd);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
        }

        .msg-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--acc);
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--brd);
            padding-bottom: 6px;
        }

        /* Delete button */
        .msg-box .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            z-index: 10;
        }

        .msg-box .remove-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* Action Buttons */
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn.primary {
            background: var(--acc);
            color: #fff;
        }

        .btn.primary:hover {
            background: var(--acc-dim);
        }

        .btn.secondary {
            background: var(--inp);
            color: var(--text);
            border: 1px solid var(--brd);
        }

        .btn.success {
            background: var(--success);
            color: #fff;
        }

        .btn.warning {
            background: var(--warning);
            color: #000;
        }

        .btn.sm {
            padding: 4px 10px;
            font-size: 0.75rem;
        }

        /* JSON Area */
        .json-area {
            width: 100%;
            height: 120px;
            background: var(--inp);
            border: 1px solid var(--brd);
            color: var(--text);
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.8rem;
            resize: vertical;
        }

        /* Responsive - Mobile */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .row {
                grid-template-columns: 1fr;
            }

            .logo-text {
                font-size: 32px;
            }

            .logo-subline {
                font-size: 11px;
                letter-spacing: 2px;
            }
        }

        /* Desktop - wider layout */
        @media (min-width: 1024px) {
            body {
                padding: 30px 40px;
            }

            .desktop-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }

            .row {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
    <style>
        /* Mobile Layout Refinements */
        @media (max-width: 600px) {
            .btn-tile {
                padding: 10px 12px;
                align-items: flex-start;
                /* Mobile: align to top */
            }

            .btn-tile .color-dot {
                width: 16px;
                height: 16px;
                margin-top: -4px;
                /* Pull closer to top edge */
                margin-right: -6px;
                /* Pull closer to right edge */
                align-self: flex-start;
                /* Mobile: top-right aligned */
            }
        }
    </style>
    <script src="web_tools/devices_database.js"></script>
</head>

<body>
    <div class="header">
        <h1 class="logo-text">
            <span class="logo-part-1">CHOCO</span><span class="logo-part-2">TONE</span>
        </h1>
        <div class="logo-subline">OPEN MIDI CONTROLLER</div>
        <div style="font-size:14px;color:#8c81df;margin-top:5px;font-weight:bold">Editor v1.5 Beta</div>
    </div>

    <div id="app"></div>

    <script>
        // ===============================================================
        // STATE
        // ===============================================================
        var selectedBtn = 0;
        var selectedAnalogInput = -1;  // -1 = none selected
        var showSystem = false;
        var showOledConfigPanel = false; // OLED config panel toggle state

        // --- NEW OLED OVERLAY STATE ---
        var oledOverlayState = {
            active: false,
            label: '',
            timer: null
        };

        // Helper to log to on-screen serial monitor
        function logDebug(msg) {
            var el = document.getElementById('serialLog');
            if (el) el.value = Date.now() + ': ' + msg + '\n' + el.value;
            console.log(msg);
        }

        // Trigger OLED Overlay (State-Driven)
        function triggerOledOverlay(label) {
            logDebug('triggerOledOverlay: ' + label);

            // 1. Update State
            oledOverlayState.active = true;
            oledOverlayState.label = label;

            // 2. Clear existing timer
            if (oledOverlayState.timer) clearTimeout(oledOverlayState.timer);

            // 3. Set expiry timer
            oledOverlayState.timer = setTimeout(function () {
                logDebug('Overlay expired');
                oledOverlayState.active = false;
                renderOledPreview(); // Redraw main screen
            }, 1000); // 1 second
        }

        // Toggle OLED config panel visibility
        function toggleOledConfig() {
            showOledConfigPanel = !showOledConfigPanel;
            var panel = document.getElementById('oledConfigPanel');
            if (panel) panel.style.display = showOledConfigPanel ? 'block' : 'none';
        }

        // Select button and show overlay
        function selBtn(idx) {
            selectedBtn = idx;
            selectedAnalogInput = -1;
            showSystem = false;
            var preset = presetData.presets[presetData.currentPreset];
            var btn = preset && preset.buttons && preset.buttons[idx];

            // Update overlay state immediately
            if (btn) {
                triggerOledOverlay(btn.name);
            } else {
                logDebug('selBtn FAILED: idx=' + idx + ' currentPreset=' + presetData.currentPreset + ' preset=' + (preset ? 'OK' : 'NULL') + ' btn=NULL');
                console.log('presetData:', presetData);
            }

            render(); // Rebuild DOM (auto-refresh will pick up state)
        }

        // Select analog input and show overlay
        function selAnalog(idx) {
            selectedAnalogInput = idx;
            selectedBtn = -1;
            showSystem = false;
            var ainp = presetData.analogInputs && presetData.analogInputs[idx];

            // Update overlay state immediately
            var label = ainp ? ainp.name || 'A' + (idx + 1) : 'A' + (idx + 1);
            triggerOledOverlay(label);

            render(); // Rebuild DOM (auto-refresh will pick up state)
        }

        // Change preset count (1-4)
        function chgPresetCount(count) {
            count = Math.max(1, Math.min(4, count));
            presetData.presetCount = count;
            // Ensure we have enough presets in the array
            while (presetData.presets.length < count) {
                var newIdx = presetData.presets.length;
                presetData.presets.push({
                    name: "Preset " + (newIdx + 1),
                    presetLedMode: "NORMAL",
                    syncMode: "NONE",
                    buttons: []
                });
                // Fill buttons for new preset
                var btnCount = presetData.system.buttonCount || 8;
                for (var b = 0; b < btnCount; b++) {
                    presetData.presets[newIdx].buttons.push(createDefaultButton(b));
                }
            }
            // Clamp currentPreset if beyond count
            if (presetData.currentPreset >= count) {
                presetData.currentPreset = count - 1;
            }
            render();
        }

        var actionTypes = ['NO_ACTION', 'PRESS', '2ND_PRESS', 'RELEASE', '2ND_RELEASE', 'LONG_PRESS', '2ND_LONG_PRESS', 'DOUBLE_TAP', 'COMBO'];

        // v1.5.1: Categorized command types for grouped dropdown
        var MIDI_COMMANDS = ['OFF', 'NOTE_MOMENTARY', 'NOTE_ON', 'NOTE_OFF', 'CC', 'PC', 'SYSEX', 'SYSEX_SCROLL'];
        var INTERNAL_COMMANDS = ['TAP_TEMPO', 'PRESET_UP', 'PRESET_DOWN', 'PRESET_1', 'PRESET_2', 'PRESET_3', 'PRESET_4', 'CLEAR_BLE_BONDS', 'WIFI_TOGGLE', 'MENU_TOGGLE', 'MENU_UP', 'MENU_DOWN', 'MENU_ENTER'];
        var midiTypes = MIDI_COMMANDS.concat(INTERNAL_COMMANDS); // Combined for backward compatibility
        var analogActionTypes = ['linear_linear', 'log_linear', 'linear_log', 'joystick'];
        var analogActionLabels = {
            'linear_linear': 'Linear â†’ Linear',
            'log_linear': 'Log â†’ Linear',
            'linear_log': 'Linear â†’ Log',
            'joystick': 'Joystick (Centered)'
        };

        // ===============================================================
        // DATA
        // ===============================================================
        var presetData = {
            configName: "globalactions2",
            lastModified: "2026-01-21 06:56:04",
            presets: [
                {
                    name: "STOMP", presetLedMode: "NORMAL", syncMode: "SPM", buttons: [
                        { name: "NR", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 43, data2: 127, rgb: "#ffffff" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 43, data2: 0, rgb: "#ffffff" }] },
                        { name: "FX1", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 44, data2: 127, rgb: "#3f67ff" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 44, data2: 0, rgb: "#3f67ff" }] },
                        { name: "DRV", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 45, data2: 127, rgb: "#fc2c00" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 45, data2: 0, rgb: "#ff0000" }] },
                        { name: "TAP", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "TAP_TEMPO", channel: 1, data1: 13, data2: 127, rhythmPrev: 0, rhythmNext: 4, tapLock: 7, rgb: "#ffffff" }] },
                        { name: "EQ", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 48, data2: 127, rgb: "#0af500" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 48, data2: 0, rgb: "#0af500" }] },
                        { name: "FX2", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 49, data2: 127, rgb: "#11f3ff" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 49, data2: 0, rgb: "#11f3ff" }] },
                        { name: "DLY", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 50, data2: 127, rgb: "#332aff" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 50, data2: 0, rgb: "#332aff" }] },
                        { name: "RVB", ledMode: "TOGGLE", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 51, data2: 127, rgb: "#8400f7" }, { action: "2ND_PRESS", type: "CC", channel: 1, data1: 51, data2: 0, rgb: "#8400f7" }] }
                    ]
                },
                {
                    name: "BANKS 1-8", presetLedMode: "SELECTION", buttons: [
                        { name: "B1", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 1, rgb: "#ffffff" }] },
                        { name: "B2", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 2, rgb: "#ffffff" }] },
                        { name: "B3", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 3, rgb: "#ffffff" }] },
                        { name: "B4", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 4, rgb: "#ffffff" }] },
                        { name: "B5", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 5, rgb: "#0af500" }] },
                        { name: "B6", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 6, rgb: "#0af500" }] },
                        { name: "B7", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 7, rgb: "#0af500" }, { action: "COMBO", partner: 7, type: "WIFI_TOGGLE" }] },
                        { name: "B8", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 8, rgb: "#0af500" }] }
                    ]
                },
                {
                    name: "BANKS 9-16", presetLedMode: "SELECTION", buttons: [
                        { name: "B9", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 9, rgb: "#11f3ff" }] },
                        { name: "B10", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 10, rgb: "#11f3ff" }] },
                        { name: "B11", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 11, rgb: "#11f3ff" }] },
                        { name: "B12", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 12, rgb: "#11f3ff" }] },
                        { name: "B13", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 13, rgb: "#aa00ff" }] },
                        { name: "B14", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 14, rgb: "#aa00ff" }] },
                        { name: "B15", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 15, rgb: "#aa00ff" }, { action: "COMBO", partner: 7, type: "WIFI_TOGGLE" }] },
                        { name: "B16", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 16, rgb: "#aa00ff" }] }
                    ]
                },
                {
                    name: "Note", presetLedMode: "SELECTION", buttons: [
                        { name: "1st", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 40, rgb: "#fd0000" }] },
                        { name: "2nd", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 41, rgb: "#fd0000" }] },
                        { name: "3rd", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 42, rgb: "#fd0000" }] },
                        { name: "4th", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 43, rgb: "#fd0000" }] },
                        { name: "5th", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 44, rgb: "#fd0000" }] },
                        { name: "6th", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 45, rgb: "#fd0000" }] },
                        { name: "7th", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 46, rgb: "#fd0000" }] },
                        { name: "8up", ledMode: "MOMENTARY", inSelectionGroup: false, messages: [{ action: "PRESS", type: "CC", channel: 1, data1: 1, data2: 47, rgb: "#fd0000" }] }
                    ]
                }
            ],
            currentPreset: 3,
            presetCount: 4,  // Number of active presets (1-8)
            system: {
                bleDeviceName: "CHOCOTONE",
                apSSID: "CHOCOTONE",
                apPassword: "12345678",
                buttonCount: 8,
                buttonPins: "14,27,26,25,33,32,16,17",
                ledPin: 5,
                ledsPerButton: 1,
                ledMap: "0,1,2,3,7,6,5,4,8,9",
                encoderA: 18,
                encoderB: 19,
                encoderBtn: 23,
                bleMode: "CLIENT",
                brightness: 220,
                brightnessDim: 20,
                // Analog Input System (v1.5)
                analogInputCount: 0,
                fsrThreshold: 100, // Default for FSR input mode
                debugAnalogIn: false, // Show raw ADC values on OLED
                batteryAdcPin: 34, // v1.5: ADC pin for battery voltage
                multiplexer: {
                    enabled: false,
                    type: "cd74hc4067",
                    signalPin: 34,
                    selectPins: [26, 27, 14, 12],
                    useFor: "analog"
                },
                // OLED Display Configuration (v1.5)
                oled: {
                    type: "128x64",
                    rotation: 0,
                    // Display pins (v1.5.2)
                    sdaPin: 21,
                    sclPin: 22,
                    csPin: 15,
                    dcPin: 2,
                    rstPin: 4,
                    mosiPin: 23,
                    sclkPin: 18,
                    ledPin: 32,
                    screens: {
                        main: {
                            labelSize: 1,
                            titleSize: 2,
                            statusSize: 1,
                            bpmSize: 1,
                            topRowY: 0,
                            titleY: 14,
                            statusY: 44,
                            bpmY: 32,
                            bottomRowY: 56,
                            showBpm: true,
                            showAnalog: false,
                            showStatus: true,
                            showTopRow: true,
                            showBottomRow: true,
                            titleAlign: 1,
                            statusAlign: 1,
                            bpmAlign: 1,
                            topRowMap: "5,6,7,8",
                            bottomRowMap: "1,2,3,4",
                            // TFT Color Strip settings (v1.5.2)
                            showColorStrips: false,
                            colorStripHeight: 4,
                            topRowAlign: 1,
                            bottomRowAlign: 1,
                            // Battery Indicator (v1.5)
                            showBattery: true,
                            batteryX: 103,
                            batteryY: 32,
                            batteryScale: 1
                        },
                        menu: {
                            headerSize: 1,
                            itemSize: 1,
                            headerY: 0,
                            itemStartY: 14
                        },
                        tap: {
                            labelSize: 1,
                            bpmSize: 3,
                            patternSize: 1,
                            labelTopY: 0,
                            bpmY: 16,
                            patternY: 46,
                            labelBottomY: 56
                        },
                        overlay: {
                            textSize: 2
                        }
                    }
                },
                globalSpecialActions: [
                    { enabled: false, partner: -1, type: "OFF", label: "" },
                    { enabled: false, partner: -1, type: "OFF", label: "" },
                    { enabled: false, partner: -1, type: "OFF", label: "" },
                    { enabled: false, partner: -1, type: "OFF", label: "" },
                    { action: "LONG_PRESS", type: "PRESET_DOWN", channel: 1, data1: 0, data2: 0, holdMs: 700, label: "", enabled: true, partner: -1 },
                    { enabled: false, partner: -1, type: "OFF", label: "" },
                    { enabled: false, partner: -1, type: "OFF", label: "" },
                    { action: "LONG_PRESS", type: "PRESET_UP", channel: 1, data1: 0, data2: 0, holdMs: 700, label: "", enabled: true, partner: -1 },
                    { enabled: false, partner: -1, type: "OFF", label: "" },
                    { enabled: false, partner: -1, type: "OFF", label: "" }
                ]
            },
            // Analog Inputs (0-16)
            analogInputs: []
        };

        function fillEmptyPresets() {
            for (let p = 0; p < presetData.presets.length; p++) {
                if (!presetData.presets[p].buttons.length) {
                    var cnt = presetData.system.buttonCount || 8;
                    for (let i = 0; i < cnt; i++) presetData.presets[p].buttons.push(createDefaultButton(i));
                }
            }
        }
        fillEmptyPresets();

        // Normalize config data received from device (remap field names)
        // Firmware uses: color, partner (in combo)
        // Editor uses: rgb, partner
        function normalizeConfigData(data) {
            if (!data || !data.presets) return data;
            for (var p = 0; p < data.presets.length; p++) {
                var preset = data.presets[p];
                if (!preset.buttons) continue;
                for (var b = 0; b < preset.buttons.length; b++) {
                    var btn = preset.buttons[b];
                    if (!btn.messages) continue;
                    for (var m = 0; m < btn.messages.length; m++) {
                        var msg = btn.messages[m];
                        // Remap 'color' to 'rgb'
                        if (msg.color && !msg.rgb) {
                            msg.rgb = msg.color;
                            delete msg.color;
                        }
                        // Ensure defaults for missing fields (supports older configs and stripped exports)
                        if (!msg.action) msg.action = 'PRESS';
                        if (!msg.type) msg.type = 'CC';
                        if (msg.channel === undefined) msg.channel = 1;
                        if (msg.data1 === undefined) msg.data1 = 0;
                        if (msg.data2 === undefined) msg.data2 = 0;
                        if (msg.inMin === undefined) msg.inMin = 0;
                        if (msg.inMax === undefined) msg.inMax = 100;
                        if (msg.min === undefined) msg.min = 0;
                        if (msg.max === undefined) msg.max = 127;
                        if (!msg.rgb) msg.rgb = '#bb86fc';
                        if (msg.label === undefined) msg.label = '';
                        if (msg.partner === undefined) msg.partner = 0;

                        // Restore sysexParam from data1 for SYSEX_SCROLL (v1.5.5)
                        if (msg.type === 'SYSEX_SCROLL' && !msg.sysexParam && msg.data1) {
                            var idToParam = { 1: 'PITCH - HIGH', 2: 'DRV - GAIN' };
                            msg.sysexParam = idToParam[msg.data1] || 'PITCH - HIGH';
                        }
                    }
                }
            }
            if (data.analogInputs) {
                for (var i = 0; i < data.analogInputs.length; i++) {
                    var inp = data.analogInputs[i];
                    if (inp.enabled === undefined) inp.enabled = false;
                    if (!inp.name) inp.name = 'A' + (i + 1);
                    if (inp.inputMode === undefined) inp.inputMode = 0;
                    if (!inp.rgb) inp.rgb = '#f59e0b';
                    if (inp.source === undefined) inp.source = 'gpio';
                    if (inp.messages) {
                        for (var m = 0; m < inp.messages.length; m++) {
                            var amsg = inp.messages[m];
                            if (!amsg.type) amsg.type = 'CC';
                            if (amsg.channel === undefined) amsg.channel = 1;

                            // Restore sysexParam from data1 for SYSEX_SCROLL (v1.5.5)
                            if (amsg.type === 'SYSEX_SCROLL' && !amsg.sysexParam && amsg.data1) {
                                var idToParam = { 1: 'PITCH - HIGH', 2: 'DRV - GAIN' };
                                amsg.sysexParam = idToParam[amsg.data1] || 'PITCH - HIGH';
                            }
                        }
                    }
                }
            }
            // Normalize presetCount (v1.5.2)
            if (data.presetCount === undefined) {
                data.presetCount = data.presets ? data.presets.length : 4;
            }
            // Expand sparse globalSpecialActions array (v1.5.3 optimized export fix)
            // If imported config has sparse array with index fields, expand to full array
            if (data.system && data.system.globalSpecialActions && data.system.globalSpecialActions.length > 0) {
                var sparse = data.system.globalSpecialActions;
                var hasIndexField = sparse.some(function (a) { return a && a.index !== undefined; });
                if (hasIndexField) {
                    // Create full array of 16 elements (max buttons)
                    var full = [];
                    for (var i = 0; i < 16; i++) {
                        full.push({ enabled: false, partner: -1, type: 'OFF', action: 'PRESS', label: '' });
                    }
                    // Place enabled actions at their correct indices
                    for (var i = 0; i < sparse.length; i++) {
                        var act = sparse[i];
                        if (act && act.index !== undefined && act.index >= 0 && act.index < 16) {
                            full[act.index] = act;
                        }
                    }
                    data.system.globalSpecialActions = full;
                }
            }
            // Normalize OLED config (v1.5.2)
            if (data.system && data.system.oled) {
                var oled = data.system.oled;
                // Convert numeric type to string format (including 'none' = 0)
                if (typeof oled.type === 'number') {
                    var typeMap = { 0: 'none', 1: '128x64', 2: '128x32', 3: '128x128', 4: '128x160' };
                    oled.type = typeMap[oled.type] || '128x64';
                }
                // Display pins defaults (v1.5.2)
                if (oled.sdaPin === undefined) oled.sdaPin = 21;
                if (oled.sclPin === undefined) oled.sclPin = 22;
                if (oled.csPin === undefined) oled.csPin = 15;
                if (oled.dcPin === undefined) oled.dcPin = 2;
                if (oled.rstPin === undefined) oled.rstPin = 4;
                if (oled.mosiPin === undefined) oled.mosiPin = 23;
                if (oled.sclkPin === undefined) oled.sclkPin = 18;
                if (oled.ledPin === undefined) oled.ledPin = 32;
                // Ensure screens.main has all required fields with defaults
                if (oled.screens && oled.screens.main) {
                    var m = oled.screens.main;
                    if (m.showColorStrips === undefined) m.showColorStrips = false;
                    if (m.colorStripHeight === undefined) m.colorStripHeight = 4;
                    if (m.topRowAlign === undefined) m.topRowAlign = 1;
                    if (m.bottomRowAlign === undefined) m.bottomRowAlign = 1;
                    if (m.showStatus === undefined) m.showStatus = true;
                    if (m.bpmSize === undefined) m.bpmSize = 1;
                    if (m.bpmY === undefined) m.bpmY = 32;
                    if (m.statusAlign === undefined) m.statusAlign = 0;
                    if (m.titleAlign === undefined) m.titleAlign = 1;
                    if (m.bpmAlign === undefined) m.bpmAlign = 1;
                }
            }
            // Normalize Analog Inputs (v1.5.5) - Reconstruct sparse array from optimized export
            if (data.analogInputs && data.system && data.system.analogInputCount > 0) {
                var sparse = data.analogInputs;
                var count = data.system.analogInputCount;
                var hasIndex = sparse.some(function (inp) { return inp && inp.index !== undefined; });

                if (hasIndex) {
                    var full = [];
                    for (var i = 0; i < count; i++) {
                        full.push({
                            enabled: false,
                            index: i,
                            name: 'A' + (i + 1),
                            source: 'gpio',
                            pin: 0,
                            inputMode: 0,
                            emaAlpha: 0.05,
                            minVal: 0,
                            maxVal: 4095,
                            inverted: false,
                            hysteresis: 3,
                            actionType: 'linear',
                            actionOptions: { curve: 0, center: 2048, deadzone: 50 },
                            rgb: '#f59e0b',
                            ledIndex: -1,
                            messages: []
                        });
                    }
                    for (var i = 0; i < sparse.length; i++) {
                        var inp = sparse[i];
                        if (inp && inp.index !== undefined && inp.index < count) {
                            inp.enabled = true; // If it was exported, it was enabled
                            full[inp.index] = inp;
                        }
                    }
                    data.analogInputs = full;
                }
            }
            return data;
        }


        // ===============================================================
        // OPEN MIDI FUNCTIONS
        // ===============================================================
        function getDeviceSelectOptions() {
            var devices = typeof getDeviceList === 'function' ? getDeviceList() : ['Generic MIDI Device'];
            var current = typeof loadSavedDevice === 'function' ? loadSavedDevice() : 'Sonicake Pocket Master';
            return devices.map(function (d) {
                return '<option value="' + d + '"' + (d === current ? ' selected' : '') + '>' + d + '</option>';
            }).join('');
        }
        function getTemplateSelectOptions() {
            var current = typeof loadSavedDevice === 'function' ? loadSavedDevice() : 'Sonicake Pocket Master';
            var templates = typeof getDeviceTemplates === 'function' ? getDeviceTemplates(current) : {};
            var fullConfigs = typeof getFullConfigList === 'function' ? getFullConfigList() : [];

            var html = '<option value="">-- Select Template --</option>';

            // Full Configurations (load everything)
            if (fullConfigs.length > 0) {
                html += '<optgroup label="[Full Configurations]">';
                for (var i = 0; i < fullConfigs.length; i++) {
                    html += '<option value="FULL:' + fullConfigs[i] + '">' + fullConfigs[i] + '</option>';
                }
                html += '</optgroup>';
            }

            // Device-specific partial templates
            html += '<optgroup label="[Button Layouts: ' + current + ']">';
            for (var name in templates) {
                html += '<option value="' + name + '">' + name + '</option>';
            }
            html += '</optgroup>';

            return html;
        }
        function getCCPickerOptions(selectedVal) {
            if (typeof buildCCSelectOptions === 'function') {
                return buildCCSelectOptions(selectedVal);
            }
            // Fallback: simple 0-127
            var html = '';
            for (var i = 0; i <= 127; i++) {
                html += '<option value="' + i + '"' + (i === selectedVal ? ' selected' : '') + '>CC ' + i + '</option>';
            }
            return html;
        }
        function loadDeviceTemplate() {
            var sel = document.getElementById('tmplSelect');
            if (!sel || !sel.value) return alert('Please select a template');
            var tmplName = sel.value;

            // Check if this is a full configuration
            if (tmplName.startsWith('FULL:')) {
                var configName = tmplName.substring(5);
                var fullConfig = typeof getFullConfig === 'function' ? getFullConfig(configName) : null;
                if (!fullConfig) return alert('Full configuration not found');

                // Load system config
                if (fullConfig.system) {
                    for (var key in fullConfig.system) {
                        presetData.system[key] = fullConfig.system[key];
                    }
                }

                // Load all presets
                if (fullConfig.presets) {
                    for (var p = 0; p < fullConfig.presets.length && p < 4; p++) {
                        var srcPreset = fullConfig.presets[p];
                        presetData.presets[p].name = srcPreset.name;
                        presetData.presets[p].presetLedMode = srcPreset.presetLedMode || 'NORMAL';
                        presetData.presets[p].buttons = JSON.parse(JSON.stringify(srcPreset.buttons));
                    }
                }

                selectedBtn = 0;
                render();
                alert('Full configuration "' + configName + '" loaded!\n\nIncludes:\n- System config (10 buttons)\n- All 4 presets');
                return;
            }

            // Regular partial template (only loads buttons for current preset)
            var currentDevice = typeof loadSavedDevice === 'function' ? loadSavedDevice() : 'Sonicake Pocket Master';
            var templates = typeof getDeviceTemplates === 'function' ? getDeviceTemplates(currentDevice) : {};
            var tmpl = templates[tmplName];
            if (!tmpl) return alert('Template not found');

            var p = presetData.currentPreset;
            var count = Math.min(tmpl.length, presetData.system.buttonCount);
            for (var i = 0; i < count; i++) {
                var src = tmpl[i];
                var btn = presetData.presets[p].buttons[i];
                btn.name = src.name;
                btn.messages = [];

                // Check for SysEx template (has sysexOn/sysexOff)
                if (src.sysexOn && src.sysexOff) {
                    // SysEx toggle button - PRESS sends ON, 2ND_PRESS sends OFF
                    btn.messages.push({
                        action: 'PRESS',
                        type: 'SYSEX',
                        channel: 1,
                        data1: 0,
                        data2: 0,
                        rgb: src.color,
                        sysex: src.sysexOn  // Hex string
                    });
                    btn.messages.push({
                        action: '2ND_PRESS',
                        type: 'SYSEX',
                        channel: 1,
                        data1: 0,
                        data2: 0,
                        rgb: src.color,
                        sysex: src.sysexOff  // Hex string
                    });
                    btn.ledMode = 'TOGGLE';
                } else if (src.special) {
                    // Special action (TAP_TEMPO, etc.)
                    var msg1 = { action: 'PRESS', type: src.special, channel: 1, data1: 0, data2: 127, rgb: src.color };
                    btn.messages.push(msg1);
                    btn.ledMode = 'MOMENTARY';
                } else {
                    // Regular CC toggle
                    var msg1 = { action: 'PRESS', type: 'CC', channel: 1, data1: src.cc, data2: (src.d2 !== undefined ? src.d2 : 127), rgb: src.color };
                    btn.messages.push(msg1);
                    btn.messages.push({ action: '2ND_PRESS', type: 'CC', channel: 1, data1: src.cc, data2: 0, rgb: src.color });
                    btn.ledMode = 'TOGGLE';
                }
            }
            render();
            alert('Template "' + tmplName + '" loaded!');
        }
        function changeTargetDevice(d) {
            if (typeof setCurrentDevice === 'function') setCurrentDevice(d);
            render();
        }

        // ===============================================================
        // RENDER UI
        // ===============================================================
        function render() {
            var p = presetData.currentPreset;
            var preset = presetData.presets[p];
            var btn = preset.buttons[selectedBtn];
            var presetMode = preset.presetLedMode || 'NORMAL';
            var showLedMode = (presetMode === 'NORMAL' || presetMode === 'HYBRID');
            var showSelGroup = (presetMode === 'HYBRID');
            var html = '';

            // Start two-column layout wrapper
            html += '<div class="two-col-layout">';

            // ========== LEFT COLUMN ==========
            html += '<div class="col-left">';

            // --- CONFIG PROFILE -------------------------------------------
            html += '<div class="section">';
            html += '<div class="section-title">ðŸ“‹ Config Profile</div>';
            html += '<div class="row">';
            html += '<div class="field" style="flex:2"><label>Name</label><input type="text" value="' + (presetData.configName || 'My Config') + '" maxlength="40" onchange="presetData.configName=this.value"></div>';
            html += '<div class="field" style="flex:1"><label>Modified</label><input type="text" value="' + (presetData.lastModified || 'Not saved') + '" readonly style="opacity:0.7;cursor:not-allowed"></div>';
            html += '<input type="file" id="fileInput" accept=".json" style="display:none" onchange="openFile(this)">';
            html += '<div class="field" style="max-width:220px;align-self:flex-end;display:flex;gap:6px">';
            html += '<button class="btn" style="background:#8b5cf6;color:#fff;flex:1" onclick="document.getElementById(\'fileInput\').click()">ðŸ“‚ Open</button>';
            html += '<button class="btn" style="background:#8b5cf6;color:#fff;flex:1" onclick="downloadJSON()">ðŸ’¾ Download</button>';
            html += '</div>';
            html += '<div class="field" style="max-width:80px;align-self:flex-end"><button class="btn" style="background:linear-gradient(135deg,#22c55e,#16a34a);width:100%;font-weight:bold" onclick="saveChanges()">ðŸ’¾ Save</button></div>';
            html += '</div>';
            // Config size indicator
            var exportData = prepareExportData();
            var sizeBytes = JSON.stringify(exportData).length;
            var sizeKB = (sizeBytes / 1024).toFixed(1);
            var maxKB = 16;
            var pct = Math.min(100, Math.round((sizeBytes / (maxKB * 1024)) * 100));
            var sizeColor = pct < 70 ? '#22c55e' : pct < 90 ? '#f59e0b' : '#ef4444';
            html += '<div class="row" style="margin-top:8px;align-items:center;gap:10px">';
            html += '<span style="font-size:12px;color:#94a3b8">ðŸ“¦ Config Size:</span>';
            html += '<div style="flex:1;height:8px;background:#334155;border-radius:4px;overflow:hidden">';
            html += '<div style="width:' + pct + '%;height:100%;background:' + sizeColor + ';transition:width 0.3s"></div>';
            html += '</div>';
            html += '<span style="font-size:12px;color:' + sizeColor + ';font-weight:bold">' + sizeKB + ' KB / ' + maxKB + ' KB</span>';
            html += '</div>';
            html += '</div>';

            // --- PRESET CONFIG -------------------------------------------
            html += '<div class="section">';
            html += '<div class="section-title">Preset Configuration</div>';
            var presetCount = presetData.presetCount || presetData.presets.length;
            html += '<div class="row">';
            html += '<div class="field"><label># Presets</label><input type="number" min="1" max="4" value="' + presetCount + '" onchange="chgPresetCount(parseInt(this.value))"></div>';
            html += '<div class="field"><label>Preset</label><select onchange="chgPreset(this.value)">';
            for (var i = 0; i < presetCount; i++) html += '<option value="' + i + '"' + (i === p ? ' selected' : '') + '>' + (presetData.presets[i] ? presetData.presets[i].name : 'Preset ' + (i + 1)) + '</option>';
            html += '</select></div>';
            html += '<div class="field"><label>Name</label><input type="text" value="' + preset.name + '" maxlength="20" onchange="chgPresetName(this.value)"></div>';
            html += '<div class="field"><label>LED Mode</label><select onchange="chgPresetLedMode(this.value)">';
            html += '<option value="NORMAL"' + (presetMode === 'NORMAL' ? ' selected' : '') + '>Normal</option>';
            html += '<option value="SELECTION"' + (presetMode === 'SELECTION' ? ' selected' : '') + '>Selection</option>';
            html += '<option value="HYBRID"' + (presetMode === 'HYBRID' ? ' selected' : '') + '>Hybrid</option>';
            html += '</select></div>';
            // Sync Mode dropdown
            var syncMode = preset.syncMode || 'NONE';
            html += '<div class="field"><label>Sync</label><select onchange="chgSyncMode(this.value)">';
            html += '<option value="NONE"' + (syncMode === 'NONE' ? ' selected' : '') + '>None</option>';
            html += '<option value="SPM"' + (syncMode === 'SPM' ? ' selected' : '') + '>SPM</option>';
            html += '<option value="GP5"' + (syncMode === 'GP5' ? ' selected' : '') + '>GP-5</option>';
            html += '</select></div>';
            html += '</div></div>';

            // --- DISPLAY PREVIEW CARD (Live Preview) ----------------------------
            html += '<div class="section" id="oledCardSection">';
            var oled = presetData.system.oled || {
                type: '128x64', rotation: 0,
                textSizes: { title: 2, subtitle: 1, label: 1, value: 2 },
                yPositions: { topRow: 0, bottomRow: 56 }
            };
            var showDisplayPreview = oled.type && oled.type !== 'none';
            html += '<div class="section-title">ðŸ–¥ï¸ Display Preview <button class="btn sm secondary" onclick="toggleOledConfig()">âš™ï¸ Config</button></div>';
            if (showDisplayPreview) {
                html += '<div id="oledCanvasWrap" style="display:flex;justify-content:center;padding:10px;background:#222;border-radius:8px;">';
                html += '<canvas id="oledPreview" style="border:2px solid #444;"></canvas>';
                html += '</div>';
            } else {
                html += '<div id="oledCanvasWrap" style="display:flex;justify-content:center;padding:20px;background:#222;border-radius:8px;color:#666;font-style:italic">';
                html += 'No display configured';
                html += '</div>';
            }
            html += '<div id="oledConfigPanel" style="display:' + (showOledConfigPanel ? 'block' : 'none') + ';margin-top:10px;">';

            // Full OLED Config Options
            var ts = oled.textSizes || { title: 2, subtitle: 1, label: 1, value: 2 };
            var yp = oled.yPositions || { topRow: 0, bottomRow: 56 };

            html += '<div class="row">';
            html += '<div class="field"><label>Display Type</label><select onchange="updOled(\'type\',this.value)">';
            html += '<option value="none"' + (oled.type === 'none' ? ' selected' : '') + '>None</option>';
            html += '<option value="128x64"' + (oled.type === '128x64' ? ' selected' : '') + '>128Ã—64 I2C</option>';
            html += '<option value="128x32"' + (oled.type === '128x32' ? ' selected' : '') + '>128Ã—32 I2C</option>';
            html += '<option value="128x128"' + (oled.type === '128x128' ? ' selected' : '') + '>128Ã—128 SPI TFT (1.44")</option>';
            html += '<option value="128x160"' + (oled.type === '128x160' ? ' selected' : '') + '>128Ã—160 SPI TFT (1.8")</option>';
            html += '</select></div>';
            html += '<div class="field"><label>Rotation</label><select onchange="updOled(\'rotation\',parseInt(this.value))">';
            html += '<option value="0"' + (oled.rotation === 0 ? ' selected' : '') + '>0Â°</option>';
            html += '<option value="90"' + (oled.rotation === 90 ? ' selected' : '') + '>90Â°</option>';
            html += '<option value="180"' + (oled.rotation === 180 ? ' selected' : '') + '>180Â°</option>';
            html += '<option value="270"' + (oled.rotation === 270 ? ' selected' : '') + '>270Â°</option>';
            html += '</select></div>';
            html += '<div class="field"><label>Preview Mode</label><select id="oledPreviewMode" onchange="window.oledPreviewMode=this.value; render(); setTimeout(renderOledPreview,50)">';
            html += '<option value="main"' + (window.oledPreviewMode === 'main' || !window.oledPreviewMode ? ' selected' : '') + '>Main Screen</option>';
            html += '<option value="menu"' + (window.oledPreviewMode === 'menu' ? ' selected' : '') + '>Menu Screen</option>';
            html += '<option value="tap"' + (window.oledPreviewMode === 'tap' ? ' selected' : '') + '>Tap Tempo</option>';
            html += '<option value="loading"' + (window.oledPreviewMode === 'loading' ? ' selected' : '') + '>Loading Screen</option>';
            html += '<option value="overlay"' + (window.oledPreviewMode === 'overlay' ? ' selected' : '') + '>Button Overlay</option>';
            html += '</select></div>';
            html += '</div>';

            // Per-Screen Text Size & Y Position Sliders (Mode-Aware)
            html += '<div style="margin-top:10px" id="oledScreenControls">';

            // Get current preview mode (default to 'main')
            var previewMode = 'main';
            var previewModeEl = document.getElementById('oledPreviewMode');
            if (previewModeEl) previewMode = previewModeEl.value;

            // Ensure screens object exists
            var screens = oled.screens || presetData.system.oled.screens;

            if (previewMode === 'main') {
                // MAIN SCREEN controls
                var main = screens.main || { labelSize: 1, titleSize: 2, statusSize: 1, bpmSize: 1, topRowY: 0, titleY: 14, statusY: 44, bpmY: 32, bottomRowY: 56, showBpm: true, showAnalog: false, showStatus: true, showTopRow: true, showBottomRow: true, titleAlign: 1, statusAlign: 0, bpmAlign: 1, topRowMap: '5,6,7,8', bottomRowMap: '1,2,3,4', showColorStrips: false, colorStripHeight: 4, topRowAlign: 0, bottomRowAlign: 0 };
                var isTft128 = (oled.type === '128x128');
                var isTft160 = (oled.type === '128x160');
                var maxY = isTft160 ? 152 : (isTft128 ? 120 : ((oled.type === '128x32') ? 24 : 56));
                var maxTitleY = isTft160 ? 140 : (isTft128 ? 110 : ((oled.type === '128x32') ? 24 : 50));
                var maxStatusY = isTft160 ? 152 : (isTft128 ? 120 : ((oled.type === '128x32') ? 24 : 55));
                html += '<div style="font-size:11px;color:#00d4ff;font-weight:600;margin-bottom:6px">Global Layout</div>';

                // Color Strip Controls (TFT only)
                if (oled.type === '128x128' || oled.type === '128x160') {
                    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;background:#1a2a1a;padding:6px 8px;border-radius:4px;border:1px solid #2a4a2a">';
                    html += '  <input type="checkbox" ' + (main.showColorStrips ? 'checked' : '') + ' onchange="updOledScreen(\'main\',\'showColorStrips\',this.checked)" style="width:14px;height:14px">';
                    html += '  <label style="font-size:10px;color:#8f8">Color Strips</label>';
                    html += '  <span style="font-size:9px;color:#666;margin-left:8px">Thickness:</span>';
                    html += '  <input type="range" min="1" max="10" value="' + (main.colorStripHeight || 4) + '" oninput="updOledScreen(\'main\',\'colorStripHeight\',parseInt(this.value)); this.nextElementSibling.textContent=this.value" style="width:60px">';
                    html += '  <span style="font-size:10px;width:18px;text-align:right;color:#8f8">' + (main.colorStripHeight || 4) + '</span>';
                    html += '</div>';
                }

                // Grid for Top/Bottom Rows
                html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">';

                // Top Row Card
                html += '<div style="background:#252525;padding:8px;border-radius:4px;border:1px solid #333;display:flex;flex-direction:column;gap:6px">';
                html += '  <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #333;padding-bottom:4px;margin-bottom:2px">';
                html += '    <label style="font-size:11px;font-weight:600;color:#ccc">Top Row</label>';
                html += '    <input type="checkbox" ' + (main.showTopRow !== false ? 'checked' : '') + ' onchange="updOledScreen(\'main\',\'showTopRow\',this.checked)" style="width:14px;height:14px">';
                html += '  </div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Pos Y</label><div style="display:flex;align-items:center;gap:4px"><input type="range" min="0" max="' + maxY + '" value="' + (main.topRowY || 0) + '" oninput="updOledScreen(\'main\',\'topRowY\',parseInt(this.value)); this.nextElementSibling.textContent=this.value" style="flex:1"><span style="font-size:10px;width:18px;text-align:right">' + (main.topRowY || 0) + '</span></div></div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Align X</label><select style="font-size:10px;width:100%;background:#111;border:1px solid #444;color:#ddd;padding:2px" onchange="updOledScreen(\'main\',\'topRowAlign\',parseInt(this.value))"><option value="0"' + ((main.topRowAlign || 0) === 0 ? ' selected' : '') + '>Left</option><option value="1"' + ((main.topRowAlign || 0) === 1 ? ' selected' : '') + '>Center</option><option value="2"' + ((main.topRowAlign || 0) === 2 ? ' selected' : '') + '>Right</option></select></div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Map</label><input type="text" style="font-size:10px;width:100%;background:#111;border:1px solid #444;color:#ddd;padding:2px 4px;border-radius:3px" value="' + (main.topRowMap || '5,6,7,8') + '" onchange="updOledScreen(\'main\',\'topRowMap\',this.value)" placeholder="5,6,7,8"></div>';
                html += '</div>';

                // Bottom Row Card
                html += '<div style="background:#252525;padding:8px;border-radius:4px;border:1px solid #333;display:flex;flex-direction:column;gap:6px">';
                html += '  <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #333;padding-bottom:4px;margin-bottom:2px">';
                html += '    <label style="font-size:11px;font-weight:600;color:#ccc">Bottom Row</label>';
                html += '    <input type="checkbox" ' + (main.showBottomRow !== false ? 'checked' : '') + ' onchange="updOledScreen(\'main\',\'showBottomRow\',this.checked)" style="width:14px;height:14px">';
                html += '  </div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Pos Y</label><div style="display:flex;align-items:center;gap:4px"><input type="range" min="0" max="' + maxY + '" value="' + (main.bottomRowY || 56) + '" oninput="updOledScreen(\'main\',\'bottomRowY\',parseInt(this.value)); this.nextElementSibling.textContent=this.value" style="flex:1"><span style="font-size:10px;width:18px;text-align:right">' + (main.bottomRowY || 56) + '</span></div></div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Align X</label><select style="font-size:10px;width:100%;background:#111;border:1px solid #444;color:#ddd;padding:2px" onchange="updOledScreen(\'main\',\'bottomRowAlign\',parseInt(this.value))"><option value="0"' + ((main.bottomRowAlign || 0) === 0 ? ' selected' : '') + '>Left</option><option value="1"' + ((main.bottomRowAlign || 0) === 1 ? ' selected' : '') + '>Center</option><option value="2"' + ((main.bottomRowAlign || 0) === 2 ? ' selected' : '') + '>Right</option></select></div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Map</label><input type="text" style="font-size:10px;width:100%;background:#111;border:1px solid #444;color:#ddd;padding:2px 4px;border-radius:3px" value="' + (main.bottomRowMap || '1,2,3,4') + '" onchange="updOledScreen(\'main\',\'bottomRowMap\',this.value)" placeholder="1,2,3,4"></div>';
                html += '</div>';
                html += '</div>'; // End Global Grid

                // Elements Section
                html += '<div style="font-size:11px;color:#00d4ff;font-weight:600;margin-bottom:6px">Screen Elements</div>';
                html += '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(130px, 1fr));gap:8px;margin-bottom:12px">';

                // Title Card
                html += '<div style="background:#252525;padding:8px;border-radius:4px;border:1px solid #333;display:flex;flex-direction:column;gap:6px">';
                html += '  <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #333;padding-bottom:4px;margin-bottom:2px;min-height:21px">';
                html += '    <label style="font-size:11px;font-weight:600;color:#ccc">Title</label>';
                html += '  </div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Size</label><div style="display:flex;align-items:center;gap:4px"><input type="range" min="1" max="4" value="' + (main.titleSize || 2) + '" oninput="updOledScreen(\'main\',\'titleSize\',parseInt(this.value)); this.nextElementSibling.textContent=this.value" style="flex:1"><span style="font-size:10px;width:18px;text-align:right">' + (main.titleSize || 2) + '</span></div></div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Pos Y</label><div style="display:flex;align-items:center;gap:4px"><input type="range" min="0" max="' + maxTitleY + '" value="' + (main.titleY || 14) + '" oninput="updOledScreen(\'main\',\'titleY\',parseInt(this.value)); this.nextElementSibling.textContent=this.value" style="flex:1"><span style="font-size:10px;width:18px;text-align:right">' + (main.titleY || 14) + '</span></div></div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Align</label><select style="font-size:10px;width:100%;background:#111;border:1px solid #444;color:#ddd;padding:2px" onchange="updOledScreen(\'main\',\'titleAlign\',parseInt(this.value))"><option value="0"' + (main.titleAlign === 0 ? ' selected' : '') + '>Left</option><option value="1"' + (main.titleAlign === 1 || main.titleAlign === undefined ? ' selected' : '') + '>Center</option><option value="2"' + (main.titleAlign === 2 ? ' selected' : '') + '>Right</option></select></div>';
                html += '</div>';

                // BPM Card
                html += '<div style="background:#252525;padding:8px;border-radius:4px;border:1px solid #333;display:flex;flex-direction:column;gap:6px">';
                html += '  <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #333;padding-bottom:4px;margin-bottom:2px">';
                html += '    <label style="font-size:11px;font-weight:600;color:#ccc">BPM</label>';
                html += '    <input type="checkbox" ' + (main.showBpm !== false ? 'checked' : '') + ' onchange="updOledScreen(\'main\',\'showBpm\',this.checked)" style="width:14px;height:14px">';
                html += '  </div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Size</label><div style="display:flex;align-items:center;gap:4px"><input type="range" min="1" max="3" value="' + (main.bpmSize || 1) + '" oninput="updOledScreen(\'main\',\'bpmSize\',parseInt(this.value)); this.nextElementSibling.textContent=this.value" style="flex:1"><span style="font-size:10px;width:18px;text-align:right">' + (main.bpmSize || 1) + '</span></div></div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Pos Y</label><div style="display:flex;align-items:center;gap:4px"><input type="range" min="0" max="' + maxStatusY + '" value="' + (main.bpmY !== undefined ? main.bpmY : 32) + '" oninput="updOledScreen(\'main\',\'bpmY\',parseInt(this.value)); this.nextElementSibling.textContent=this.value" style="flex:1"><span style="font-size:10px;width:18px;text-align:right">' + (main.bpmY !== undefined ? main.bpmY : 32) + '</span></div></div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Align</label><select style="font-size:10px;width:100%;background:#111;border:1px solid #444;color:#ddd;padding:2px" onchange="updOledScreen(\'main\',\'bpmAlign\',parseInt(this.value))"><option value="0"' + (main.bpmAlign === 0 ? ' selected' : '') + '>Left</option><option value="1"' + (main.bpmAlign === 1 || main.bpmAlign === undefined ? ' selected' : '') + '>Center</option><option value="2"' + (main.bpmAlign === 2 ? ' selected' : '') + '>Right</option></select></div>';
                html += '</div>';

                // Status Card
                html += '<div style="background:#252525;padding:8px;border-radius:4px;border:1px solid #333;display:flex;flex-direction:column;gap:6px">';
                html += '  <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #333;padding-bottom:4px;margin-bottom:2px">';
                html += '    <label style="font-size:11px;font-weight:600;color:#ccc">Status</label>';
                html += '    <input type="checkbox" ' + (main.showStatus !== false ? 'checked' : '') + ' onchange="updOledScreen(\'main\',\'showStatus\',this.checked)" style="width:14px;height:14px">';
                html += '  </div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Size</label><div style="display:flex;align-items:center;gap:4px"><input type="range" min="1" max="3" value="' + (main.statusSize || 1) + '" oninput="updOledScreen(\'main\',\'statusSize\',parseInt(this.value)); this.nextElementSibling.textContent=this.value" style="flex:1"><span style="font-size:10px;width:18px;text-align:right">' + (main.statusSize || 1) + '</span></div></div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Pos Y</label><div style="display:flex;align-items:center;gap:4px"><input type="range" min="0" max="' + maxStatusY + '" value="' + (main.statusY || 44) + '" oninput="updOledScreen(\'main\',\'statusY\',parseInt(this.value)); this.nextElementSibling.textContent=this.value" style="flex:1"><span style="font-size:10px;width:18px;text-align:right">' + (main.statusY || 44) + '</span></div></div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Align</label><select style="font-size:10px;width:100%;background:#111;border:1px solid #444;color:#ddd;padding:2px" onchange="updOledScreen(\'main\',\'statusAlign\',parseInt(this.value))"><option value="0"' + (main.statusAlign === 0 || main.statusAlign === undefined ? ' selected' : '') + '>Left</option><option value="1"' + (main.statusAlign === 1 ? ' selected' : '') + '>Center</option><option value="2"' + (main.statusAlign === 2 ? ' selected' : '') + '>Right</option></select></div>';
                html += '</div>';

                // Battery Icon Card (v1.5)
                html += '<div style="background:#252525;padding:8px;border-radius:4px;border:1px solid #22c55e;display:flex;flex-direction:column;gap:6px">';
                html += '  <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #333;padding-bottom:4px;margin-bottom:2px">';
                html += '    <label style="font-size:11px;font-weight:600;color:#22c55e">ðŸ”‹ Battery</label>';
                html += '    <input type="checkbox" ' + (main.showBattery === true ? 'checked' : '') + ' onchange="updOledScreen(\'main\',\'showBattery\',this.checked)" style="width:14px;height:14px">';
                html += '  </div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">X Pos</label><div style="display:flex;align-items:center;gap:4px"><input type="range" min="0" max="120" value="' + (main.batteryX !== undefined ? main.batteryX : 116) + '" oninput="updOledScreen(\'main\',\'batteryX\',parseInt(this.value)); this.nextElementSibling.textContent=this.value" style="flex:1"><span style="font-size:10px;width:22px;text-align:right">' + (main.batteryX !== undefined ? main.batteryX : 116) + '</span></div></div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Y Pos</label><div style="display:flex;align-items:center;gap:4px"><input type="range" min="0" max="' + maxStatusY + '" value="' + (main.batteryY !== undefined ? main.batteryY : 0) + '" oninput="updOledScreen(\'main\',\'batteryY\',parseInt(this.value)); this.nextElementSibling.textContent=this.value" style="flex:1"><span style="font-size:10px;width:22px;text-align:right">' + (main.batteryY !== undefined ? main.batteryY : 0) + '</span></div></div>';
                html += '  <div class="field" style="margin:0"><label style="font-size:9px;color:#888">Scale</label><select style="font-size:10px;width:100%;background:#111;border:1px solid #444;color:#ddd;padding:2px" onchange="updOledScreen(\'main\',\'batteryScale\',parseInt(this.value))"><option value="1"' + ((main.batteryScale || 1) === 1 ? ' selected' : '') + '>1x</option><option value="2"' + ((main.batteryScale || 1) === 2 ? ' selected' : '') + '>2x</option><option value="3"' + ((main.batteryScale || 1) === 3 ? ' selected' : '') + '>3x</option></select></div>';
                html += '</div>';

                html += '</div>'; // End Elements Grid
            } else if (previewMode === 'menu') {
                // MENU SCREEN controls
                var menu = screens.menu || { headerSize: 1, itemSize: 1, headerY: 0, itemStartY: 14 };
                html += '<div style="font-size:11px;color:#00d4ff;font-weight:600;margin-bottom:6px">Menu Screen Settings</div>';
                html += '<div class="row" style="margin-bottom:4px">';
                html += '<div class="field"><label style="font-size:10px">Header Size</label><input type="range" min="1" max="3" value="' + (menu.headerSize || 1) + '" oninput="updOledScreen(\'menu\',\'headerSize\',parseInt(this.value)); this.nextElementSibling.textContent=this.value"><span style="font-size:10px;width:16px">' + (menu.headerSize || 1) + '</span></div>';
                html += '<div class="field"><label style="font-size:10px">Item Size</label><input type="range" min="1" max="3" value="' + (menu.itemSize || 1) + '" oninput="updOledScreen(\'menu\',\'itemSize\',parseInt(this.value)); this.nextElementSibling.textContent=this.value"><span style="font-size:10px;width:16px">' + (menu.itemSize || 1) + '</span></div>';
                html += '</div>';
                html += '<div class="row" style="margin-bottom:4px">';
                html += '<div class="field"><label style="font-size:10px">Header Y</label><input type="range" min="0" max="20" value="' + (menu.headerY || 0) + '" oninput="updOledScreen(\'menu\',\'headerY\',parseInt(this.value)); this.nextElementSibling.textContent=this.value"><span style="font-size:10px;width:20px">' + (menu.headerY || 0) + '</span></div>';
                html += '<div class="field"><label style="font-size:10px">Items Y</label><input type="range" min="8" max="40" value="' + (menu.itemStartY || 14) + '" oninput="updOledScreen(\'menu\',\'itemStartY\',parseInt(this.value)); this.nextElementSibling.textContent=this.value"><span style="font-size:10px;width:20px">' + (menu.itemStartY || 14) + '</span></div>';
                html += '</div>';
            } else if (previewMode === 'tap') {
                // TAP TEMPO SCREEN controls
                var tap = screens.tap || { labelSize: 1, bpmSize: 3, patternSize: 1, labelTopY: 0, bpmY: 16, patternY: 46, labelBottomY: 56 };
                html += '<div style="font-size:11px;color:#00d4ff;font-weight:600;margin-bottom:6px">Tap Tempo Screen Settings</div>';
                html += '<div class="row" style="margin-bottom:4px">';
                html += '<div class="field"><label style="font-size:10px">Label Size</label><input type="range" min="1" max="3" value="' + (tap.labelSize || 1) + '" oninput="updOledScreen(\'tap\',\'labelSize\',parseInt(this.value)); this.nextElementSibling.textContent=this.value"><span style="font-size:10px;width:16px">' + (tap.labelSize || 1) + '</span></div>';
                html += '<div class="field"><label style="font-size:10px">BPM Size</label><input type="range" min="1" max="5" value="' + (tap.bpmSize || 3) + '" oninput="updOledScreen(\'tap\',\'bpmSize\',parseInt(this.value)); this.nextElementSibling.textContent=this.value"><span style="font-size:10px;width:16px">' + (tap.bpmSize || 3) + '</span></div>';
                html += '</div>';
                html += '<div class="row" style="margin-bottom:4px">';
                html += '<div class="field"><label style="font-size:10px">Pattern Size</label><input type="range" min="1" max="3" value="' + (tap.patternSize || 1) + '" oninput="updOledScreen(\'tap\',\'patternSize\',parseInt(this.value)); this.nextElementSibling.textContent=this.value"><span style="font-size:10px;width:16px">' + (tap.patternSize || 1) + '</span></div>';
                html += '<div class="field"><label style="font-size:10px">Top Label Y</label><input type="range" min="0" max="20" value="' + (tap.labelTopY || 0) + '" oninput="updOledScreen(\'tap\',\'labelTopY\',parseInt(this.value)); this.nextElementSibling.textContent=this.value"><span style="font-size:10px;width:20px">' + (tap.labelTopY || 0) + '</span></div>';
                html += '</div>';
                html += '<div class="row" style="margin-bottom:4px">';
                html += '<div class="field"><label style="font-size:10px">BPM Y</label><input type="range" min="8" max="40" value="' + (tap.bpmY || 16) + '" oninput="updOledScreen(\'tap\',\'bpmY\',parseInt(this.value)); this.nextElementSibling.textContent=this.value"><span style="font-size:10px;width:20px">' + (tap.bpmY || 16) + '</span></div>';
                html += '<div class="field"><label style="font-size:10px">Pattern Y</label><input type="range" min="20" max="56" value="' + (tap.patternY || 46) + '" oninput="updOledScreen(\'tap\',\'patternY\',parseInt(this.value)); this.nextElementSibling.textContent=this.value"><span style="font-size:10px;width:20px">' + (tap.patternY || 46) + '</span></div>';
                html += '</div>';
                html += '<div class="row" style="margin-bottom:4px">';
                html += '<div class="field"><label style="font-size:10px">Bottom Label Y</label><input type="range" min="40" max="60" value="' + (tap.labelBottomY || 56) + '" oninput="updOledScreen(\'tap\',\'labelBottomY\',parseInt(this.value)); this.nextElementSibling.textContent=this.value"><span style="font-size:10px;width:20px">' + (tap.labelBottomY || 56) + '</span></div>';
                html += '</div>';
            } else if (previewMode === 'overlay') {
                // OVERLAY controls
                var overlay = screens.overlay || { textSize: 2 };
                html += '<div style="font-size:11px;color:#00d4ff;font-weight:600;margin-bottom:6px">Button Overlay Settings</div>';
                html += '<div class="row" style="margin-bottom:4px">';
                html += '<div class="field"><label style="font-size:10px">Text Size</label><input type="range" min="1" max="7" value="' + (overlay.textSize || 2) + '" oninput="updOledScreen(\'overlay\',\'textSize\',parseInt(this.value)); this.nextElementSibling.textContent=this.value"><span style="font-size:10px;width:16px">' + (overlay.textSize || 2) + '</span></div>';
                html += '</div>';
            } else if (previewMode === 'loading') {
                // LOADING - No controls (fixed layout)
                html += '<div style="font-size:11px;color:#888;font-style:italic">Loading screen has a fixed layout.</div>';
            }

            html += '</div>';
            html += '</div>'; // Close oledConfigPanel
            html += '</div>'; // Close oledCardSection


            // --- BUTTONS & CONTROLS (2 ROWS) ----------------------------------------
            html += '<div class="section">';
            html += '<div class="section-title" style="font-size:1.1rem">Buttons & Controls</div>';
            var btnCount = presetData.system.buttonCount || 8;
            var cols = Math.ceil(btnCount / 2); // 2 rows = half columns
            html += '<div class="btn-grid" style="grid-template-columns: repeat(' + cols + ', 1fr)">';
            // Render second half first (top row: 5,6,7,8), then first half (bottom row: 1,2,3,4)
            var half = Math.ceil(btnCount / 2);
            var order = [];
            for (var i = half; i < btnCount; i++) order.push(i); // Top row: indices 4,5,6,7
            for (var i = 0; i < half; i++) order.push(i);        // Bottom row: indices 0,1,2,3
            for (var idx = 0; idx < order.length; idx++) {
                var b = order[idx];
                var bt = preset.buttons[b];
                if (!bt) continue;
                var isActive = (b === selectedBtn && !showSystem);
                var msg1 = (bt.messages && bt.messages[0]) ? bt.messages[0] : { type: 'OFF', data1: 0, rgb: '#555' };

                html += '<div class="btn-tile' + (isActive ? ' active' : '') + '" onclick="selBtn(' + b + ')">';
                html += '<div style="flex:1;min-width:0">';
                html += '<div class="num">#' + (b + 1) + '</div>';
                html += '<div class="name">' + bt.name + '</div>';
                html += '<div class="info">' + msg1.type + ' ' + msg1.data1 + '</div>';
                html += '</div>';
                html += '<div class="color-dot" style="background:' + msg1.rgb + '"></div>';
                html += '</div>';
            }
            html += '</div>';

            // --- ANALOG INPUTS (v1.5 Beta) ---
            var analogCount = presetData.system.analogInputCount || 0;
            if (analogCount > 0) {
                html += '<div style="margin-top:12px;border-top:1px solid #333;padding-top:10px">';
                html += '<div style="font-size:0.8rem;color:#f59e0b;font-weight:600;margin-bottom:8px">ðŸŽšï¸ Analog Inputs</div>';
                html += '<div class="btn-grid" style="grid-template-columns: repeat(' + Math.min(analogCount, 4) + ', 1fr)">';
                for (var ai = 0; ai < analogCount; ai++) {
                    var ainp = presetData.analogInputs[ai] || {};
                    var aiActive = (selectedAnalogInput === ai && !showSystem);
                    var aiColor = ainp.rgb || '#f59e0b';
                    var msg1 = (ainp.messages && ainp.messages[0]) ? ainp.messages[0] : { type: 'OFF', data1: 0 };
                    html += '<div class="btn-tile' + (aiActive ? ' active' : '') + '" style="border-color:' + aiColor + '40" onclick="selAnalog(' + ai + ')">';
                    html += '<div style="flex:1;min-width:0">';
                    html += '<div class="num" style="color:#f59e0b">A' + (ai + 1) + '</div>';
                    html += '<div class="name" style="font-size:0.9rem">' + (ainp.name || 'A' + (ai + 1)) + '</div>';
                    html += '<div class="info">' + (ainp.enabled ? (msg1.type === 'CC' ? 'CC' + msg1.data1 : msg1.type) : 'OFF') + '</div>';
                    html += '</div>';
                    html += '<div class="color-dot" style="background:' + aiColor + '"></div>';
                    html += '</div>';
                }
                html += '</div>';
                html += '</div>';
            }

            html += '</div>'; // Close Buttons & Controls section

            // System Tile
            html += '<div class="sys-tile-wrap">';
            html += '<div class="sys-tile' + (showSystem ? ' active' : '') + '" onclick="toggleSystem()">';
            html += '<span class="label">System Configuration</span>';
            html += '</div></div>';

            html += '</div>'; // Close LEFT COLUMN

            // ========== RIGHT COLUMN ==========
            html += '<div class="col-right">';

            // --- MAIN CONTENT (Button Detail, Analog Detail, Global Actions, or System Config) ------------
            if (showSystem) {
                html += renderSystemConfig();
            } else if (selectedAnalogInput >= 0 && presetData.analogInputs && presetData.analogInputs[selectedAnalogInput]) {
                html += renderAnalogDetail(presetData.analogInputs[selectedAnalogInput], selectedAnalogInput);
            } else if (selectedBtn >= 0) {
                html += renderButtonDetail(btn, selectedBtn, showLedMode, showSelGroup);
            }

            // --- JSON ----------------------------------------------------
            html += '<div class="section">';
            html += '<div class="section-title">Import / Export</div>';
            html += '<textarea class="json-area" id="jsonArea" placeholder="Paste JSON here..."></textarea>';
            html += '<div class="row" style="margin-bottom:10px">';
            html += '<div class="field"><label>Device IP</label><input type="text" id="deviceIp" value="192.168.4.1" style="font-family:monospace;font-size:0.85rem"></div>';
            html += '</div>';
            html += '<div class="actions" style="margin-top:10px">';
            html += '<button class="btn" onclick="exportJSON()" title="Update JSON Area" style="background:#8b5cf6;color:#fff">Update JSON</button>';
            html += '<button class="btn" onclick="importJSON()" title="Load from JSON Area" style="background:#8b5cf6;color:#fff">Load JSON</button>';
            html += '</div>';
            html += '<div class="actions" style="margin-top:10px">';
            html += '<button class="btn" onclick="fetchFromDevice()" style="background:#8b5cf6;color:#fff">Fetch (WiFi)</button>';
            html += '<button class="btn" onclick="pushToDevice()" style="background:#8b5cf6;color:#fff">Push (WiFi)</button>';
            html += '</div></div>';

            html += '</div>'; // Close RIGHT COLUMN

            html += '</div>'; // Close two-col-layout

            html += '<div style="text-align:center;color:#555;font-size:0.7rem;margin-top:10px">Chocotone v1.5 BETA - Analog Input System</div>';
            document.getElementById('app').innerHTML = html;
            // Always render OLED preview (state object decides main vs overlay)
            setTimeout(renderOledPreview, 50);
        }

        function renderButtonDetail(btn, idx, showLedMode, showSelGroup) {
            var html = '<div class="section">';
            html += '<div class="section-title">Button ' + (idx + 1) + ': ' + btn.name + '</div>';

            html += '<div class="row">';
            html += '<div class="field"><label>Label</label><input type="text" value="' + btn.name + '" maxlength="20" onchange="updBtn(\'name\',this.value)"></div>';
            if (showLedMode) {
                html += '<div class="field"><label>LED</label><select onchange="updBtn(\'ledMode\',this.value)">';
                html += '<option value="MOMENTARY"' + (btn.ledMode === 'MOMENTARY' ? ' selected' : '') + '>Momentary</option>';
                html += '<option value="TOGGLE"' + (btn.ledMode === 'TOGGLE' ? ' selected' : '') + '>Toggle</option>';
                html += '</select></div>';
            }
            if (showSelGroup) {
                html += '<div class="field"><label>Sel.Grp</label><input type="checkbox"' + (btn.inSelectionGroup ? ' checked' : '') + ' onchange="updBtn(\'inSelectionGroup\',this.checked)"></div>';
            }
            html += '</div>';

            html += '<div class="section-title" style="margin-top:16px; border-bottom:1px solid #333; padding-bottom:4px">Action List <button class="btn primary sm" style="margin-left:auto" onclick="addMsg()">+</button></div>';

            var msgs = btn.messages || [];
            for (var i = 0; i < msgs.length; i++) html += renderActionCard(msgs[i], i);

            // --- GLOBAL ACTIONS SECTION ---
            var gsa = presetData.system.globalSpecialActions || [];
            var globalAction = gsa[idx] || { enabled: false, partner: -1, type: 'OFF', label: '' };

            html += '<div class="section-title" style="margin-top:20px; border-bottom:1px solid #a78bfa; padding-bottom:4px; color:#a78bfa">';
            html += 'ðŸ”¥ Global Actions';
            html += '<button class="btn sm" style="margin-left:auto;background:' + (globalAction.enabled ? '#a78bfa' : '#3f3f46') + '" onclick="toggleGlobalAction(' + idx + ')">' + (globalAction.enabled ? 'ON' : 'OFF') + '</button>';
            html += '</div>';

            if (globalAction.enabled) {
                html += renderActionCard(globalAction, idx, true);
            } else {
                html += '<div style="color:#666;font-size:11px;padding:10px;text-align:center">Click ON to enable a global combo action for this button</div>';
            }

            // Save Changes Button
            html += '<div class="actions" style="margin-top:16px; justify-content:center">';
            html += '<button class="btn success" onclick="saveChanges()">Save Changes</button>';
            html += '</div>';

            html += '</div>';
            return html;
        }

        function renderActionCard(msg, i, isGlobal) {
            var html = '<div class="msg-box"' + (isGlobal ? ' style="border-color:#a78bfa"' : '') + '>';
            // Header with action number and buttons
            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;border-bottom:1px solid ' + (isGlobal ? '#a78bfa' : '#333') + ';padding-bottom:6px">';
            html += '<span style="font-weight:600;color:' + (isGlobal ? '#a78bfa' : 'var(--acc)') + ';font-size:0.85rem">Action ' + (i + 1) + '</span>';
            html += '<div style="display:flex;gap:6px">';
            html += '<button class="btn sm" style="padding:4px 8px;font-size:0.7rem;background:#3f3f46" onclick="' + (isGlobal ? 'copyGlobalAction' : 'copyAction') + '(' + i + ')" title="Copy">ðŸ“‹</button>';
            html += '<button class="btn sm" style="padding:4px 8px;font-size:0.7rem;background:#3f3f46" onclick="' + (isGlobal ? 'pasteGlobalAction' : 'pasteAction') + '(' + i + ')" title="Paste">ðŸ“„</button>';
            html += '<button class="btn sm" style="padding:4px 8px;font-size:0.7rem;background:#ef4444" onclick="' + (isGlobal ? 'deleteGlobalAction' : 'delMsg') + '(' + i + ')" title="Delete">Ã—</button>';
            html += '</div>';
            html += '</div>';

            // Action Type + Label (for ALL action types)
            var updFn = isGlobal ? 'updGlobalAction' : 'updMsg';
            html += '<div class="field" style="margin-bottom:8px"><label style="font-weight:600;color:' + (isGlobal ? '#a78bfa' : 'var(--acc)') + '">Type</label><select style="font-weight:600" onchange="' + updFn + '(' + i + ',\'action\',this.value)">' + actionOpts(msg.action) + '</select></div>';
            html += '<div class="row" style="margin-bottom:8px">';
            html += '<div class="field"><label>Label</label><input type="text" maxlength="6" value="' + (msg.label || '') + '" placeholder="' + getAutoLabel(msg) + '" onchange="' + updFn + '(' + i + ',\'label\',this.value)"></div>';
            html += '</div>';

            // Conditional fields
            if (msg.action === 'COMBO') {
                html += '<div class="row">';
                html += '<div class="field"><label>Partner</label><select onchange="' + updFn + '(' + i + ',\'partner\',parseInt(this.value))">';
                var cnt = presetData.system.buttonCount;
                var currentBtnIdx = isGlobal ? i : selectedBtn;
                for (let b = 0; b < cnt; b++) {
                    if (b !== currentBtnIdx) html += '<option value="' + b + '"' + (msg.partner === b ? ' selected' : '') + '>BTN ' + (b + 1) + '</option>';
                }
                html += '</select></div>';
                html += '</div>';
            }
            else if (msg.action === 'LONG_PRESS' || msg.action === '2ND_LONG_PRESS') {
                html += '<div class="row">';
                html += '<div class="field"><label>Hold ms</label><input type="number" min="200" max="3000" step="100" value="' + (msg.holdMs || 500) + '" onchange="' + updFn + '(' + i + ',\'holdMs\',parseInt(this.value))"></div>';
                html += '</div>';
            }

            // MIDI Content - Only show for actual MIDI commands
            var isInternalNoFields = ['MENU_TOGGLE', 'MENU_UP', 'MENU_DOWN', 'MENU_ENTER', 'WIFI_TOGGLE', 'CLEAR_BLE_BONDS', 'PRESET_UP', 'PRESET_DOWN', 'PRESET_1', 'PRESET_2', 'PRESET_3', 'PRESET_4'].indexOf(msg.type) >= 0;

            html += '<div class="row">';
            html += '<div class="field"><label>Type</label><select onchange="' + updFn + '(' + i + ',\'type\',this.value)">' + typeOpts(msg.type) + '</select></div>';

            if (!isInternalNoFields) {
                html += '<div class="field"><label>Ch</label><input type="number" min="1" max="16" value="' + (msg.channel || 1) + '" onchange="' + updFn + '(' + i + ',\'channel\',parseInt(this.value))"></div>';
                // D1/D2 hidden for TAP_TEMPO
                if (msg.type !== 'TAP_TEMPO') {
                    // D1 as CC Picker dropdown for CC type
                    if (msg.type === 'CC') {
                        html += '<div class="field"><label>CC</label><select onchange="' + updFn + '(' + i + ',\'data1\',parseInt(this.value))">' + getCCPickerOptions(msg.data1 || 0) + '</select></div>';
                    } else {
                        html += '<div class="field"><label>D1</label><input type="number" min="0" max="127" value="' + (msg.data1 || 0) + '" onchange="' + updFn + '(' + i + ',\'data1\',parseInt(this.value))"></div>';
                    }
                    html += '<div class="field"><label>D2</label><input type="number" min="0" max="127" value="' + (msg.data2 || 0) + '" onchange="' + updFn + '(' + i + ',\'data2\',parseInt(this.value))"></div>';
                }
            }
            html += '<div class="field"><label>RGB</label><input type="color" value="' + (msg.rgb || '#bb86fc') + '" onchange="' + updFn + '(' + i + ',\'rgb\',this.value)"></div>';
            html += '</div>';

            if (msg.type === 'TAP_TEMPO') {
                html += '<div class="row" style="margin-top:8px">';
                html += '<div class="field"><label style="font-size:10px">Rhythm &lt;</label><input type="number" min="1" max="10" value="' + ((msg.rhythmPrev || 0) + 1) + '" onchange="' + updFn + '(' + i + ',\'rhythmPrev\',parseInt(this.value)-1)"></div>';
                html += '<div class="field"><label style="font-size:10px">Rhythm &gt;</label><input type="number" min="1" max="10" value="' + ((msg.rhythmNext || 4) + 1) + '" onchange="' + updFn + '(' + i + ',\'rhythmNext\',parseInt(this.value)-1)"></div>';
                html += '<div class="field"><label style="font-size:10px">Lock Btn</label><input type="number" min="1" max="10" value="' + ((msg.tapLock || 7) + 1) + '" onchange="' + updFn + '(' + i + ',\'tapLock\',parseInt(this.value)-1)"></div>';
                html += '</div>';
            }

            // SysEx hex input field with picker
            if (msg.type === 'SYSEX') {
                var sysexPresetFn = isGlobal ? 'applyGlobalSysexPreset' : 'applySysexPreset';
                html += '<div class="row" style="margin-top:8px">';
                html += '<div class="field" style="flex:1"><label>SysEx Preset</label><select style="font-size:11px" onchange="' + sysexPresetFn + '(' + i + ',this.value)">' + getSysexPickerOptions() + '</select></div>';
                html += '</div>';
                html += '<div class="row" style="margin-top:6px">';
                html += '<div class="field" style="flex:1"><label>SysEx Hex (manual edit)</label><input type="text" style="font-family:monospace;font-size:11px" placeholder="f0...f7" value="' + (msg.sysex || '') + '" onchange="' + updFn + '(' + i + ',\'sysex\',this.value.toLowerCase().replace(/[^0-9a-f]/g,\'\'))"></div>';
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function renderAnalogDetail(inp, idx) {
            var html = '<div class="section" style="border-color:#f59e0b">';
            html += '<div class="section-title" style="color:#f59e0b">ðŸŽšï¸ Analog Input A' + (idx + 1) + ': ' + (inp.name || 'Unnamed') + '</div>';

            // Enable + Source
            html += '<div class="row">';
            html += '<div class="field"><label style="font-size:10px">Enabled</label><input type="checkbox" ' + (inp.enabled ? 'checked' : '') + ' onchange="updAnalog(' + idx + ',\'enabled\',this.checked)"></div>';
            html += '<div class="field"><label>Source</label><select onchange="updAnalog(' + idx + ',\'source\',this.value)">';
            html += '<option value="gpio"' + (inp.source === 'gpio' ? ' selected' : '') + '>Direct GPIO</option>';
            html += '<option value="mux"' + (inp.source === 'mux' ? ' selected' : '') + '>Multiplexer</option>';
            html += '</select></div>';
            html += '<div class="field"><label>' + (inp.source === 'mux' ? 'Mux Ch' : 'GPIO') + '</label><input type="number" min="0" max="' + (inp.source === 'mux' ? '15' : '39') + '" value="' + inp.pin + '" onchange="updAnalog(' + idx + ',\'pin\',parseInt(this.value))"></div>';
            html += '</div>';

            // Input Mode & Piezo Settings
            html += '<div class="row" style="margin-top:8px">';
            html += '<div class="field"><label>Input Mode</label><select onchange="updAnalog(' + idx + ',\'inputMode\',this.value)">';
            html += '<option value="pot"' + (inp.inputMode === 'pot' ? ' selected' : '') + '>Potentiometer</option>';
            html += '<option value="piezo"' + (inp.inputMode === 'piezo' ? ' selected' : '') + '>Piezo (Drum Pad)</option>';
            html += '<option value="fsr"' + (inp.inputMode === 'fsr' ? ' selected' : '') + '>FSR / Pressure</option>';
            html += '<option value="switch"' + (inp.inputMode === 'switch' ? ' selected' : '') + '>Switch (Digital)</option>';
            html += '</select></div>';

            if (inp.inputMode === 'piezo') {
                html += '<div class="field"><label style="font-size:10px">Threshold</label><input type="number" min="0" max="4095" value="' + (inp.piezoThreshold || 400) + '" onchange="updAnalog(' + idx + ',\'piezoThreshold\',parseInt(this.value))"></div>';
                html += '<div class="field"><label style="font-size:10px">Scan(ms)</label><input type="number" min="1" max="100" value="' + (inp.piezoScanTime || 20) + '" onchange="updAnalog(' + idx + ',\'piezoScanTime\',parseInt(this.value))"></div>';
                html += '<div class="field"><label style="font-size:10px">Mask(ms)</label><input type="number" min="1" max="500" value="' + (inp.piezoMaskTime || 30) + '" onchange="updAnalog(' + idx + ',\'piezoMaskTime\',parseInt(this.value))"></div>';
            } else if (inp.inputMode === 'fsr') {
                html += '<div class="field"><label style="font-size:10px">Threshold</label><input type="number" min="0" max="4095" value="' + (inp.fsrThreshold || presetData.system.fsrThreshold || 100) + '" onchange="updAnalog(' + idx + ',\'fsrThreshold\',parseInt(this.value))"></div>';
            }
            html += '</div>';

            // Label & Appearance (like buttons)
            html += '<div class="msg-box"><div class="msg-title">Label & Appearance</div>';
            html += '<div class="row">';
            html += '<div class="field"><label>Name</label><input type="text" maxlength="10" value="' + (inp.name || '') + '" placeholder="A' + (idx + 1) + '" onchange="updAnalog(' + idx + ',\'name\',this.value)"></div>';
            html += '<div class="field"><label>RGB</label><input type="color" value="' + (inp.rgb || '#f59e0b') + '" onchange="updAnalog(' + idx + ',\'rgb\',this.value)"></div>';
            html += '<div class="field"><label style="font-size:10px">LED Index</label><input type="number" min="-1" max="31" value="' + (inp.ledIndex !== undefined ? inp.ledIndex : -1) + '" onchange="updAnalog(' + idx + ',\'ledIndex\',parseInt(this.value))"></div>';
            html += '</div>';
            html += '<div style="font-size:10px;color:#888">LED Index: -1 = no LED, or specify LED strip index (0-31)</div>';
            html += '</div>';

            // Ensure messages array exists (Migration from v1.5 legacy fields)
            if (!inp.messages) {
                inp.messages = [];
                // If legacy fields exist, migrate them to first message
                if (inp.midiCC !== undefined) {
                    inp.messages.push({
                        type: 'CC',
                        channel: inp.midiChannel || 1,
                        data1: inp.midiCC,
                        min: inp.midiMin || 0,
                        max: inp.midiMax || 127
                    });
                    // Clear legacy fields to prevent re-migration? Or just leave them ignored.
                    // Leaving them is safer for downgrading, but cleaner data is better.
                    // For now, let's keep them but ignored by new logic.
                }
            }

            // Message List (Multi-Message Support)
            html += '<div class="section-title" style="margin-top:16px; border-bottom:1px solid #333; padding-bottom:4px; font-size:0.85rem; color:#f59e0b">Message List <button class="btn primary sm" style="margin-left:auto" onclick="addAnalogMsg(' + idx + ')">+</button></div>';

            for (var i = 0; i < inp.messages.length; i++) {
                var msg = inp.messages[i];
                html += '<div class="msg-box" style="border-left:3px solid #f59e0b">';

                // Card Header
                html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;border-bottom:1px solid #333;padding-bottom:4px">';
                html += '<span style="font-size:0.75rem;font-weight:600;color:#f59e0b">Message ' + (i + 1) + '</span>';
                html += '<button class="btn sm" style="padding:2px 6px;font-size:0.7rem;background:#ef4444" onclick="delAnalogMsg(' + idx + ',' + i + ')">Ã—</button>';
                html += '</div>';

                // Type & Channel
                html += '<div class="row">';
                html += '<div class="field"><label>Type</label><select onchange="updAnalogMsg(' + idx + ',' + i + ',\'type\',this.value)">' + typeOpts(msg.type || 'CC') + '</select></div>';
                html += '<div class="field"><label>Ch</label><input type="number" min="1" max="16" value="' + (msg.channel || 1) + '" onchange="updAnalogMsg(' + idx + ',' + i + ',\'channel\',parseInt(this.value))"></div>';
                html += '</div>';

                // Input Range (Multi-Range / Zones) - Only define active range for this message
                html += '<div class="row" style="background:#222; padding:4px; border-radius:4px; margin-bottom:4px">';
                html += '<div class="field" style="flex:1"><label style="font-size:10px; color:#aaa">In Range Min%</label><input type="number" min="0" max="100" value="' + (msg.inMin !== undefined ? msg.inMin : 0) + '" onchange="updAnalogMsg(' + idx + ',' + i + ',\'inMin\',parseInt(this.value))"></div>';
                html += '<div class="field" style="flex:1"><label style="font-size:10px; color:#aaa">In Range Max%</label><input type="number" min="0" max="100" value="' + (msg.inMax !== undefined ? msg.inMax : 100) + '" onchange="updAnalogMsg(' + idx + ',' + i + ',\'inMax\',parseInt(this.value))"></div>';
                html += '</div>';

                // SYSEX_SCROLL: Show parameter dropdown instead of generic fields
                if (msg.type === 'SYSEX_SCROLL') {
                    // Get available SysEx scroll params from devices_database.js (flat structure)
                    var allParams = [];
                    if (typeof SYSEX_SCROLL_PARAMS !== 'undefined') {
                        for (var paramName in SYSEX_SCROLL_PARAMS) {
                            if (Array.isArray(SYSEX_SCROLL_PARAMS[paramName])) {
                                allParams.push(paramName);
                            }
                        }
                    }
                    // Initialize sysexParam if not set (ensures dropdown selection matches actual value)
                    if (!msg.sysexParam && allParams.length > 0) {
                        msg.sysexParam = allParams[0];
                    }
                    html += '<div class="row">';
                    html += '<div class="field"><label style="color:#f59e0b">Parameter</label><select onchange="updAnalogMsg(' + idx + ',' + i + ',\'sysexParam\',this.value)">';
                    if (allParams.length === 0) {
                        html += '<option value="">No parameters defined</option>';
                    } else {
                        for (var p = 0; p < allParams.length; p++) {
                            var paramName = allParams[p];
                            html += '<option value="' + paramName + '"' + (msg.sysexParam === paramName ? ' selected' : '') + '>' + paramName + '</option>';
                        }
                    }
                    html += '</select></div>';
                    html += '</div>';
                    // Show list size info
                    if (msg.sysexParam && typeof SYSEX_SCROLL_PARAMS !== 'undefined' && SYSEX_SCROLL_PARAMS[msg.sysexParam]) {
                        var listLen = SYSEX_SCROLL_PARAMS[msg.sysexParam].length;
                        html += '<div style="font-size:10px;color:#888;padding:4px 0">ðŸ“‹ ' + listLen + ' SysEx messages in list (0-' + (listLen - 1) + ')</div>';
                    }
                } else {
                    // Data1 & Range (standard CC/NOTE types)
                    html += '<div class="row">';
                    // Label Data1 dynamically based on type? For now generic "Data 1 / CC"
                    var d1Label = (msg.type === 'CC') ? 'CC #' : (msg.type === 'NOTE_ON' ? 'Note #' : 'Data 1');
                    html += '<div class="field"><label>' + d1Label + '</label><input type="number" min="0" max="127" value="' + (msg.data1 || 0) + '" onchange="updAnalogMsg(' + idx + ',' + i + ',\'data1\',parseInt(this.value))"></div>';

                    html += '<div class="field"><label style="font-size:10px">Out Min</label><input type="number" min="0" max="127" value="' + (msg.min !== undefined ? msg.min : 0) + '" onchange="updAnalogMsg(' + idx + ',' + i + ',\'min\',parseInt(this.value))"></div>';
                    html += '<div class="field"><label style="font-size:10px">Out Max</label><input type="number" min="0" max="127" value="' + (msg.max !== undefined ? msg.max : 127) + '" onchange="updAnalogMsg(' + idx + ',' + i + ',\'max\',parseInt(this.value))"></div>';
                    html += '</div>';
                }

                html += '</div>'; // close msg-box
            }

            // Action Type
            html += '<div class="msg-box"><div class="msg-title">Signal Processing</div>';
            html += '<div class="row">';
            html += '<div class="field"><label style="font-size:10px">Action Type</label><select onchange="updAnalog(' + idx + ',\'actionType\',this.value)">';
            for (var at = 0; at < analogActionTypes.length; at++) {
                var atype = analogActionTypes[at];
                html += '<option value="' + atype + '"' + (inp.actionType === atype ? ' selected' : '') + '>' + analogActionLabels[atype] + '</option>';
            }
            html += '</select></div>';
            html += '</div>';

            // Type-specific options
            var opts = inp.actionOptions || {};
            if (inp.actionType === 'log_linear' || inp.actionType === 'linear_log') {
                html += '<div class="row">';
                html += '<div class="field"><label style="font-size:10px">Curve</label><input type="number" min="0.1" max="10" step="0.1" value="' + (opts.curve || 2.0) + '" onchange="updAnalogOpt(' + idx + ',\'curve\',parseFloat(this.value))"></div>';
                html += '</div>';
            } else if (inp.actionType === 'joystick') {
                html += '<div class="row">';
                html += '<div class="field"><label style="font-size:10px">Center</label><input type="number" min="0" max="4095" value="' + (opts.center || 2048) + '" onchange="updAnalogOpt(' + idx + ',\'center\',parseInt(this.value))"></div>';
                html += '<div class="field"><label style="font-size:10px">Deadzone %</label><input type="number" min="0" max="50" value="' + (opts.deadzone || 5) + '" onchange="updAnalogOpt(' + idx + ',\'deadzone\',parseInt(this.value))"></div>';
                html += '</div>';
            }
            html += '</div>';

            // Calibration & Smoothing
            html += '<div class="msg-box"><div class="msg-title">ADC Calibration</div>';
            html += '<div class="row">';
            html += '<div class="field"><label style="font-size:10px">ADC Min</label><input type="number" min="0" max="4095" value="' + (inp.minVal || 0) + '" onchange="updAnalog(' + idx + ',\'minVal\',parseInt(this.value))"></div>';
            html += '<div class="field"><label style="font-size:10px">ADC Max</label><input type="number" min="0" max="4095" value="' + (inp.maxVal || 4095) + '" onchange="updAnalog(' + idx + ',\'maxVal\',parseInt(this.value))"></div>';
            html += '</div>';
            html += '<div class="row">';
            html += '<div class="field"><label style="font-size:10px">Smooth Î±</label><input type="number" min="0.01" max="1" step="0.05" value="' + (inp.emaAlpha || 0.15) + '" onchange="updAnalog(' + idx + ',\'emaAlpha\',parseFloat(this.value))"></div>';
            html += '<div class="field"><label style="font-size:10px">Hysteresis</label><input type="number" min="0" max="20" value="' + (inp.hysteresis || 2) + '" onchange="updAnalog(' + idx + ',\'hysteresis\',parseInt(this.value))"></div>';
            html += '</div>';
            html += '</div>';

            html += '</div>';
            return html;
        }

        function renderSystemConfig() {
            var sys = presetData.system;
            var html = '<div class="section">';
            html += '<div class="section-title">System Configuration</div>';

            // Templates
            html += '<div class="msg-box"><div class="msg-title">Templates</div>';
            html += '<div class="row">';
            html += '<div class="field"><label>Device</label><select onchange="changeTargetDevice(this.value)">' + getDeviceSelectOptions() + '</select></div>';
            html += '</div><div class="row">';
            html += '<div class="field"><label>Template</label><select id="tmplSelect">' + getTemplateSelectOptions() + '</select></div>';
            html += '<div class="field" style="max-width:100px"><button class="btn primary sm" onclick="loadDeviceTemplate()">Load</button></div>';
            html += '</div></div>';

            html += '<div class="msg-box"><div class="msg-title">Bluetooth / WiFi</div>';
            html += '<div class="row">';
            html += '<div class="field"><label>BLE Name</label><input type="text" value="' + sys.bleDeviceName + '" maxlength="20" onchange="updSys(\'bleDeviceName\',this.value)"></div>';
            html += '<div class="field"><label>BLE Mode</label><select onchange="updSys(\'bleMode\',this.value)">';
            html += '<option value="CLIENT"' + (sys.bleMode === 'CLIENT' ? ' selected' : '') + '>Client</option>';
            html += '<option value="SERVER"' + (sys.bleMode === 'SERVER' ? ' selected' : '') + '>Server</option>';
            html += '<option value="DUAL"' + (sys.bleMode === 'DUAL' ? ' selected' : '') + '>Dual</option>';
            html += '<option value="EDIT"' + (sys.bleMode === 'EDIT' ? ' selected' : '') + '>Edit Mode (Preview)</option>';
            html += '</select></div>';
            html += '</div>';
            html += '<div class="row">';
            html += '<div class="field"><label>WiFi SSID</label><input type="text" value="' + sys.apSSID + '" onchange="updSys(\'apSSID\',this.value)"></div>';
            html += '<div class="field"><label>Password</label><input type="text" value="' + sys.apPassword + '" onchange="updSys(\'apPassword\',this.value)"></div>';
            html += '</div></div>';

            html += '<div class="msg-box"><div class="msg-title">Hardware</div>';
            html += '<div class="row">';
            html += '<div class="field"><label>Buttons #</label><input type="number" min="4" max="16" value="' + sys.buttonCount + '" onchange="updBtnCount(parseInt(this.value))"></div>';
            html += '<div class="field"><label>Btn Pins</label><input type="text" value="' + sys.buttonPins + '" onchange="updSys(\'buttonPins\',this.value)"></div>';
            html += '</div>';
            html += '<div class="row">';
            html += '<div class="field"><label>LED Pin</label><input type="number" min="0" max="39" value="' + sys.ledPin + '" onchange="updSys(\'ledPin\',parseInt(this.value))"></div>';
            html += '<div class="field"><label>LEDs/Btn</label><input type="number" min="1" max="32" value="' + sys.ledsPerButton + '" onchange="updSys(\'ledsPerButton\',parseInt(this.value))"></div>';
            html += '<div class="field"><label>LED Map</label><input type="text" value="' + sys.ledMap + '" onchange="updSys(\'ledMap\',this.value)"></div>';
            html += '</div>';
            html += '<div class="row">';

            html += '<div class="field"><label style="font-size:11px">LED Bright On</label><input type="number" min="0" max="255" value="' + (sys.brightness || 220) + '" onchange="updSys(\'brightness\',parseInt(this.value)); checkBrightnessWarning()"></div>';
            html += '<div class="field"><label style="font-size:11px">LED Bright Dim</label><input type="number" min="0" max="255" value="' + (sys.brightnessDim || 20) + '" onchange="updSys(\'brightnessDim\',parseInt(this.value)); checkBrightnessWarning()"></div>';
            html += '<div class="field"><label style="font-size:11px">LED Tap Tempo</label><input type="number" min="0" max="255" value="' + (sys.brightnessTap !== undefined ? sys.brightnessTap : 240) + '" onchange="updSys(\'brightnessTap\',parseInt(this.value)); checkBrightnessWarning()"></div>';
            html += '</div>';
            var showWarning = (sys.brightness || 220) > 240 || (sys.brightnessDim || 20) > 240 || (sys.brightnessTap !== undefined ? sys.brightnessTap : 240) > 240;
            html += '<div id="brightnessWarning" class="row" style="color:#fbbf24; font-size:12px;' + (showWarning ? '' : 'display:none;') + '">âš ï¸ LED too bright, use with caution</div>';
            // Encoder pins (merged into hardware)
            html += '<div class="row" style="margin-top:8px;border-top:1px solid #333;padding-top:8px">';
            html += '<div class="field"><label>Enc A</label><input type="number" min="0" max="39" value="' + sys.encoderA + '" onchange="updSys(\'encoderA\',parseInt(this.value))"></div>';
            html += '<div class="field"><label>Enc B</label><input type="number" min="0" max="39" value="' + sys.encoderB + '" onchange="updSys(\'encoderB\',parseInt(this.value))"></div>';
            html += '<div class="field"><label>Enc Btn</label><input type="number" min="0" max="39" value="' + sys.encoderBtn + '" onchange="updSys(\'encoderBtn\',parseInt(this.value))"></div>';
            html += '</div>';
            // Display Pins - Conditional based on display type (I2C vs SPI)
            var oled = sys.oled || {};
            var dispType = oled.type || '128x64';
            var isI2C = dispType === '128x64' || dispType === '128x32';
            var isSPI = dispType === '128x128' || dispType === '128x160';
            var hasDisplay = dispType !== 'none';
            if (hasDisplay) {
                html += '<div style="margin-top:8px;border-top:1px solid #333;padding-top:8px;font-size:11px;color:#8ffdff;font-weight:600;margin-bottom:4px">Display Pins (' + (isI2C ? 'I2C' : 'SPI') + ')</div>';
                if (isI2C) {
                    html += '<div class="row">';
                    html += '<div class="field"><label>SDA</label><input type="number" min="0" max="39" value="' + (oled.sdaPin || 21) + '" onchange="updOled(\'sdaPin\',parseInt(this.value))"></div>';
                    html += '<div class="field"><label>SCL</label><input type="number" min="0" max="39" value="' + (oled.sclPin || 22) + '" onchange="updOled(\'sclPin\',parseInt(this.value))"></div>';
                    html += '</div>';
                } else if (isSPI) {
                    html += '<div class="row">';
                    html += '<div class="field"><label>CS</label><input type="number" min="0" max="39" value="' + (oled.csPin || 15) + '" onchange="updOled(\'csPin\',parseInt(this.value))"></div>';
                    html += '<div class="field"><label>DC</label><input type="number" min="0" max="39" value="' + (oled.dcPin || 2) + '" onchange="updOled(\'dcPin\',parseInt(this.value))"></div>';
                    html += '<div class="field"><label>RST</label><input type="number" min="0" max="39" value="' + (oled.rstPin || 4) + '" onchange="updOled(\'rstPin\',parseInt(this.value))"></div>';
                    html += '</div>';
                    html += '<div class="row">';
                    html += '<div class="field"><label>MOSI</label><input type="number" min="0" max="39" value="' + (oled.mosiPin || 23) + '" onchange="updOled(\'mosiPin\',parseInt(this.value))"></div>';
                    html += '<div class="field"><label>SCLK</label><input type="number" min="0" max="39" value="' + (oled.sclkPin || 18) + '" onchange="updOled(\'sclkPin\',parseInt(this.value))"></div>';
                    html += '<div class="field"><label>LED</label><input type="number" min="0" max="39" value="' + (oled.ledPin || 32) + '" onchange="updOled(\'ledPin\',parseInt(this.value))"></div>';
                    html += '</div>';
                }
            }
            html += '</div>';

            // Note: Display settings are now configured via the Display Preview card in the left column

            // Analog Inputs (v1.5 Beta)
            html += '<div class="msg-box" style="border-color:#f59e0b"><div class="msg-title" style="color:#f59e0b">ðŸŽšï¸ Analog Inputs (BETA)</div>';
            html += '<div class="row">';
            html += '<div class="field"><label style="font-size:11px">Input Count</label><input type="number" min="0" max="16" value="' + (sys.analogInputCount || 0) + '" onchange="updAnalogCount(parseInt(this.value))"></div>';
            html += '</div>';
            html += '<div style="font-size:11px;color:#888;margin-top:6px">';
            html += 'ðŸ’¡ <b>ADC1 Pins (WiFi-safe):</b> GPIO 32, 33, 34, 35, 36, 39<br>';
            html += 'âš ï¸ <b>ADC2 Pins (no WiFi):</b> GPIO 25, 26, 27<br>';
            html += 'ðŸ”Œ For 8+ inputs, use <b>CD74HC4067</b> (16ch) or <b>CD74HC4051</b> (8ch) multiplexer';
            html += '</div>';
            html += '</div>';

            // Multiplexer Settings
            var mux = sys.multiplexer || { enabled: false, type: 'cd74hc4067', signalPin: 34, selectPins: [26, 27, 14, 12], useFor: 'analog' };
            html += '<div class="msg-box" style="border-color:#8b5cf6"><div class="msg-title" style="color:#8b5cf6">ðŸ”€ Multiplexer</div>';
            html += '<div style="display:flex;align-items:center;margin-bottom:10px">';
            html += '<input type="checkbox" ' + (mux.enabled ? 'checked' : '') + ' onchange="updMux(\'enabled\',this.checked)" style="width:18px;height:18px">';
            html += '<span style="font-weight:600;color:#8b5cf6;margin-left:8px">Enable Multiplexer</span>';
            html += '</div>';
            if (mux.enabled) {
                html += '<div class="row">';
                html += '<div class="field"><label>Type</label><select onchange="updMux(\'type\',this.value)">';
                html += '<option value="cd74hc4067"' + (mux.type === 'cd74hc4067' ? ' selected' : '') + '>CD74HC4067 (16ch)</option>';
                html += '<option value="cd74hc4051"' + (mux.type === 'cd74hc4051' ? ' selected' : '') + '>CD74HC4051 (8ch)</option>';
                html += '</select></div>';
                html += '<div class="field"><label style="font-size:10px">Signal Pin</label><input type="number" min="32" max="39" value="' + mux.signalPin + '" onchange="updMux(\'signalPin\',parseInt(this.value))"></div>';
                html += '</div>';
                html += '<div class="row">';
                var selPins = mux.selectPins || [26, 27, 14, 12];
                html += '<div class="field"><label>S0</label><input type="number" min="0" max="39" value="' + selPins[0] + '" onchange="updMuxPin(0,parseInt(this.value))"></div>';
                html += '<div class="field"><label>S1</label><input type="number" min="0" max="39" value="' + selPins[1] + '" onchange="updMuxPin(1,parseInt(this.value))"></div>';
                html += '<div class="field"><label>S2</label><input type="number" min="0" max="39" value="' + selPins[2] + '" onchange="updMuxPin(2,parseInt(this.value))"></div>';
                if (mux.type === 'cd74hc4067') {
                    html += '<div class="field"><label>S3</label><input type="number" min="0" max="39" value="' + selPins[3] + '" onchange="updMuxPin(3,parseInt(this.value))"></div>';
                }
                html += '</div>';
                html += '<div class="row">';
                html += '<div class="field"><label>Use For</label><select onchange="updMux(\'useFor\',this.value)">';
                html += '<option value="analog"' + (mux.useFor === 'analog' ? ' selected' : '') + '>Analog Inputs</option>';
                html += '<option value="buttons"' + (mux.useFor === 'buttons' ? ' selected' : '') + '>Buttons</option>';
                html += '<option value="both"' + (mux.useFor === 'both' ? ' selected' : '') + '>Both</option>';
                html += '</select></div>';
                html += '</div>';
                // Show mux button pins when used for buttons
                if (mux.useFor === 'buttons' || mux.useFor === 'both') {
                    html += '<div style="margin-top:10px;padding-top:10px;border-top:1px solid #444">';
                    html += '<div style="font-size:11px;color:#8b5cf6;font-weight:600;margin-bottom:6px">Mux Button Channels</div>';
                    html += '<div class="row">';
                    html += '<div class="field"><label style="font-size:10px">Mux Btn Pins</label><input type="text" value="' + (mux.buttonChannels || '0,1,2,3,4,5,6,7') + '" placeholder="0,1,2,3..." onchange="updMux(\'buttonChannels\',this.value)"></div>';
                    html += '</div>';
                    html += '<div style="font-size:10px;color:#888">Comma-separated mux channels for buttons (e.g., 0,1,2,3,4,5,6,7)</div>';
                    html += '</div>';
                }
            }
            html += '</div>';

            // Debug Options
            html += '<div class="msg-box"><div class="msg-title">Debug Options</div>';
            html += '<div class="row">';
            html += '<div style="display:flex;align-items:center;gap:8px">';
            html += '<input type="checkbox" ' + (sys.debugAnalogIn ? 'checked' : '') + ' onchange="updSys(\'debugAnalogIn\',this.checked)" style="width:16px;height:16px">';
            html += '<label style="font-size:12px">Debug Analog In (show ADC value on OLED)</label>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Battery Monitoring ADC Pin (v1.5)
            html += '<div class="msg-box" style="border-color:#22c55e"><div class="msg-title" style="color:#22c55e">ðŸ”‹ Battery Monitoring</div>';
            html += '<div class="row">';
            html += '<div class="field"><label style="font-size:11px">ADC Pin</label><input type="number" min="0" max="39" value="' + (sys.batteryAdcPin || 0) + '" onchange="updSys(\'batteryAdcPin\',parseInt(this.value))"></div>';
            html += '</div>';
            html += '<div style="font-size:11px;color:#888;margin-top:6px">';
            html += 'ðŸ’¡ <b>Voltage Divider:</b> Use 2x 100kÎ© resistors for 18650 battery<br>';
            html += 'ðŸ”Œ <b>ADC Pins:</b> GPIO 32, 33, 34, 35, 36, 39 (0 = disabled)<br>';
            html += 'ðŸ“º <b>Display settings:</b> Configure icon in OLED Preview card';
            html += '</div>';
            html += '</div>';

            // Global Special Actions (Combo per button)
            html += renderGlobalSpecialActions();

            // Save System Changes Button
            html += '<div class="actions" style="margin-top:16px; justify-content:center">';
            html += '<button class="btn success" onclick="saveChanges()">Save System Changes</button>';
            html += '</div>';

            html += '</div>';
            return html;
        }

        function renderGlobalSpecialActions() {
            var html = '<div class="msg-box" style="border-color:#a78bfa"><div class="msg-title" style="color:#a78bfa">ðŸ”¥ Global Actions Overview</div>';
            html += '<div style="font-size:10px;color:#888;margin-bottom:10px">Manage global actions for all buttons. These trigger regardless of the current preset.</div>';

            var gsa = presetData.system.globalSpecialActions || [];
            var btnCount = presetData.system.buttonCount || 8;

            html += '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:10px">';
            // Render in physical layout order: top row (5,6,7,8), then bottom row (1,2,3,4)
            var half = Math.ceil(btnCount / 2);
            var order = [];
            for (var j = half; j < btnCount; j++) order.push(j); // Top row: indices 4,5,6,7 (BTN 5-8)
            for (var j = 0; j < half; j++) order.push(j);        // Bottom row: indices 0,1,2,3 (BTN 1-4)

            for (var idx = 0; idx < order.length; idx++) {
                var i = order[idx];
                var action = gsa[i] || { enabled: false, type: 'OFF' };
                var isActive = action.enabled && action.type !== 'OFF';

                html += '<div class="btn-tile' + (isActive ? ' active' : '') + '" style="padding:8px;border-color:' + (isActive ? '#a78bfa' : '#333') + ';cursor:pointer" onclick="selBtn(' + i + ')">';
                html += '<div style="font-size:0.7rem;color:#888">BTN ' + (i + 1) + '</div>';
                html += '<div style="font-size:0.8rem;font-weight:600;color:' + (isActive ? '#a78bfa' : '#ccc') + '">' + (isActive ? action.type : 'NONE') + '</div>';
                if (isActive && action.label) html += '<div style="font-size:0.65rem;color:#666">' + action.label + '</div>';
                html += '</div>';
            }
            html += '</div>';
            html += '</div>';
            return html;
        }


        // Auto-label generator - matches firmware getButtonSummary() in UI_Display.cpp
        // For notes, CC, PC: return empty so button label is used instead
        function getAutoLabel(msg) {
            switch (msg.type) {
                case 'NOTE_MOMENTARY':
                case 'NOTE_ON':
                case 'NOTE_OFF':
                case 'CC':
                case 'PC':
                case 'SYSEX':
                    return '';  // Use button label
                case 'TAP_TEMPO': return 'TAP';
                case 'PRESET_UP': return '>';
                case 'PRESET_DOWN': return '<';
                case 'PRESET_1': return presetData.presets[0] ? presetData.presets[0].name : 'P1';
                case 'PRESET_2': return presetData.presets[1] ? presetData.presets[1].name : 'P2';
                case 'PRESET_3': return presetData.presets[2] ? presetData.presets[2].name : 'P3';
                case 'PRESET_4': return presetData.presets[3] ? presetData.presets[3].name : 'P4';
                case 'WIFI_TOGGLE': return 'WiFi';
                case 'CLEAR_BLE_BONDS': return 'xBLE';
                case 'MENU_TOGGLE': return 'MENU';
                case 'MENU_UP': return 'M.UP';
                case 'MENU_DOWN': return 'M.DN';
                case 'MENU_ENTER': return 'M.OK';
                case 'OFF': return '';
                default: return '';
            }
        }

        // v1.5.1: Render grouped optgroups for MIDI and Internal commands
        function typeOpts(sel) {
            var html = '<optgroup label="MIDI Commands">';
            for (var i = 0; i < MIDI_COMMANDS.length; i++) {
                var t = MIDI_COMMANDS[i];
                html += '<option value="' + t + '"' + (t === sel ? ' selected' : '') + '>' + t + '</option>';
            }
            html += '</optgroup><optgroup label="Internal Commands">';
            for (var i = 0; i < INTERNAL_COMMANDS.length; i++) {
                var t = INTERNAL_COMMANDS[i];
                html += '<option value="' + t + '"' + (t === sel ? ' selected' : '') + '>' + t.replace(/_/g, ' ') + '</option>';
            }
            html += '</optgroup>';
            return html;
        }
        function actionOpts(sel) { return actionTypes.map(function (t) { return '<option value="' + t + '"' + (t === sel ? ' selected' : '') + '>' + t.replace('_', ' ') + '</option>'; }).join(''); }

        function selGlobal() {
            showGlobalActions = true;
            selectedBtn = -1;
            selectedAnalogInput = -1;
            showSystem = false;
            render();
        }

        function chgPreset(v) {
            presetData.currentPreset = parseInt(v);
            selectedBtn = 0;
            showSystem = false;
            render();

            // WiFi: fire and forget
            fetch('/preset?p=' + v).catch(function (e) { });

            // Serial: send if connected
            if (serialWriter) {
                serialWriter.write(new TextEncoder().encode('SET_PRESET:' + v + '\n')).catch(function (e) { });
            }

            // BLE: send if connected
            if (bleRxChar && bleDevice && bleDevice.gatt.connected) {
                console.log('BLE: Sending SET_PRESET:' + v);
                bleRxChar.writeValue(new TextEncoder().encode('SET_PRESET:' + v + '\n'))
                    .then(function () { console.log('BLE: SET_PRESET sent successfully'); })
                    .catch(function (e) { console.error('BLE SET_PRESET error:', e); });
            } else {
                console.log('BLE: Not connected (bleRxChar:', !!bleRxChar, 'bleDevice:', !!bleDevice, 'connected:', bleDevice ? bleDevice.gatt.connected : false, ')');
            }
        }
        function chgPresetLedMode(v) { presetData.presets[presetData.currentPreset].presetLedMode = v; render(); }

        function toggleSystem() { showSystem = !showSystem; render(); }

        function updBtn(k, v) { presetData.presets[presetData.currentPreset].buttons[selectedBtn][k] = v; render(); }
        function updMsg(idx, k, v) {
            presetData.presets[presetData.currentPreset].buttons[selectedBtn].messages[idx][k] = v;
            if (k === 'type' || k === 'action') render();
        }
        function addMsg() {
            var p = presetData.currentPreset;
            var btn = presetData.presets[p].buttons[selectedBtn];
            if (!btn.messages) btn.messages = [];
            btn.messages.push({ action: 'PRESS', type: 'CC', channel: 1, data1: 0, data2: 127, rgb: '#bb86fc' });
            render();
        }
        function delMsg(idx) {
            var p = presetData.currentPreset;
            presetData.presets[p].buttons[selectedBtn].messages.splice(idx, 1);
            render();
        }

        // Clipboard for action copy/paste (unified for normal and global)
        var actionClipboard = null;

        function copyAction(idx) {
            var msg = presetData.presets[presetData.currentPreset].buttons[selectedBtn].messages[idx];
            actionClipboard = JSON.parse(JSON.stringify(msg));
            alert('Action copied');
        }

        function pasteAction(idx) {
            if (!actionClipboard) return alert('Copy an action first');
            presetData.presets[presetData.currentPreset].buttons[selectedBtn].messages[idx] = JSON.parse(JSON.stringify(actionClipboard));
            render();
        }
        // chgPreset is now defined earlier in the file with full BLE support
        function chgPresetLedMode(mode) { presetData.presets[presetData.currentPreset].presetLedMode = mode; render(); }
        function chgPresetName(newName) { presetData.presets[presetData.currentPreset].name = newName; }
        function chgSyncMode(v) { presetData.presets[presetData.currentPreset].syncMode = v; render(); }

        // Analog Input functions
        function updAnalogCount(count) {
            presetData.system.analogInputCount = count;
            // Ensure analogInputs array has enough entries
            if (!presetData.analogInputs) presetData.analogInputs = [];
            while (presetData.analogInputs.length < count) {
                var idx = presetData.analogInputs.length;
                presetData.analogInputs.push(createDefaultAnalogInput(idx));
            }
            if (selectedAnalogInput >= count) selectedAnalogInput = count - 1;
            render();
        }
        function createDefaultAnalogInput(idx) {
            var defaultPins = [34, 35, 32, 33, 36, 39, 25, 26, 27, 0, 1, 2, 3, 4, 5, 6];
            var defaultColors = ['#f59e0b', '#22c55e', '#3b82f6', '#a855f7', '#ef4444', '#06b6d4', '#ec4899', '#84cc16'];
            return {
                enabled: true,
                source: 'gpio',
                pin: defaultPins[idx % defaultPins.length],
                name: 'A' + (idx + 1),
                rgb: defaultColors[idx % defaultColors.length],
                ledIndex: -1,
                messages: [
                    { type: 'CC', channel: 1, data1: 11, min: 0, max: 127 }
                ],
                actionType: 'linear_linear',
                actionOptions: {},
                inverted: false,
                emaAlpha: 0.15,
                hysteresis: 2,
                minVal: 0,
                maxVal: 4095
            };
        }
        function updAnalog(idx, k, v) {
            if (!presetData.analogInputs || !presetData.analogInputs[idx]) return;
            presetData.analogInputs[idx][k] = v;
            render();
        }
        function updAnalogOpt(idx, k, v) {
            if (!presetData.analogInputs || !presetData.analogInputs[idx]) return;
            if (!presetData.analogInputs[idx].actionOptions) presetData.analogInputs[idx].actionOptions = {};
            presetData.analogInputs[idx].actionOptions[k] = v;
            render();
        }
        // Analog Message Helper Functions
        function addAnalogMsg(idx) {
            var ainp = presetData.analogInputs[idx];
            if (!ainp.messages) ainp.messages = [];
            ainp.messages.push({ type: 'CC', channel: 1, data1: 11, min: 0, max: 127 });
            render();
        }
        function delAnalogMsg(ainpIdx, msgIdx) {
            var ainp = presetData.analogInputs[ainpIdx];
            if (ainp && ainp.messages) {
                ainp.messages.splice(msgIdx, 1);
                render();
            }
        }
        function updAnalogMsg(ainpIdx, msgIdx, k, v) {
            var ainp = presetData.analogInputs[ainpIdx];
            if (ainp && ainp.messages && ainp.messages[msgIdx]) {
                ainp.messages[msgIdx][k] = v;
                render();
            }
        }

        // Multiplexer functions
        function updMux(k, v) {
            if (!presetData.system.multiplexer) {
                presetData.system.multiplexer = { enabled: false, type: 'cd74hc4067', signalPin: 34, selectPins: [26, 27, 14, 12], useFor: 'analog' };
            }
            presetData.system.multiplexer[k] = v;
            render();
        }
        function updMuxPin(idx, v) {
            if (!presetData.system.multiplexer) return;
            if (!presetData.system.multiplexer.selectPins) presetData.system.multiplexer.selectPins = [26, 27, 14, 12];
            presetData.system.multiplexer.selectPins[idx] = v;
            render();
        }

        // OLED functions
        function updOled(k, v) {
            if (!presetData.system.oled) {
                presetData.system.oled = { type: '128x64', rotation: 0, textSizes: { title: 2, subtitle: 1, label: 1, value: 2 } };
            }
            presetData.system.oled[k] = v;

            // Check for pin conflicts when switching to TFT display
            if (k === 'type' && (v === '128x128' || v === '128x160')) {
                resolveSpiPinConflicts();
            }

            render();
        }
        function updOledText(k, v) {
            if (!presetData.system.oled) {
                presetData.system.oled = { type: '128x64', rotation: 0, textSizes: { title: 2, subtitle: 1, label: 1, value: 2 } };
            }
            if (!presetData.system.oled.textSizes) {
                presetData.system.oled.textSizes = { title: 2, subtitle: 1, label: 1, value: 2 };
            }
            presetData.system.oled.textSizes[k] = v;
            // Update the display value span
            var spanId = 'oled' + k.charAt(0).toUpperCase() + k.slice(1) + 'Val';
            var span = document.getElementById(spanId);
            if (span) span.textContent = v;
            // Re-render preview
            setTimeout(renderOledPreview, 50);
        }

        // Per-screen OLED settings update
        function updOledScreen(screen, key, value) {
            // Ensure oled structure exists
            if (!presetData.system.oled) {
                presetData.system.oled = { type: '128x64', rotation: 0, screens: {} };
            }
            if (!presetData.system.oled.screens) {
                presetData.system.oled.screens = {};
            }
            if (!presetData.system.oled.screens[screen]) {
                // Initialize with defaults based on screen type
                if (screen === 'main') {
                    presetData.system.oled.screens.main = { labelSize: 1, titleSize: 2, statusSize: 1, topRowY: 0, titleY: 14, statusY: 32, bottomRowY: 56, showBpm: true, showStatus: true, showTopRow: true, showBottomRow: true, topRowMap: '5,6,7,8', bottomRowMap: '1,2,3,4' };
                } else if (screen === 'menu') {
                    presetData.system.oled.screens.menu = { headerSize: 1, itemSize: 1, headerY: 0, itemStartY: 14 };
                } else if (screen === 'tap') {
                    presetData.system.oled.screens.tap = { labelSize: 1, bpmSize: 3, patternSize: 1, labelTopY: 0, bpmY: 16, patternY: 46, labelBottomY: 56 };
                } else if (screen === 'overlay') {
                    presetData.system.oled.screens.overlay = { textSize: 2 };
                }
            }
            presetData.system.oled.screens[screen][key] = value;
            // Re-render preview (without full render() to preserve dropdown state)
            setTimeout(renderOledPreview, 50);
        }

        // 5x7 font for OLED preview (subset)
        var oledFont = {
            'A': [0x7E, 0x11, 0x11, 0x11, 0x7E], 'B': [0x7F, 0x49, 0x49, 0x49, 0x36], 'C': [0x3E, 0x41, 0x41, 0x41, 0x22], 'D': [0x7F, 0x41, 0x41, 0x22, 0x1C],
            'E': [0x7F, 0x49, 0x49, 0x49, 0x41], 'F': [0x7F, 0x09, 0x09, 0x01, 0x01], 'G': [0x3E, 0x41, 0x41, 0x51, 0x32], 'H': [0x7F, 0x08, 0x08, 0x08, 0x7F],
            'I': [0x00, 0x41, 0x7F, 0x41, 0x00], 'J': [0x20, 0x40, 0x41, 0x3F, 0x01], 'K': [0x7F, 0x08, 0x14, 0x22, 0x41], 'L': [0x7F, 0x40, 0x40, 0x40, 0x40],
            'M': [0x7F, 0x02, 0x04, 0x02, 0x7F], 'N': [0x7F, 0x04, 0x08, 0x10, 0x7F], 'O': [0x3E, 0x41, 0x41, 0x41, 0x3E], 'P': [0x7F, 0x09, 0x09, 0x09, 0x06],
            'Q': [0x3E, 0x41, 0x51, 0x21, 0x5E], 'R': [0x7F, 0x09, 0x19, 0x29, 0x46], 'S': [0x46, 0x49, 0x49, 0x49, 0x31], 'T': [0x01, 0x01, 0x7F, 0x01, 0x01],
            'U': [0x3F, 0x40, 0x40, 0x40, 0x3F], 'V': [0x1F, 0x20, 0x40, 0x20, 0x1F], 'W': [0x3F, 0x40, 0x38, 0x40, 0x3F], 'X': [0x63, 0x14, 0x08, 0x14, 0x63],
            'Y': [0x07, 0x08, 0x70, 0x08, 0x07], 'Z': [0x61, 0x51, 0x49, 0x45, 0x43], ' ': [0, 0, 0, 0, 0],
            '0': [0x3E, 0x51, 0x49, 0x45, 0x3E], '1': [0x00, 0x42, 0x7F, 0x40, 0x00], '2': [0x42, 0x61, 0x51, 0x49, 0x46], '3': [0x21, 0x41, 0x45, 0x4B, 0x31],
            '4': [0x18, 0x14, 0x12, 0x7F, 0x10], '5': [0x27, 0x45, 0x45, 0x45, 0x39], '6': [0x3C, 0x4A, 0x49, 0x49, 0x30], '7': [0x01, 0x71, 0x09, 0x05, 0x03],
            '8': [0x36, 0x49, 0x49, 0x49, 0x36], '9': [0x06, 0x49, 0x49, 0x29, 0x1E], ':': [0x00, 0x36, 0x36, 0x00, 0x00], '-': [0x08, 0x08, 0x08, 0x08, 0x08],
            '.': [0x00, 0x60, 0x60, 0x00, 0x00]
        };

        function updOledY(k, v) {
            if (!presetData.system.oled) {
                presetData.system.oled = { type: '128x64', rotation: 0, textSizes: { title: 2, subtitle: 1, label: 1, value: 2 }, yPositions: { topRow: 0, bottomRow: 56 } };
            }
            if (!presetData.system.oled.yPositions) {
                presetData.system.oled.yPositions = { topRow: 0, bottomRow: 56 };
            }
            presetData.system.oled.yPositions[k] = v;
            // Re-render preview
            setTimeout(renderOledPreview, 50);
        }

        function renderOledPreview() {
            var canvas = document.getElementById('oledPreview');
            if (!canvas) return;
            var ctx = canvas.getContext('2d');

            // Get selected mode
            var modeEl = document.getElementById('oledPreviewMode');
            var mode = modeEl ? modeEl.value : 'main';

            var oled = presetData.system.oled || { type: '128x64', rotation: 0, textSizes: { title: 2, subtitle: 1, label: 1, value: 2 }, yPositions: { topRow: 0, bottomRow: 56 }, screens: {} };
            if (!oled.screens) oled.screens = {};

            // Base config from legacy defaults
            var ts = JSON.parse(JSON.stringify(oled.textSizes || { title: 2, subtitle: 1, label: 1, value: 2 }));

            // Merge screen-specific config if available
            if (oled.screens && oled.screens[mode]) {
                var screenCfg = oled.screens[mode];
                for (var key in screenCfg) ts[key] = screenCfg[key];

                // Polyfill new v1.5 names to legacy names used in renderer
                if (ts.labelSize) ts.label = ts.labelSize;
                if (ts.titleSize) ts.title = ts.titleSize;
                if (ts.statusSize) { ts.status = ts.statusSize; ts.subtitle = ts.statusSize; }
            }

            var yp = oled.yPositions || { topRow: 0, bottomRow: 56 };
            var is32 = oled.type === '128x32';
            var is128 = oled.type === '128x128';
            var is160 = oled.type === '128x160';
            var rotation = oled.rotation || 0;
            var isVertical = (rotation === 90 || rotation === 270);
            // Dimensions
            var baseW = 128;
            var baseH = is160 ? 160 : (is128 ? 128 : (is32 ? 32 : 64));
            var w = isVertical ? baseH : baseW;
            var h = isVertical ? baseW : baseH;
            var scale = 2;

            canvas.width = w * scale;
            canvas.height = h * scale;
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            function setPixel(x, y, on) {
                if (x < 0 || x >= w || y < 0 || y >= h) return;
                ctx.fillStyle = on ? '#fff' : '#000';
                ctx.fillRect(x * scale, y * scale, scale, scale);
            }
            function drawChar(ch, x, y, size) {
                var data = oledFont[ch.toUpperCase()] || oledFont[' '];
                for (var col = 0; col < 5; col++) {
                    var bits = data[col];
                    for (var row = 0; row < 7; row++) {
                        if (bits & (1 << row)) {
                            for (var sy = 0; sy < size; sy++) {
                                for (var sx = 0; sx < size; sx++) {
                                    setPixel(x + col * size + sx, y + row * size + sy, true);
                                }
                            }
                        }
                    }
                }
                return 6 * size;
            }
            function drawText(text, x, y, size) {
                var curX = x;
                for (var i = 0; i < text.length; i++) {
                    curX += drawChar(text[i], curX, y, size);
                }
            }
            function textWidth(text, size) { return text.length * 6 * size; }
            function drawCentered(text, y, size) {
                var width = textWidth(text, size);
                var x = Math.floor((w - width) / 2);
                drawText(text, x, y, size);
            }
            function drawFilledCircle(cx, cy, r) {
                for (var dy = -r; dy <= r; dy++) {
                    for (var dx = -r; dx <= r; dx++) {
                        if (dx * dx + dy * dy <= r * r) setPixel(cx + dx, cy + dy, true);
                    }
                }
            }
            function drawCircle(cx, cy, r) {
                for (var a = 0; a < 360; a += 15) {
                    var rad = a * Math.PI / 180;
                    setPixel(Math.round(cx + r * Math.cos(rad)), Math.round(cy + r * Math.sin(rad)), true);
                }
            }
            function drawFilledRoundRect(x, y, rw, rh, r) {
                for (var py = y; py < y + rh; py++) {
                    for (var px = x; px < x + rw; px++) {
                        setPixel(px, py, true);
                    }
                }
            }
            function drawInvertedText(text, x, y, size) {
                var tw = textWidth(text, size) + 4;
                var th = 7 * size + 2;
                drawFilledRoundRect(x - 2, y - 1, tw, th, 2);
                // Draw black text
                var curX = x;
                for (var i = 0; i < text.length; i++) {
                    var ch = text[i];
                    var data = oledFont[ch.toUpperCase()] || oledFont[' '];
                    for (var col = 0; col < 5; col++) {
                        var bits = data[col];
                        for (var row = 0; row < 7; row++) {
                            if (bits & (1 << row)) {
                                for (var sy = 0; sy < size; sy++) {
                                    for (var sx = 0; sx < size; sx++) {
                                        setPixel(curX + col * size + sx, y + row * size + sy, false);
                                    }
                                }
                            }
                        }
                    }
                    curX += 6 * size;
                }
            }

            // --- STATE MANAGEMENT FOR PREVIEW LAYOUTS ---
            // Store slider values for each mode independently
            if (!window.previewLayouts) {
                window.previewLayouts = {
                    'main': { label: 1, title: 2, status: 1, topY: 0, bottomY: 56 },
                    'menu': { label: 1, title: 2, status: 1, topY: 0, bottomY: 56 },
                    'tap': { label: 1, title: 2, status: 1, topY: 0, bottomY: 56 },
                    'loading': { label: 1, title: 2, status: 1, topY: 0, bottomY: 56 }, // Fixed but stored
                    'overlay': { label: 1, title: 4, status: 1, topY: 0, bottomY: 32 },  // Default huge for overlay
                    'lastMode': 'main'
                };
            }

            // Get current slider values function
            function getCurrentSliders() {
                var labelEl = document.getElementById('oledLabelSize');
                var titleEl = document.getElementById('oledTitleSize');
                var statusEl = document.getElementById('oledStatusSize');
                var topEl = document.getElementById('oledTopRowY');
                var bottomEl = document.getElementById('oledBottomRowY');
                return {
                    label: labelEl ? parseInt(labelEl.value) : 1,
                    title: titleEl ? parseInt(titleEl.value) : 2,
                    status: statusEl ? parseInt(statusEl.value) : 1,
                    topY: topEl ? parseInt(topEl.value) : 0,
                    bottomY: bottomEl ? parseInt(bottomEl.value) : 56
                };
            }

            // Set sliders function (no-op if elements don't exist)
            function setSliders(layout) {
                var labelEl = document.getElementById('oledLabelSize');
                var titleEl = document.getElementById('oledTitleSize');
                var statusEl = document.getElementById('oledStatusSize');
                var topEl = document.getElementById('oledTopRowY');
                var bottomEl = document.getElementById('oledBottomRowY');

                if (labelEl) labelEl.value = layout.label;
                if (titleEl) titleEl.value = layout.title;
                if (statusEl) statusEl.value = layout.status;
                if (topEl) topEl.value = layout.topY;
                if (bottomEl) bottomEl.value = layout.bottomY;
            }

            // Get Preview Mode
            var previewMode = document.getElementById('oledPreviewMode') ? document.getElementById('oledPreviewMode').value : 'main';

            // Get per-screen settings from new structure
            var screens = oled.screens || {};
            var ts = {}; // Text sizes and Y positions for current mode

            if (previewMode === 'main') {
                var main = screens.main || { labelSize: 1, titleSize: 2, statusSize: 1, bpmSize: 1, topRowY: 0, titleY: 14, statusY: 44, bpmY: 32, bottomRowY: 56, showBpm: true, showAnalog: false, showStatus: true, showTopRow: true, showBottomRow: true, titleAlign: 1, statusAlign: 0, bpmAlign: 1, topRowMap: '5,6,7,8', bottomRowMap: '1,2,3,4', showColorStrips: false, colorStripHeight: 4, topRowAlign: 0, bottomRowAlign: 0 };
                ts = {
                    label: main.labelSize || 1,
                    title: main.titleSize || 2,
                    status: main.statusSize || 1,
                    bpmSize: main.bpmSize || 1,
                    subtitle: main.statusSize || 1,
                    top: main.topRowY || 0,
                    titleY: main.titleY || 14,
                    statusY: main.statusY || 44,
                    bpmY: main.bpmY !== undefined ? main.bpmY : 32,
                    bottom: main.bottomRowY || 56,
                    showBpm: main.showBpm !== false,
                    showStatus: main.showStatus !== false,
                    showAnalog: main.showAnalog === true,
                    showTopRow: main.showTopRow !== false,
                    showBottomRow: main.showBottomRow !== false,
                    titleAlign: main.titleAlign !== undefined ? main.titleAlign : 1,
                    statusAlign: main.statusAlign !== undefined ? main.statusAlign : 0,
                    bpmAlign: main.bpmAlign !== undefined ? main.bpmAlign : 1,
                    topRowMap: main.topRowMap || '5,6,7,8',
                    bottomRowMap: main.bottomRowMap || '1,2,3,4',
                    // New properties for TFT color strips and row alignment
                    showColorStrips: main.showColorStrips === true,
                    colorStripHeight: main.colorStripHeight || 4,
                    topRowAlign: main.topRowAlign || 0,
                    bottomRowAlign: main.bottomRowAlign || 0,
                    // Battery indicator properties (v1.5)
                    showBattery: main.showBattery === true,
                    batteryX: main.batteryX !== undefined ? main.batteryX : 116,
                    batteryY: main.batteryY !== undefined ? main.batteryY : 0,
                    batteryScale: main.batteryScale || 1
                };
            } else if (previewMode === 'menu') {
                var menu = screens.menu || { headerSize: 1, itemSize: 1, headerY: 0, itemStartY: 14 };
                ts = {
                    label: menu.itemSize || 1,
                    title: menu.headerSize || 1,
                    top: menu.headerY || 0,
                    itemStartY: menu.itemStartY || 14
                };
            } else if (previewMode === 'tap') {
                var tap = screens.tap || { labelSize: 1, bpmSize: 3, patternSize: 1, labelTopY: 0, bpmY: 16, patternY: 46, labelBottomY: 56 };
                ts = {
                    label: tap.labelSize || 1,
                    title: tap.bpmSize || 3,
                    pattern: tap.patternSize || 1,
                    top: tap.labelTopY || 0,
                    bpmY: tap.bpmY || 16,
                    patternY: tap.patternY || 46,
                    bottom: tap.labelBottomY || 56
                };
            } else if (previewMode === 'overlay') {
                var overlay = screens.overlay || { textSize: 2 };
                ts = {
                    title: overlay.textSize || 2,
                    label: overlay.textSize || 2
                };
            } else {
                // Loading or other - use fixed defaults
                ts = { label: 1, title: 2, status: 1, top: 0, bottom: 56 };
            }

            // Loading screen is fixed - enforce it visually if needed, but we let it render fixed regardless of sliders

            // --- OVERLAY MODE (Button/Analog click) ---
            // --- OVERLAY MODE (Button/Analog click) ---
            // If overlay state is active, show centered overlay and skip normal rendering
            if (oledOverlayState.active) {
                logDebug('OLED Overlay: ' + oledOverlayState.label); // Debug
                // Use configured overlay text size from screens.overlay
                var overlayConfig = oled.screens && oled.screens.overlay ? oled.screens.overlay : { textSize: 2 };
                var configSize = overlayConfig.textSize || 2;
                // Preview uses size - 1 (min 1) for more realistic OLED appearance
                // because the canvas is 2x scaled
                var overlaySize = Math.max(1, configSize - 1);
                var charH = 7 * overlaySize;
                var y = Math.floor((h - charH) / 2);
                drawCentered(oledOverlayState.label, y, overlaySize);
                return; // Skip normal rendering
            }

            // --- DRAWING LOGIC BASED ON PREVIEW MODE ---

            if (previewMode === 'menu') {
                // === MENU SCREEN PREVIEW ===
                if (isVertical) {
                    drawText('MENU', 2, ts.top || 2, ts.title);
                    var y = ts.itemStartY || 20;
                    var items = ['Save&Exit', 'No Save', 'WiFi', 'BT Edit', 'LED Bri'];
                    for (var i = 0; i < items.length; i++) {
                        drawText((i === 0 ? '>' : ' ') + items[i].substring(0, 8), 0, y, ts.label);
                        y += ts.label * 8 + 2;
                    }
                } else if (is32) {
                    // Compact
                    drawText('MENU', 0, ts.top || 0, ts.title);
                    drawText('>Save & Exit', 0, ts.itemStartY || 12, ts.label);
                    drawText(' Exit NoSave', 0, (ts.itemStartY || 12) + 10, ts.label);
                } else if (is128 || is160) {
                    // TFT 128x128 or 128x160 - more items visible, larger spacing (matches firmware)
                    drawText('-- Menu CHOCOTONE --', 4, ts.top || 0, ts.title);
                    var items = ['Save and Exit', 'Exit without Saving', 'WiFi LoadCfg (OFF)', 'BT SerialEdit (OFF)', 'LED Bright (On)', 'LED Bright (Dim)', 'Pad Debounce', 'Clear BLE Bonds', 'Reboot'];
                    var startY = 16;  // Matches firmware itemStartY for TFT
                    var itemHeight = 12; // Matches firmware lineHeight for TFT
                    for (var i = 0; i < 9 && i < items.length; i++) {
                        drawText((i === 0 ? '> ' : '  ') + items[i], 0, startY + (i * itemHeight), ts.label);
                    }
                } else {
                    // Standard 128x64
                    drawText('-- Menu CHOCOTONE --', 4, ts.top || 0, ts.title);
                    var items = ['Save and Exit', 'Exit without Saving', 'WiFi LoadCfg (OFF)', 'BT SerialEdit (OFF)', 'LED Bright (On)'];
                    var startY = ts.itemStartY || 14;
                    var itemHeight = ts.label * 8 + 2;
                    for (var i = 0; i < 5 && i < items.length; i++) {
                        drawText((i === 0 ? '> ' : '  ') + items[i], 0, startY + (i * itemHeight), ts.label);
                    }
                }
            } else if (previewMode === 'tap') {
                // === TAP TEMPO PREVIEW ===
                if (isVertical) {
                    drawText('NEXT', 2, ts.top || 2, ts.label);
                    drawText('LOCK', 40, ts.top || 2, ts.label);
                    drawCentered('120', ts.bpmY || 30, ts.title);
                    drawText('P:1/4', 2, ts.patternY || 50, ts.pattern || ts.label);
                    drawText('500ms', 2, (ts.patternY || 50) + 10, ts.pattern || ts.label);
                    drawText('PREV', 2, ts.bottom || 118, ts.label);
                    drawText('TAP', 40, ts.bottom || 118, ts.label);
                } else if (is32) {
                    drawText('NXT', 0, ts.top || 0, ts.label);
                    drawText('LCK', 110, ts.top || 0, ts.label);
                    drawCentered('120.0', ts.bpmY || 10, ts.title);
                    drawText('PRV', 0, ts.bottom || 24, ts.label);
                    drawText('TAP', 110, ts.bottom || 24, ts.label);
                } else if (is128) {
                    // TFT 128x128 - scaled positions matching firmware
                    var topY = 10;    // Matches firmware topRowY for TFT
                    var bpmYPos = 40;  // Matches firmware bpmY for TFT
                    var patY = 80;     // Matches firmware patternY for TFT
                    var botY = 110;    // Matches firmware bottomRowY for TFT
                    var bpmSz = Math.max(4, ts.title); // Larger BPM text for TFT

                    drawText('NEXT', 0, topY, ts.label);
                    drawText('LOCKED', 80, topY, ts.label);

                    // Larger BPM centered
                    var bpm = "120.0";
                    var bpmW = textWidth(bpm, bpmSz);
                    drawText(bpm, (w - bpmW) / 2, bpmYPos, bpmSz);

                    // Pattern row
                    drawText('Pattern: 1/4', 0, patY, ts.pattern || ts.label);
                    var ms = "500ms";
                    drawText(ms, w - textWidth(ms, ts.pattern || ts.label) - 2, patY, ts.pattern || ts.label);

                    // Bottom labels
                    drawText('PREV', 0, botY, ts.label);
                    drawText('TAP', 100, botY, ts.label);
                } else {
                    // Standard 128x64
                    drawText('NEXT', 0, ts.top || 0, ts.label);
                    drawText('LOCK', 90, ts.top || 0, ts.label);

                    // BPM logic with configurable size and Y
                    var bpm = "120.0";
                    var bpmW = textWidth(bpm, ts.title);
                    drawText(bpm, (w - bpmW) / 2, ts.bpmY || 16, ts.title);

                    // Pattern row
                    var patY = ts.patternY || 46;
                    drawText('Pattern: 1/4', 0, patY, ts.pattern || ts.label);
                    var ms = "500ms";
                    drawText(ms, w - textWidth(ms, ts.pattern || ts.label) - 2, patY, ts.pattern || ts.label);

                    // Bottom labels
                    drawText('PREV', 0, ts.bottom || 56, ts.label);
                    drawText('TAP', 100, ts.bottom || 56, ts.label);
                }
            } else if (previewMode === 'overlay') {
                // === BUTTON OVERLAY PREVIEW ===
                // Shows a large button name (e.g. "DRIVE") overlaying the screen
                var label = "OVERLAY";
                var configSize = ts.title || 2;
                var overlaySize = Math.max(1, configSize - 1); // Compensate for 2x scale

                if (isVertical) {
                    var th = overlaySize * 8;
                    drawCentered('BTN', h / 2 - th, overlaySize);
                    drawCentered('NAME', h / 2 + 2, overlaySize);
                } else {
                    var th = overlaySize * 8;
                    var y = (h - th) / 2;
                    drawCentered(label, y, overlaySize);
                }

            } else if (previewMode === 'loading') {
                // === LOADING SCREEN PREVIEW ===
                if (isVertical) {
                    // ... (existing vertical logic is fine as it uses cx/y)
                    var y = 2;
                    var cx = w / 2;
                    // Top Dots
                    for (var i = 0; i < 3; i++) drawFilledCircle(cx, y + (i * 6), 1);
                    y += 24;
                    drawCentered('CHOCO', y, 2); y += 18;
                    drawCentered('TONE', y, 2); y += 18;
                    drawCentered('MIDI', y, 1); y += 10;
                    drawCentered('by', y, 1); y += 9;
                    drawCentered('Andre', y, 1); y += 9;
                    drawCentered('Solis', y, 1); y += 14;
                    drawFilledRoundRect(cx - 15, y, 30, 9, 2);
                    drawInvertedText('v1.5b', cx - 14, y + 1, 1); y += 14;
                    for (var i = 0; i < 3; i++) drawFilledCircle(cx, y + (i * 6), 1);
                } else if (is32) {
                    drawText('CHOCOTONE', 0, 10, 1);
                    drawText('v1.5b', 90, 10, 1);
                } else {
                    // STANDARD HORIZONTAL (64 or 128)
                    var centerY = (h / 2);
                    var title = "CHOCOTONE";
                    drawCentered(title, centerY - 20, 2);
                    var sub = "MIDI by ANDRE SOLIS";
                    drawCentered(sub, centerY, 1);

                    // Dots
                    var dotsY = centerY + 15;
                    for (var r = 0; r < 2; r++) {
                        for (var c = 0; c < 4; c++) {
                            var dx = (w / 2 - 16) + c * 8;
                            var dy = dotsY + r * 8;
                            drawCircle(dx, dy, 2);
                            if (r === 0) drawFilledCircle(dx, dy, 2);
                        }
                    }
                    drawInvertedText('v1.5b', w - 32, dotsY + 1, 1);
                }
            } else {
                // === MAIN SCREEN PREVIEW (Default) ===

                // Get preset and button data
                var preset = presetData.presets[presetData.currentPreset];
                var presetName = preset ? preset.name : 'PRESET';
                var buttonCount = presetData.system.buttonCount || 8;
                var buttons = preset ? preset.buttons : [];

                // Get all button labels (legacy fallback)
                var allLabels = [];
                for (var i = 0; i < buttonCount; i++) {
                    allLabels.push(buttons[i] ? buttons[i].name.substring(0, 4).toUpperCase() : 'B' + (i + 1));
                }

                // Helper function to parse row map and get labels
                function parseRowMap(mapStr, buttons, analogInputs) {
                    if (!mapStr || mapStr.trim() === '') return [];
                    var items = mapStr.split(',').map(function (s) { return s.trim(); });
                    var labels = [];
                    for (var i = 0; i < items.length; i++) {
                        var item = items[i].toUpperCase();
                        if (item.indexOf('A') === 0 && item.length > 1) {
                            // Analog input (e.g., A1, A2)
                            var aIdx = parseInt(item.substring(1)) - 1;
                            if (analogInputs && analogInputs[aIdx] && analogInputs[aIdx].enabled) {
                                labels.push((analogInputs[aIdx].name || item).substring(0, 4).toUpperCase());
                            } else {
                                labels.push(item.substring(0, 4));
                            }
                        } else {
                            // Button number (1-based)
                            var bIdx = parseInt(item) - 1;
                            if (buttons && buttons[bIdx]) {
                                labels.push(buttons[bIdx].name.substring(0, 4).toUpperCase());
                            } else if (!isNaN(bIdx) && bIdx >= 0) {
                                labels.push('B' + (bIdx + 1));
                            } else {
                                labels.push(item.substring(0, 4));
                            }
                        }
                    }
                    return labels;
                }

                // Enhanced version that also returns button RGB colors for color strip feature
                function parseRowMapWithColors(mapStr, buttons, analogInputs) {
                    if (!mapStr || mapStr.trim() === '') return { labels: [], colors: [], percents: [], isAnalog: [] };
                    var items = mapStr.split(',').map(function (s) { return s.trim(); });
                    var labels = [];
                    var colors = [];
                    var percents = []; // For analog loading bar effect
                    var isAnalog = []; // Track which items are analog inputs
                    for (var i = 0; i < items.length; i++) {
                        var item = items[i].toUpperCase();
                        if (item.indexOf('A') === 0 && item.length > 1) {
                            // Analog input - use configured RGB color
                            var aIdx = parseInt(item.substring(1)) - 1;
                            if (analogInputs && analogInputs[aIdx] && analogInputs[aIdx].enabled) {
                                labels.push((analogInputs[aIdx].name || item).substring(0, 4).toUpperCase());
                                // Use analog input's RGB color, fallback to cyan
                                colors.push(analogInputs[aIdx].rgb || '#00ffff');
                            } else {
                                labels.push(item.substring(0, 4));
                                colors.push('#00ffff');
                            }
                            // Analog inputs show as loading bar - simulate 50% for preview
                            percents.push(0.5);
                            isAnalog.push(true);
                        } else {
                            // Button number (1-based)
                            var bIdx = parseInt(item) - 1;
                            if (buttons && buttons[bIdx]) {
                                labels.push(buttons[bIdx].name.substring(0, 4).toUpperCase());
                                // Get color from first message RGB
                                var rgb = '#ffffff'; // default white
                                if (buttons[bIdx].messages && buttons[bIdx].messages[0] && buttons[bIdx].messages[0].rgb) {
                                    rgb = buttons[bIdx].messages[0].rgb;
                                }
                                colors.push(rgb);
                            } else if (!isNaN(bIdx) && bIdx >= 0) {
                                labels.push('B' + (bIdx + 1));
                                colors.push('#ffffff');
                            } else {
                                labels.push(item.substring(0, 4));
                                colors.push('#ffffff');
                            }
                            // Buttons show full-width strip (100%)
                            percents.push(1.0);
                            isAnalog.push(false);
                        }
                    }
                    return { labels: labels, colors: colors, percents: percents, isAnalog: isAnalog };
                }

                // Get mapped labels for top and bottom rows
                var topRowLabels = parseRowMap(ts.topRowMap, buttons, presetData.analogInputs);
                var bottomRowLabels = parseRowMap(ts.bottomRowMap, buttons, presetData.analogInputs);

                if (isVertical) {
                    // VERTICAL ORIENTATION (90Â°/270Â°)
                    var lineHeight = ts.label * 8 + 2;
                    var y = ts.top || 0;
                    var maxChars = is32 ? 4 : 8;

                    // Title with alignment support
                    var titleAlign = ts.titleAlign !== undefined ? ts.titleAlign : 1;
                    if (titleAlign === 0) {
                        drawText(presetName.substring(0, maxChars), 1, y, ts.title || 1);
                    } else if (titleAlign === 2) {
                        var tw = textWidth(presetName.substring(0, maxChars), ts.title || 1);
                        drawText(presetName.substring(0, maxChars), w - tw - 1, y, ts.title || 1);
                    } else {
                        var tw = textWidth(presetName.substring(0, maxChars), ts.title || 1);
                        drawText(presetName.substring(0, maxChars), (w - tw) / 2, y, ts.title || 1);
                    }
                    y += (ts.title || 1) * 8 + 2;

                    // BPM with bpmSize
                    if (ts.showBpm !== false) {
                        var bpmSize = ts.bpmSize || 1;
                        drawText('120.0', 1, y, bpmSize);
                        y += bpmSize * 8 + 2;
                    }
                    if (ts.showAnalog) {
                        var analogCount = presetData.system.analogInputCount || 2;
                        var maxAnalogShow = is32 ? 2 : 4;
                        for (var ai = 0; ai < Math.min(analogCount, maxAnalogShow) && y < h - 20; ai++) {
                            drawText('a' + (ai + 1) + '.' + (127 - ai * 30), 1, y, ts.status || 1);
                            y += (ts.status || 1) * 8 + 2;
                        }
                    }
                    // Status line (conditional on showStatus)
                    if (String(ts.showStatus) !== 'false') {
                        drawText('BL:CL', 1, y, ts.status || 1);
                        y += (ts.status || 1) * 8 + 4;
                    }

                    // Button labels (vertical shows all in one column using mapped labels)
                    var combinedLabels = [];
                    if (ts.showTopRow !== false) combinedLabels = combinedLabels.concat(topRowLabels);
                    if (ts.showBottomRow !== false) combinedLabels = combinedLabels.concat(bottomRowLabels);

                    for (var i = 0; i < combinedLabels.length && y < h - 8; i++) {
                        drawText(combinedLabels[i].substring(0, maxChars), 1, y, ts.label || 1);
                        y += lineHeight;
                    }
                } else if (is32) {
                    // 128x32 COMPACT HORIZONTAL
                    var buttonsPerRow = Math.min(Math.ceil(buttonCount / 2), 4);
                    var topRowStart = Math.floor(buttonCount / 2);
                    var colWidth = Math.floor(w / buttonsPerRow);

                    // Top row (conditional) - use mapped labels
                    if (ts.showTopRow !== false && topRowLabels.length > 0) {
                        var colWidth32 = w / topRowLabels.length;
                        for (var i = 0; i < topRowLabels.length; i++) {
                            drawText(topRowLabels[i], i * colWidth32, ts.top || 0, ts.label || 1);
                        }
                    }

                    // Center row - title with alignment
                    var centerY = ts.titleY || 11;
                    var titleAlign = ts.titleAlign !== undefined ? ts.titleAlign : 1;
                    var titleText = presetName.substring(0, 6);
                    if (titleAlign === 0) {
                        drawText(titleText, 0, centerY, ts.title || 1);
                    } else if (titleAlign === 2) {
                        var tw = textWidth(titleText, ts.title || 1);
                        drawText(titleText, w - tw, centerY, ts.title || 1);
                    } else {
                        var tw = textWidth(titleText, ts.title || 1);
                        drawText(titleText, (w - tw) / 2, centerY, ts.title || 1);
                    }

                    // BPM (uses bpmSize) - right aligned or aligned per config
                    if (ts.showBpm !== false) {
                        var bpmText = '120.0';
                        var bpmSize = ts.bpmSize || 1;
                        var bpmAlign = ts.bpmAlign !== undefined ? ts.bpmAlign : 2; // Default right for 32
                        if (bpmAlign === 0) {
                            drawText(bpmText, 0, centerY, bpmSize);
                        } else if (bpmAlign === 2) {
                            drawText(bpmText, w - textWidth(bpmText, bpmSize) - 2, centerY, bpmSize);
                        } else {
                            var bw = textWidth(bpmText, bpmSize);
                            drawText(bpmText, (w - bw) / 2, centerY, bpmSize);
                        }
                    }

                    // Bottom row (conditional) - use mapped labels
                    if (ts.showBottomRow !== false && bottomRowLabels.length > 0) {
                        var colWidth32 = w / bottomRowLabels.length;
                        for (var i = 0; i < bottomRowLabels.length; i++) {
                            drawText(bottomRowLabels[i], i * colWidth32, ts.bottom || 24, ts.label || 1);
                        }
                    }
                } else {
                    // STANDARD 128x64 HORIZONTAL
                    var topRowY = ts.top !== undefined ? ts.top : 0;
                    var presetY = ts.titleY !== undefined ? ts.titleY : 14;
                    var bpmY = ts.bpmY !== undefined ? ts.bpmY : 32;
                    var bleY = (ts.statusY !== undefined ? ts.statusY : 44);
                    var bottomRowY = ts.bottom !== undefined ? ts.bottom : 56;

                    var colWidth = w / Math.max(topRowLabels.length, bottomRowLabels.length, 4);

                    // Get color data for TFT color strips
                    var topRowData = parseRowMapWithColors(ts.topRowMap, buttons, presetData.analogInputs);
                    var bottomRowData = parseRowMapWithColors(ts.bottomRowMap, buttons, presetData.analogInputs);
                    var topRowAlign = ts.topRowAlign || 0; // 0=Left, 1=Center, 2=Right
                    var bottomRowAlign = ts.bottomRowAlign || 0;
                    var labelHeight = (ts.label || 1) * 8;
                    var stripHeight = ts.colorStripHeight || 4; // Height of color strip (configurable)

                    // Simple column width calculation (equal spacing)
                    var topColWidth = topRowLabels.length > 0 ? w / topRowLabels.length : 32;
                    var bottomColWidth = bottomRowLabels.length > 0 ? w / bottomRowLabels.length : 32;

                    // Top row labels (conditional on showTopRow)
                    if (ts.showTopRow !== false && topRowLabels.length > 0) {
                        for (var i = 0; i < topRowLabels.length; i++) {
                            var labelText = topRowLabels[i];
                            var textWidthPx = textWidth(labelText, ts.label);
                            var colStart = i * topColWidth;
                            var textX = colStart; // Default: left align
                            if (topRowAlign === 1) {
                                textX = colStart + (topColWidth - textWidthPx) / 2; // Center
                            } else if (topRowAlign === 2) {
                                textX = colStart + topColWidth - textWidthPx; // Right
                            }
                            drawText(labelText, textX, topRowY, ts.label);
                            // Draw color strip BELOW label for top row (TFT only)
                            if (ts.showColorStrips && (is128 || is160) && topRowData.colors[i]) {
                                ctx.fillStyle = topRowData.colors[i];
                                var stripW = (topColWidth - 2) * (topRowData.percents[i] || 1.0);
                                ctx.fillRect(colStart * scale, (topRowY + labelHeight + 1) * scale, stripW * scale, stripHeight * scale);
                            }
                        }
                    }
                    // Bottom row labels (conditional on showBottomRow)
                    if (ts.showBottomRow !== false && bottomRowLabels.length > 0) {
                        for (var i = 0; i < bottomRowLabels.length; i++) {
                            var labelText = bottomRowLabels[i];
                            var textWidthPx = textWidth(labelText, ts.label);
                            var colStart = i * bottomColWidth;
                            var textX = colStart; // Default: left align
                            if (bottomRowAlign === 1) {
                                textX = colStart + (bottomColWidth - textWidthPx) / 2; // Center
                            } else if (bottomRowAlign === 2) {
                                textX = colStart + bottomColWidth - textWidthPx; // Right
                            }
                            drawText(labelText, textX, bottomRowY, ts.label);
                            // Draw color strip ABOVE label for bottom row (TFT only)
                            if (ts.showColorStrips && (is128 || is160) && bottomRowData.colors[i]) {
                                ctx.fillStyle = bottomRowData.colors[i];
                                var stripW = (bottomColWidth - 2) * (bottomRowData.percents[i] || 1.0);
                                ctx.fillRect(colStart * scale, (bottomRowY - stripHeight - 1) * scale, stripW * scale, stripHeight * scale);
                            }
                        }
                    }

                    // Preset Name with alignment (0=Left, 1=Center, 2=Right)
                    var presetAlign = ts.titleAlign !== undefined ? ts.titleAlign : 1;
                    if (presetAlign === 0) {
                        drawText(presetName, 0, presetY, ts.title);
                    } else if (presetAlign === 2) {
                        var pw = textWidth(presetName, ts.title);
                        drawText(presetName, w - pw, presetY, ts.title);
                    } else {
                        drawCentered(presetName, presetY, ts.title);
                    }

                    // BPM with separate size, Y position, and alignment
                    if (ts.showBpm !== false) {
                        var bpmText = '120.0 BPM';
                        var bpmSize = ts.bpmSize || 1;
                        var bpmAlign = ts.bpmAlign !== undefined ? ts.bpmAlign : 1;
                        if (bpmAlign === 0) {
                            drawText(bpmText, 0, bpmY, bpmSize);
                        } else if (bpmAlign === 2) {
                            var bpmW = textWidth(bpmText, bpmSize);
                            drawText(bpmText, w - bpmW, bpmY, bpmSize);
                        } else {
                            drawCentered(bpmText, bpmY, bpmSize);
                        }
                    }

                    // Status line with alignment (0=Left, 1=Center, 2=Right)
                    if (String(ts.showStatus) !== 'false') {
                        var statusSize = ts.status || ts.subtitle || 1;
                        var statusAlign = ts.statusAlign !== undefined ? ts.statusAlign : 0;

                        var bleMode = (presetData.system.bleMode || 'CLIENT');
                        var bleSuffix = (bleMode === 'CLIENT' || bleMode === 'DUAL') ? ' Scanning' : '';
                        var statusText = ts.showAnalog ? 'A1:127 A2:64' : ('BLE:' + bleMode + bleSuffix);

                        if (statusAlign === 0) {
                            drawText(statusText, 0, bleY, statusSize);
                        } else if (statusAlign === 2) {
                            var sw = textWidth(statusText, statusSize);
                            drawText(statusText, w - sw, bleY, statusSize);
                        } else {
                            drawCentered(statusText, bleY, statusSize);
                        }
                    }

                    // Battery indicator (v1.5) - configurable position and scale
                    if (ts.showBattery) {
                        var battScale = ts.batteryScale || 1;
                        var battX = ts.batteryX !== undefined ? ts.batteryX : (w - 15 * battScale - 2);
                        var battY = ts.batteryY !== undefined ? ts.batteryY : 0;
                        var battW = 13 * battScale;  // Wider battery
                        var battH = 7 * battScale;
                        var tipW = 2 * battScale;
                        var tipH = 3 * battScale;
                        var segW = 3 * battScale;    // 3px segments
                        var segH = 5 * battScale;
                        // Use white for OLED, green for TFT
                        var battColor = (is128 || is160) ? '#22c55e' : '#ffffff';
                        // Draw battery outline
                        ctx.strokeStyle = battColor;
                        ctx.lineWidth = 1 * scale;
                        ctx.strokeRect(battX * scale, battY * scale, battW * scale, battH * scale);
                        // Draw battery tip
                        ctx.fillStyle = battColor;
                        ctx.fillRect((battX + battW) * scale, (battY + (battH - tipH) / 2) * scale, tipW * scale, tipH * scale);
                        // Draw 3 filled segments first (75% demo)
                        for (var seg = 0; seg < 3; seg++) {
                            var segX = battX + 1 + (seg * segW);
                            ctx.fillRect(segX * scale, (battY + 1) * scale, segW * scale, segH * scale);
                        }
                        // Draw black partition lines on top (3 lines for 4 divisions)
                        ctx.fillStyle = '#000000';
                        for (var line = 1; line < 4; line++) {
                            var lineX = battX + (line * segW);
                            ctx.fillRect(lineX * scale, (battY + 1) * scale, 1 * scale, segH * scale);
                        }
                    }
                }
            }
        }
        function checkBrightnessWarning() {
            var sys = presetData.system;
            if (warn) warn.style.display = ((sys.brightness || 220) > 240 || (sys.brightnessDim || 20) > 240 || (sys.brightnessTap !== undefined ? sys.brightnessTap : 255) > 240) ? 'block' : 'none';
        }

        // TFT SPI Pin Conflict Resolution
        function resolveSpiPinConflicts() {
            var sys = presetData.system;
            var oledType = sys.oled ? sys.oled.type : '128x64';
            if (oledType !== '128x128' && oledType !== '128x160') return; // Only TFT uses SPI

            // TFT SPI pins (default: CS=15, DC=2, RST=4, MOSI=23, SCLK=18, LED=32)
            var tftPins = [15, 2, 4, 23, 18, 32];
            var safePins = [12, 13, 14, 25, 26, 27, 33];
            var warnings = [];

            // Find available pin
            function findAvailablePin() {
                for (var i = 0; i < safePins.length; i++) {
                    var pin = safePins[i];
                    if (tftPins.indexOf(pin) === -1 &&
                        pin !== sys.encoderA && pin !== sys.encoderB &&
                        pin !== sys.encoderBtn && pin !== sys.ledPin) {
                        return pin;
                    }
                }
                return 33; // fallback
            }

            // Check encoder A
            if (tftPins.indexOf(sys.encoderA) !== -1) {
                var oldPin = sys.encoderA;
                sys.encoderA = findAvailablePin();
                warnings.push('Encoder A: GPIO ' + oldPin + ' â†’ ' + sys.encoderA);
            }
            // Check encoder B  
            if (tftPins.indexOf(sys.encoderB) !== -1) {
                var oldPin = sys.encoderB;
                sys.encoderB = findAvailablePin();
                warnings.push('Encoder B: GPIO ' + oldPin + ' â†’ ' + sys.encoderB);
            }
            // Check encoder BTN
            if (tftPins.indexOf(sys.encoderBtn) !== -1) {
                var oldPin = sys.encoderBtn;
                sys.encoderBtn = findAvailablePin();
                warnings.push('Encoder BTN: GPIO ' + oldPin + ' â†’ ' + sys.encoderBtn);
            }
            // Check LED pin
            if (tftPins.indexOf(sys.ledPin) !== -1) {
                var oldPin = sys.ledPin;
                sys.ledPin = findAvailablePin();
                warnings.push('LED Pin: GPIO ' + oldPin + ' â†’ ' + sys.ledPin);
            }

            if (warnings.length > 0) {
                alert('âš ï¸ TFT SPI Pin Conflicts Detected!\n\nThe following pins conflict with TFT display and have been auto-reassigned:\n\n' + warnings.join('\n') + '\n\nTFT uses GPIO: 15 (CS), 18 (SCLK), 23 (MOSI), 2 (DC), 4 (RST), 32 (LED)');
                render(); // Update UI with new values
            }
        }

        function updSys(k, v) { presetData.system[k] = v; }

        function updGlobalAction(idx, key, value) {
            if (!presetData.system.globalSpecialActions) {
                presetData.system.globalSpecialActions = [];
            }
            while (presetData.system.globalSpecialActions.length <= idx) {
                presetData.system.globalSpecialActions.push({ enabled: false, partner: -1, type: 'OFF', label: '', action: 'COMBO' });
            }

            // Handle 'action' field from regular cards being pasted/set
            if (key === 'action') {
                // If it's a global action, 'action' MUST be 'COMBO' in the firmware sense, 
                // but we let the user select between PRESS/COMBO etc in the UI? 
                // Actually, Global actions ARE combos by definition in this device.
                // However, for consistency with regular cards, we store it.
            }

            presetData.system.globalSpecialActions[idx][key] = value;
            if (key === 'type' || key === 'enabled' || key === 'action') render();
        }

        function toggleGlobalAction(idx) {
            if (!presetData.system.globalSpecialActions) {
                presetData.system.globalSpecialActions = [];
            }
            while (presetData.system.globalSpecialActions.length <= idx) {
                presetData.system.globalSpecialActions.push({ enabled: false, partner: -1, type: 'OFF', label: '', action: 'COMBO' });
            }
            presetData.system.globalSpecialActions[idx].enabled = !presetData.system.globalSpecialActions[idx].enabled;
            // Ensure global actions always have 'COMBO' action type if not set
            if (!presetData.system.globalSpecialActions[idx].action) presetData.system.globalSpecialActions[idx].action = 'COMBO';
            render();
        }

        function applyGlobalSysexPreset(idx, val) {
            var hex = SYSEX_PRESETS[val];
            if (hex) updGlobalAction(idx, 'sysex', hex);
        }

        // Clipboard for global actions
        // var globalActionClipboard = null; // This is now unified with actionClipboard

        function copyGlobalAction(idx) {
            var action = presetData.system.globalSpecialActions[idx];
            actionClipboard = JSON.parse(JSON.stringify(action));
            alert('Global action copied from Button ' + (idx + 1));
        }

        function pasteGlobalAction(idx) {
            if (!actionClipboard) {
                alert('Nothing to paste. Copy an action first.');
                return;
            }
            var clip = JSON.parse(JSON.stringify(actionClipboard));
            // When pasting into global, enable it and ensure partner is managed
            clip.enabled = true;
            if (clip.partner === undefined) clip.partner = -1;
            presetData.system.globalSpecialActions[idx] = clip;
            render();
        }

        function deleteGlobalAction(idx) {
            presetData.system.globalSpecialActions[idx] = { enabled: false, partner: -1, type: 'OFF', label: '', action: 'COMBO' };
            render();
        }

        function updExp(idx, k, v) {
            if (!presetData.expressionPedals) return;
            presetData.expressionPedals[idx][k] = v;
            render();
        }
        function saveChanges() {
            // In offline mode, save means export to JSON area
            exportJSON();
            render();  // Update buttons selection UI with new values
            alert('Changes saved! JSON has been updated in the Export area below.');
        }
        function updBtnCount(count) {
            presetData.system.buttonCount = count;
            for (var p = 0; p < presetData.presets.length; p++) {
                var btns = presetData.presets[p].buttons;
                while (btns.length < count) btns.push(createDefaultButton(btns.length));
                while (btns.length > count) btns.pop();
            }
            if (selectedBtn >= count) selectedBtn = count - 1;
            render();
        }
        function createDefaultButton(idx) {
            var colors = ['#ff6b6b', '#feca57', '#48dbfb', '#1dd1a1', '#5f27cd', '#ff9ff3', '#54a0ff', '#00d2d3'];
            var c = colors[idx % colors.length];
            return {
                name: 'BTN' + (idx + 1), ledMode: 'MOMENTARY', inSelectionGroup: false,
                messages: [{ action: 'PRESS', type: 'CC', channel: 1, data1: 20 + idx, data2: 127, rgb: c }]
            };
        }

        // Prepare config for export - optimize size by removing defaults and disabled items
        // This significantly reduces config size and memory usage on the controller
        function prepareExportData() {
            var exportData = JSON.parse(JSON.stringify(presetData)); // Deep clone

            // Optimize button messages - remove fields that are defaults or unused
            if (exportData.presets) {
                for (var p = 0; p < exportData.presets.length; p++) {
                    var preset = exportData.presets[p];
                    if (!preset.buttons) continue;

                    // Strip preset-level defaults
                    if (preset.presetLedMode === 'NORMAL') delete preset.presetLedMode;
                    if (!preset.syncMode || preset.syncMode === 'NONE') delete preset.syncMode;

                    for (var b = 0; b < preset.buttons.length; b++) {
                        var btn = preset.buttons[b];

                        // Strip button-level defaults
                        if (btn.inSelectionGroup === false) delete btn.inSelectionGroup;
                        if (btn.ledMode === 'MOMENTARY') delete btn.ledMode;

                        if (!btn.messages) continue;
                        for (var m = 0; m < btn.messages.length; m++) {
                            var msg = btn.messages[m];
                            // Remove analog-only fields (useless for buttons)
                            delete msg.inMin;
                            delete msg.inMax;
                            delete msg.min;
                            delete msg.max;
                            // Remove empty/default values
                            if (msg.label === '' || msg.label === undefined) delete msg.label;
                            if (msg.partner === 0 || msg.partner === undefined) delete msg.partner;
                            if (msg.channel === 1) delete msg.channel;  // Default channel
                            if (msg.data1 === 0) delete msg.data1;
                            if (msg.data2 === 0) delete msg.data2;
                            if (msg.holdMs === 500 || msg.holdMs === undefined) delete msg.holdMs;
                            if (msg.rhythmPrev === 0) delete msg.rhythmPrev;
                            if (msg.rhythmNext === 0) delete msg.rhythmNext;
                            if (msg.tapLock === 0) delete msg.tapLock;
                        }
                    }
                }
            }

            // Filter analog inputs - only include enabled ones with their index
            if (exportData.analogInputs) {
                // Map sysexParam string to numeric ID for firmware (device-agnostic)
                var sysexParamToId = {
                    'PITCH - HIGH': 1,
                    'DRV - GAIN': 2
                };

                exportData.analogInputs = exportData.analogInputs
                    .map(function (inp, idx) {
                        if (!inp.enabled) return null;

                        // Strip analog input defaults
                        if (inp.source === 'gpio') delete inp.source;
                        if (inp.actionType === 'linear_linear' || inp.actionType === 'linear') delete inp.actionType;
                        if (inp.inverted === false) delete inp.inverted;
                        if (inp.ledIndex === -1 || inp.ledIndex === undefined) delete inp.ledIndex;
                        if (inp.inputMode === 0) delete inp.inputMode;
                        if (inp.emaAlpha === 0.15) delete inp.emaAlpha;
                        if (inp.hysteresis === 2) delete inp.hysteresis;
                        if (inp.minVal === 0) delete inp.minVal;
                        if (inp.maxVal === 4095) delete inp.maxVal;
                        if (inp.actionOptions && Object.keys(inp.actionOptions).length === 0) delete inp.actionOptions;
                        delete inp.enabled; // Already filtered, no need to include

                        // Process messages - strip defaults
                        if (inp.messages) {
                            for (var m = 0; m < inp.messages.length; m++) {
                                var msg = inp.messages[m];
                                // Force data1 for SYSEX_SCROLL (currently only PITCH_HIGH=1)
                                if (msg.type === 'SYSEX_SCROLL') {
                                    console.log('SYSEX_SCROLL export: sysexParam=', msg.sysexParam);
                                    // Convert sysexParam to data1, or default to 1 (PITCH_HIGH)
                                    msg.data1 = msg.sysexParam ? (sysexParamToId[msg.sysexParam] || 1) : 1;
                                    delete msg.sysexParam;
                                }
                                if (msg.channel === 1) delete msg.channel;
                                if (msg.data1 === 0) delete msg.data1;
                                if (msg.data2 === 0) delete msg.data2;
                                if (msg.min === 0) delete msg.min;
                                if (msg.max === 127) delete msg.max;
                                if (msg.inMin === 0) delete msg.inMin;
                                if (msg.inMax === 100) delete msg.inMax;
                            }
                        }

                        return Object.assign({ index: idx }, inp);
                    })
                    .filter(function (inp) { return inp !== null; });
            }

            // Optimize system section - strip defaults
            if (exportData.system) {
                var sys = exportData.system;

                // Remove disabled multiplexer entirely
                if (sys.multiplexer && !sys.multiplexer.enabled) {
                    delete sys.multiplexer;
                }

                // Strip system-level defaults
                if (sys.brightness === 255) delete sys.brightness;
                if (sys.brightnessDim === 20) delete sys.brightnessDim;
                if (sys.fsrThreshold === 100) delete sys.fsrThreshold;
                if (sys.debugAnalogIn === false) delete sys.debugAnalogIn;
                if (sys.ledsPerButton === 1) delete sys.ledsPerButton;

                // Strip OLED screen defaults to save significant space
                if (sys.oled && sys.oled.screens) {
                    var screens = sys.oled.screens;

                    // Remove entire screen sections if they're all defaults
                    // Main screen - strip common defaults
                    if (screens.main) {
                        var m = screens.main;
                        if (m.labelSize === 1) delete m.labelSize;
                        if (m.titleSize === 2) delete m.titleSize;
                        if (m.statusSize === 1) delete m.statusSize;
                        if (m.bpmSize === 1) delete m.bpmSize;
                        if (m.titleAlign === 1) delete m.titleAlign;
                        if (m.statusAlign === 0) delete m.statusAlign;
                        if (m.bpmAlign === 1) delete m.bpmAlign;
                        if (m.bottomRowAlign === 0) delete m.bottomRowAlign;
                        if (m.topRowAlign === 0) delete m.topRowAlign;
                        if (m.showBpm === true) delete m.showBpm;
                        if (m.showAnalog === false) delete m.showAnalog;
                        if (m.showTopRow === true) delete m.showTopRow;
                        if (m.showBottomRow === true) delete m.showBottomRow;
                        if (m.showColorStrips === false) delete m.showColorStrips;
                        if (m.showBattery === false) delete m.showBattery;
                        if (m.showStatus === true) delete m.showStatus;
                        if (m.colorStripHeight === 4) delete m.colorStripHeight;
                    }

                    // Menu screen defaults
                    if (screens.menu) {
                        var menu = screens.menu;
                        if (menu.headerSize === 1) delete menu.headerSize;
                        if (menu.itemSize === 1) delete menu.itemSize;
                        if (menu.headerY === 0) delete menu.headerY;
                        if (menu.itemStartY === 14) delete menu.itemStartY;
                        if (Object.keys(menu).length === 0) delete screens.menu;
                    }

                    // Tap screen defaults
                    if (screens.tap) {
                        var tap = screens.tap;
                        if (tap.labelSize === 1) delete tap.labelSize;
                        if (tap.bpmSize === 3) delete tap.bpmSize;
                        if (tap.patternSize === 1) delete tap.patternSize;
                        if (tap.labelTopY === 0) delete tap.labelTopY;
                        if (tap.bpmY === 16) delete tap.bpmY;
                        if (tap.patternY === 46) delete tap.patternY;
                        if (tap.labelBottomY === 56) delete tap.labelBottomY;
                        if (Object.keys(tap).length === 0) delete screens.tap;
                    }

                    // Overlay screen defaults  
                    if (screens.overlay) {
                        var ov = screens.overlay;
                        if (ov.textSize === 2) delete ov.textSize;
                        if (Object.keys(ov).length === 0) delete screens.overlay;
                    }
                }

                // Strip OLED pin defaults for common configs
                if (sys.oled) {
                    if (sys.oled.rotation === 0) delete sys.oled.rotation;
                }
            }

            // Filter global special actions - only include enabled ones with their index
            if (exportData.system && exportData.system.globalSpecialActions) {
                exportData.system.globalSpecialActions = exportData.system.globalSpecialActions
                    .map(function (act, idx) {
                        // Put act first, then override with correct index (idx is array position)
                        return act && act.enabled ? Object.assign({}, act, { index: idx }) : null;
                    })
                    .filter(function (act) { return act !== null; });
            }

            return exportData;
        }

        function exportJSON() {
            presetData.lastModified = new Date().toISOString().slice(0, 19).replace('T', ' ');
            var exportData = prepareExportData();
            var jsonStr = JSON.stringify(exportData, null, 2);
            render(); // Update UI to show new timestamp (rebuilds DOM)
            document.getElementById('jsonArea').value = jsonStr; // Restore JSON after render
        }
        function importJSON() {
            try {
                var data = JSON.parse(document.getElementById('jsonArea').value);
                if (data.presets) {
                    // Preserve configName and lastModified
                    var savedConfigName = presetData.configName;
                    var savedLastModified = presetData.lastModified;
                    presetData = normalizeConfigData(data); // Auto-update older versions
                    // Restore if not present in imported data
                    if (!data.configName) presetData.configName = savedConfigName;
                    if (!data.lastModified) presetData.lastModified = savedLastModified;
                    selectedBtn = 0;
                    showSystem = false;
                    render();
                    alert('Imported & Updated!\n\nConfig: ' + (presetData.configName || 'Unnamed') + '\nLast Modified: ' + (presetData.lastModified || 'Unknown'));
                } else alert('Invalid format');
            } catch (e) { alert('Error: ' + e.message); }
        }
        function copyJSON() { exportJSON(); navigator.clipboard.writeText(document.getElementById('jsonArea').value); alert('Copied!'); }
        function downloadJSON() {
            exportJSON();
            var filename = (presetData.configName || 'chocotone_config').replace(/[^a-zA-Z0-9_-]/g, '_') + '.json';
            var blob = new Blob([document.getElementById('jsonArea').value], { type: 'application/json' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        }
        function openFile(input) {
            var file = input.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function (e) {
                try {
                    var data = JSON.parse(e.target.result);
                    if (data.presets) {
                        presetData = normalizeConfigData(data); // Auto-update older versions
                        selectedBtn = 0;
                        showSystem = false;
                        render();
                        document.getElementById('jsonArea').value = JSON.stringify(presetData, null, 2); // Show updated config
                        alert('File loaded & updated!\\n\\nConfig: ' + (data.configName || 'Unnamed') + '\\nLast Modified: ' + (data.lastModified || 'Unknown'));
                    } else {
                        alert('Invalid file format: no presets found');
                    }
                } catch (err) {
                    alert('Error reading file: ' + err.message);
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset for future opens
        }

        async function fetchFromDevice() {
            var ip = document.getElementById('deviceIp').value || '192.168.4.1';
            var url = 'http://' + ip + '/export';
            var statusEl = document.getElementById('serialLog');
            if (statusEl) statusEl.value = 'Fetching from ' + ip + '...\n' + statusEl.value;

            try {
                var res = await fetch(url);
                if (!res.ok) throw new Error('Status ' + res.status);
                var data = await res.json();
                if (data.presets) {
                    presetData = normalizeConfigData(data); // Auto-update older versions
                    selectedBtn = 0;
                    showSystem = false;
                    render();
                    if (statusEl) statusEl.value = 'Fetch SUCCESS (config updated)\n' + statusEl.value;
                    alert('Configuration fetched & updated from ' + ip);
                } else {
                    alert('Invalid configuration received');
                }
            } catch (e) {
                if (statusEl) statusEl.value = 'Fetch FAILED: ' + e.message + '\n' + statusEl.value;
                alert('Fetch failed: ' + e.message + '\n\nMake sure your computer is connected to Chocotone WiFi and CORS is supported by the device.');
            }
        }

        async function pushToDevice() {
            var ip = document.getElementById('deviceIp').value || '192.168.4.1';
            var url = 'http://' + ip + '/import';
            var exportData = prepareExportData();
            var json = JSON.stringify(exportData);
            var blob = new Blob([json], { type: 'application/json' });
            var fd = new FormData();
            fd.append('config', blob, 'config.json');

            var statusEl = document.getElementById('serialLog');
            if (statusEl) statusEl.value = 'Pushing to ' + ip + '...\n' + statusEl.value;

            try {
                var res = await fetch(url, { method: 'POST', body: fd });
                var text = await res.text();
                if (res.ok) {
                    if (statusEl) statusEl.value = 'Push SUCCESS: ' + text + '\n' + statusEl.value;
                    alert('Success: ' + text + '\n\nDevice will reboot.');
                } else {
                    if (statusEl) statusEl.value = 'Push ERROR: ' + text + '\n' + statusEl.value;
                    alert('Error: ' + text);
                }
            } catch (e) {
                if (statusEl) statusEl.value = 'Push FAILED: ' + e.message + '\n' + statusEl.value;
                alert('Push failed: ' + e.message + '\n\nMake sure your computer is connected to Chocotone WiFi.');
            }
        }

        // Send preset change to connected device
        async function sendPresetToDevice(presetIdx) {
            // Serial
            if (serialWriter) {
                try {
                    await serialWriter.write(new TextEncoder().encode('SET_PRESET:' + presetIdx + '\n'));
                } catch (e) {
                    console.log('Serial preset sync error:', e);
                }
            }
            // BLE
            if (bleRxChar && bleDevice && bleDevice.gatt.connected) {
                try {
                    await bleRxChar.writeValue(new TextEncoder().encode('SET_PRESET:' + presetIdx + '\n'));
                    console.log('BLE: Preset ' + presetIdx + ' sent');
                } catch (e) {
                    console.log('BLE preset sync error:', e);
                }
            }
        }

        async function sendToDevice() {
            if (!serialWriter) { alert('Connect USB first'); return; }

            // UI Feedback
            var statusEl = document.getElementById('usbStatus');
            var originalStatus = statusEl.textContent;
            statusEl.textContent = 'Preparing...';
            statusEl.style.color = '#f59e0b'; // Amber

            var exportData = prepareExportData();
            var json = JSON.stringify(exportData);
            var CHUNK_SIZE = 200; // Smaller chunks to prevent serial buffer overflow
            var totalChunks = Math.ceil(json.length / CHUNK_SIZE);

            try {
                // Start upload - pause BLE scan first
                statusEl.textContent = 'Stopping scans...';
                await serialWriter.write(new TextEncoder().encode('PAUSE_SCAN\n'));
                await sleep(500);  // Wait for BLE scan to stop

                statusEl.textContent = 'Starting upload...';
                await serialWriter.write(new TextEncoder().encode('SET_CONFIG_START\n'));
                await sleep(300);  // Longer delay to ensure READY

                // Send chunks with longer delays
                for (var i = 0; i < json.length; i += CHUNK_SIZE) {
                    var chunkIndex = Math.floor(i / CHUNK_SIZE);
                    var progress = Math.round((chunkIndex / totalChunks) * 100);
                    statusEl.textContent = 'Sending ' + progress + '%';

                    var chunk = json.substring(i, i + CHUNK_SIZE);
                    await serialWriter.write(new TextEncoder().encode('SET_CONFIG_CHUNK:' + chunk + '\n'));
                    await sleep(50); // Small delay between chunks

                    // Yield to browser every 10 chunks to update UI
                    if (chunkIndex % 5 === 0) await sleep(20);
                }

                // End upload
                statusEl.textContent = 'Finalizing...';
                await sleep(500);
                await serialWriter.write(new TextEncoder().encode('SET_CONFIG_END\n'));
                await sleep(200);
                await serialWriter.write(new TextEncoder().encode('RESUME_SCAN\n'));

                statusEl.textContent = 'Connected (Done)';
                statusEl.style.color = '#22c55e';
                setTimeout(() => { statusEl.textContent = 'Connected'; }, 3000);

                alert('Config sent to device! Check serial monitor for status.');
            } catch (e) {
                statusEl.textContent = 'Error!';
                statusEl.style.color = '#ef4444';
                alert('Send error: ' + e.message);

                // Try to recover status after error
                setTimeout(() => {
                    statusEl.textContent = 'Connected';
                    statusEl.style.color = '#22c55e';
                }, 3000);
            }
        }

        // ========== SYSEX PRESETS DATABASE (SPM) ==========
        var sysexPresets = {
            // Reverb Types (10 types)
            'SPM: Reverb Type - Air': 'f0050b00010000000e0101040700080000000000000008000000000000000b00000000000cf7',
            'SPM: Reverb Type - Room': 'f00d0100010000000e0101040700080000000000000008000000000000000000000000000cf7',
            'SPM: Reverb Type - Hall': 'f00c0700010000000e0101040700080000000000000008000000000000000100000000000cf7',
            'SPM: Reverb Type - Church': 'f00f0d00010000000e0101040700080000000000000008000000000000000200000000000cf7',
            'SPM: Reverb Type - Plate L': 'f00b0600010000000e0101040700080000000000000008000000000000010000000000000cf7',
            'SPM: Reverb Type - Plate': 'f0000300010000000e0101040700080000000000000008000000000000000f00000000000cf7',
            'SPM: Reverb Type - Spring': 'f0080900010000000e0101040700080000000000000008000000000000000400000000000cf7',
            'SPM: Reverb Type - N-Star': 'f00a0500010000000e0101040700080000000000000008000000000000000600000000000cf7',
            'SPM: Reverb Type - Deepsea': 'f00b0300010000000e0101040700080000000000000008000000000000000700000000000cf7',
            'SPM: Reverb Type - Sweet Space': 'f00f0800010000000e0101040700080000000000000008000000000000010500000000000cf7',
            // Reverb On/Off
            'SPM: Reverb - ON': 'f0080400010000000a0101040900080000000000000001000000000000f7',
            'SPM: Reverb - OFF': 'f0090200010000000a0101040900080000000000000000000000000000f7',
            // Delay Time (common values)
            'SPM: Delay Time 100ms': 'f00d0900010000000e0101040800070000000000000001000000000000000000000c080402f7',
            'SPM: Delay Time 150ms': 'f00b0200010000000e01010408000700000000000000010000000000000000000001060403f7',
            'SPM: Delay Time 200ms': 'f0060800010000000e01010408000700000000000000010000000000000000000004080403f7',
            'SPM: Delay Time 250ms': 'f00a0e00010000000e010104080007000000000000000100000000000000000000070a0403f7',
            'SPM: Delay Time 300ms': 'f0000400010000000e01010408000700000000000000010000000000000000000009060403f7',
            'SPM: Delay Time 350ms': 'f00b0700010000000e0101040800070000000000000001000000000000000000000b060403f7',
            'SPM: Delay Time 400ms': 'f00d0e00010000000e0101040800070000000000000001000000000000000000000c080403f7',
            'SPM: Delay Time 500ms': 'f0000d00010000000e0101040800070000000000000001000000000000000000000f0a0403f7',
            // Delay Mix (common values)
            'SPM: Delay Mix 0%': 'f0040600010000000e01010408000700000000000000000000000000000000000000000000f7',
            'SPM: Delay Mix 10%': 'f0020800010000000e01010408000700000000000000000000000000000000000002000401f7',
            'SPM: Delay Mix 20%': 'f0090e00010000000e0101040800070000000000000000000000000000000000000a000401f7',
            'SPM: Delay Mix 30%': 'f0090200010000000e0101040800070000000000000000000000000000000000000f000401f7',
            'SPM: Delay Mix 40%': 'f0020100010000000e01010408000700000000000000000000000000000000000002000402f7',
            'SPM: Delay Mix 50%': 'f0070c00010000000e01010408000700000000000000000000000000000000000004080402f7',
            'SPM: Delay Mix 60%': 'f0020d00010000000e01010408000700000000000000000000000000000000000007000402f7',
            'SPM: Delay Mix 70%': 'f00c0500010000000e010104080007000000000000000000000000000000000000080c0402f7',
            'SPM: Delay Mix 80%': 'f0090700010000000e0101040800070000000000000000000000000000000000000a000402f7',
            'SPM: Delay Mix 90%': 'f00c0000010000000e0101040800070000000000000000000000000000000000000b000402f7',
            'SPM: Delay Mix 100%': 'f00c0a00010000000e0101040800070000000000000000000000000000000000000c080402f7',
            // Reverb Decay (common values)
            'SPM: Reverb Decay 10%': 'f0020800010000000e01010408000800000000000000020000000000000000000002000401f7',
            'SPM: Reverb Decay 30%': 'f0090200010000000e01010408000800000000000000020000000000000000000002080401f7',
            'SPM: Reverb Decay 50%': 'f0070c00010000000e01010408000800000000000000020000000000000000000004080402f7',
            'SPM: Reverb Decay 70%': 'f00c0500010000000e010104080008000000000000000200000000000000000000080c0402f7',
            'SPM: Reverb Decay 100%': 'f0040800010000000e0101040800080000000000000002000000000000000000000c060402f7',
            // Delay Feedback (common values)
            'SPM: Delay Feedback 0%': 'f0060000010000000e01010408000700000000000000020000000000000000000000000000f7',
            'SPM: Delay Feedback 10%': 'f0000e00010000000e01010408000700000000000000020000000000000000000002000401f7',
            'SPM: Delay Feedback 20%': 'f00b0800010000000e0101040800070000000000000002000000000000000000000a000401f7',
            'SPM: Delay Feedback 30%': 'f00b0400010000000e0101040800070000000000000002000000000000000000000f000401f7',
            'SPM: Delay Feedback 40%': 'f0000700010000000e01010408000700000000000000020000000000000000000002000402f7',
            'SPM: Delay Feedback 50%': 'f0050a00010000000e01010408000700000000000000020000000000000000000004080402f7',
            'SPM: Delay Feedback 60%': 'f0000b00010000000e01010408000700000000000000020000000000000000000007000402f7',
            'SPM: Delay Feedback 70%': 'f00e0300010000000e01010408000700000000000000020000000000000000000008080402f7',
            'SPM: Delay Feedback 80%': 'f00b0100010000000e0101040800070000000000000002000000000000000000000a000402f7',
            'SPM: Delay Feedback 90%': 'f00e0600010000000e0101040800070000000000000002000000000000000000000b000402f7',
            'SPM: Delay Feedback 100%': 'f00e0c00010000000e0101040800070000000000000002000000000000000000000c080402f7',
            // ========== GP-5 SYSEX PRESETS ==========
            // GP-5 Effect On/Off (computed with CRC8)
            'GP5: NR - ON': 'f0010c00010000000a0101040900000000000000000001000000000000f7',
            'GP5: NR - OFF': 'f0000a00010000000a0101040900000000000000000000000000000000f7',
            'GP5: PRE - ON': 'f0000f00010000000a0101040900010000000000000001000000000000f7',
            'GP5: PRE - OFF': 'f0010900010000000a01010409000100000000000000000000000000000000f7',
            'GP5: DST - ON': 'f0030a00010000000a0101040900020000000000000001000000000000f7',
            'GP5: DST - OFF': 'f0020c00010000000a01010409000200000000000000000000000000000000f7',
            'GP5: AMP - ON': 'f0020900010000000a0101040900030000000000000001000000000000f7',
            'GP5: AMP - OFF': 'f0030f00010000000a01010409000300000000000000000000000000000000f7',
            'GP5: CAB - ON': 'f0050000010000000a0101040900040000000000000001000000000000f7',
            'GP5: CAB - OFF': 'f0040600010000000a01010409000400000000000000000000000000000000f7',
            'GP5: EQ - ON': 'f0040300010000000a0101040900050000000000000001000000000000f7',
            'GP5: EQ - OFF': 'f0050500010000000a01010409000500000000000000000000000000000000f7',
            'GP5: MOD - ON': 'f0070600010000000a0101040900060000000000000001000000000000f7',
            'GP5: MOD - OFF': 'f0060000010000000a01010409000600000000000000000000000000000000f7',
            'GP5: DLY - ON': 'f0060500010000000a0101040900070000000000000001000000000000f7',
            'GP5: DLY - OFF': 'f0070300010000000a01010409000700000000000000000000000000000000f7',
            'GP5: RVB - ON': 'f0080400010000000a0101040900080000000000000001000000000000f7',
            'GP5: RVB - OFF': 'f0090200010000000a01010409000800000000000000000000000000000000f7',
            'GP5: NS - ON': 'f0090700010000000a0101040900090000000000000001000000000000f7',
            'GP5: NS - OFF': 'f0080100010000000a01010409000900000000000000000000000000000000f7'
        };

        function getSysexPickerOptions() {
            var html = '<option value="">-- Select SysEx Preset --</option>';
            // SPM SysEx Presets
            html += '<optgroup label="â”€â”€ Sonicake Pocket Master â”€â”€">';
            html += '<optgroup label="[SPM] Reverb Type">';
            for (var k in sysexPresets) { if (k.indexOf('Reverb Type') > -1) html += '<option value="' + k + '">' + k.replace('SPM: ', '') + '</option>'; }
            html += '</optgroup>';
            html += '<optgroup label="[SPM] Reverb ON/OFF">';
            for (var k in sysexPresets) { if (k.indexOf('Reverb - O') > -1) html += '<option value="' + k + '">' + k.replace('SPM: ', '') + '</option>'; }
            html += '</optgroup>';
            html += '<optgroup label="[SPM] Delay Time">';
            for (var k in sysexPresets) { if (k.indexOf('Delay Time') > -1) html += '<option value="' + k + '">' + k.replace('SPM: ', '') + '</option>'; }
            html += '</optgroup>';
            html += '<optgroup label="[SPM] Delay Mix">';
            for (var k in sysexPresets) { if (k.indexOf('Delay Mix') > -1) html += '<option value="' + k + '">' + k.replace('SPM: ', '') + '</option>'; }
            html += '</optgroup>';
            html += '<optgroup label="[SPM] Reverb Decay">';
            for (var k in sysexPresets) { if (k.indexOf('Reverb Decay') > -1) html += '<option value="' + k + '">' + k.replace('SPM: ', '') + '</option>'; }
            html += '</optgroup>';
            html += '<optgroup label="[SPM] Delay Feedback">';
            for (var k in sysexPresets) { if (k.indexOf('Delay Feedback') > -1) html += '<option value="' + k + '">' + k.replace('SPM: ', '') + '</option>'; }
            html += '</optgroup>';
            // GP-5 SysEx Presets
            html += '<optgroup label="â”€â”€ Valeton GP-5 â”€â”€">';
            html += '<optgroup label="[GP5] Effect On/Off">';
            for (var k in sysexPresets) { if (k.indexOf('GP5:') === 0) html += '<option value="' + k + '">' + k.replace('GP5: ', '') + '</option>'; }
            html += '</optgroup>';
            html += '</optgroup>';
            return html;
        }

        function applySysexPreset(msgIdx, presetName) {
            if (!presetName || !sysexPresets[presetName]) return;
            updMsg(msgIdx, 'sysex', sysexPresets[presetName]);
            render();
        }

        // ===============================================================
        // WEB SERIAL API - USB Connection to Chocotone
        // ===============================================================
        var serialPort = null;
        var serialReader = null;
        var serialWriter = null;
        var serialBuffer = '';

        async function connectUSB() {
            if (!('serial' in navigator)) {
                alert('Web Serial not supported. Use Chrome or Edge.');
                return;
            }
            try {
                serialPort = await navigator.serial.requestPort();
                await serialPort.open({ baudRate: 115200 });
                serialWriter = serialPort.writable.getWriter();
                serialReader = serialPort.readable.getReader();
                var usbStatusEl = document.getElementById('usbStatus');
                if (usbStatusEl) {
                    usbStatusEl.textContent = 'Connected';
                    usbStatusEl.style.color = '#22c55e';
                }
                var usbBtnEl = document.getElementById('btnConnect');
                if (usbBtnEl) usbBtnEl.textContent = 'Disconnect';
                render();
                // Start reading
                readSerial();
            } catch (e) {
                console.error('Serial error:', e);
                alert('Connection failed: ' + e.message);
            }
        }

        async function disconnectUSB() {
            try {
                if (serialReader) {
                    try { await serialReader.cancel(); } catch (e) { console.log('Reader cancel:', e); }
                    try { serialReader.releaseLock(); } catch (e) { console.log('Reader release:', e); }
                    serialReader = null;
                }
                if (serialWriter) {
                    try { serialWriter.releaseLock(); } catch (e) { console.log('Writer release:', e); }
                    serialWriter = null;
                }
                if (serialPort) {
                    try { await serialPort.close(); } catch (e) { console.log('Port close:', e); }
                    serialPort = null;
                }
            } catch (e) {
                console.error('Disconnect error:', e);
            }
            // Force null to ensure clean state
            serialPort = null;
            serialReader = null;
            serialWriter = null;
            var usbStatusEl2 = document.getElementById('usbStatus');
            if (usbStatusEl2) {
                usbStatusEl2.textContent = 'Not connected';
                usbStatusEl2.style.color = '#71717a';
            }
            var usbBtnEl2 = document.getElementById('btnConnect');
            if (usbBtnEl2) usbBtnEl2.textContent = 'Connect USB/BT';
            render();
        }

        function toggleUSB() {
            if (serialPort) disconnectUSB();
            else connectUSB();
        }

        async function readSerial() {
            while (serialPort && serialReader) {
                try {
                    const { value, done } = await serialReader.read();
                    if (done) break;
                    serialBuffer += new TextDecoder().decode(value);
                    processSerialData();
                } catch (e) { break; }
            }
        }

        var expectingConfig = false;
        var configJson = '';

        function processSerialData() {
            var lines = serialBuffer.split('\n');
            serialBuffer = lines.pop(); // Keep incomplete line
            for (var line of lines) {
                line = line.trim();
                if (!line) continue;

                // Log all messages to Serial Log area
                var logArea = document.getElementById('serialLog');
                if (logArea && !expectingConfig) {
                    logArea.value += line + '\n';
                    logArea.scrollTop = logArea.scrollHeight;
                }

                if (line === 'CONFIG_START') {
                    expectingConfig = true;
                    configJson = '';
                } else if (line === 'CONFIG_END') {
                    expectingConfig = false;
                    try {
                        var data = JSON.parse(configJson);
                        normalizeConfigData(data);  // Remap colorâ†’rgb
                        console.log('Received config:', data);
                        if (data.presets) {
                            // Use config metadata from device if present
                            if (data.configName) presetData.configName = data.configName;
                            if (data.lastModified) presetData.lastModified = data.lastModified;
                            presetData.presets = data.presets;
                            if (data.system) {
                                // Merge system properties
                                if (data.system.bleDeviceName) presetData.system.bleDeviceName = data.system.bleDeviceName;
                                if (data.system.apSSID) presetData.system.apSSID = data.system.apSSID;
                                if (data.system.apPassword) presetData.system.apPassword = data.system.apPassword;
                                if (data.system.buttonCount) presetData.system.buttonCount = data.system.buttonCount;
                                if (data.system.buttonPins) presetData.system.buttonPins = data.system.buttonPins;
                                if (data.system.ledPin) presetData.system.ledPin = data.system.ledPin;
                                if (data.system.ledsPerButton) presetData.system.ledsPerButton = data.system.ledsPerButton;
                                if (data.system.ledMap) presetData.system.ledMap = data.system.ledMap;
                                if (data.system.encoderA !== undefined) presetData.system.encoderA = data.system.encoderA;
                                if (data.system.encoderB !== undefined) presetData.system.encoderB = data.system.encoderB;
                                if (data.system.encoderBtn !== undefined) presetData.system.encoderBtn = data.system.encoderBtn;
                                if (data.system.bleMode) presetData.system.bleMode = data.system.bleMode;
                                if (data.system.brightness) presetData.system.brightness = data.system.brightness;
                                if (data.system.analogInputCount !== undefined) presetData.system.analogInputCount = data.system.analogInputCount;
                                if (data.system.debugAnalogIn !== undefined) presetData.system.debugAnalogIn = data.system.debugAnalogIn;
                                if (data.system.batteryAdcPin !== undefined) presetData.system.batteryAdcPin = data.system.batteryAdcPin;

                                // Merge OLED config if present (v1.5 beta)
                                if (data.system.oled) {
                                    if (!presetData.system.oled) presetData.system.oled = {};
                                    presetData.system.oled = JSON.parse(JSON.stringify(data.system.oled));
                                }
                            }
                            // Merge Analog Inputs if present (v1.5 beta)
                            if (data.analogInputs) {
                                presetData.analogInputs = JSON.parse(JSON.stringify(data.analogInputs));
                            }
                            presetData.currentPreset = data.currentPreset || 0;
                            selectedBtn = 0;
                            showSystem = false;
                            console.log('Imported OLED config:', JSON.stringify(presetData.system.oled, null, 2));
                            render();
                            setTimeout(renderOledPreview, 100); // Re-render OLED preview after DOM update
                            alert('Config loaded from device!');
                        } else {
                            alert('Invalid config: no presets found');
                        }
                    } catch (e) {
                        console.error('Parse error:', e, 'JSON:', configJson);
                        alert('Parse error: ' + e.message);
                    }
                } else if (expectingConfig) {
                    configJson += line;
                }
            }
        }

        async function readFromDevice() {
            if (!serialWriter) { alert('Connect USB first'); return; }
            await serialWriter.write(new TextEncoder().encode('GET_CONFIG\n'));
        }

        async function sendToDevice(isRetry) {
            if (!serialWriter) { alert('Connect USB first'); return; }
            var json = JSON.stringify(presetData);
            var CHUNK_SIZE = 200; // Smaller chunks to prevent serial buffer overflow

            // Setup response listener
            var uploadResult = null;
            var uploadResolve = null;
            var uploadTimeout = null;

            // Add temporary response listener to processSerialData
            var origProcessSerialData = processSerialData;
            processSerialData = function () {
                // Call original first
                var origBuffer = serialBuffer;
                origProcessSerialData();

                // Check for responses in what we just processed
                if (origBuffer.includes('SAVE_OK') || origBuffer.includes('Config saved')) {
                    uploadResult = 'SUCCESS';
                    if (uploadResolve) uploadResolve('SUCCESS');
                } else if (origBuffer.includes('JSON_ERROR:InvalidInput')) {
                    uploadResult = 'INVALID_INPUT';
                    if (uploadResolve) uploadResolve('INVALID_INPUT');
                } else if (origBuffer.includes('JSON_ERROR:')) {
                    var match = origBuffer.match(/JSON_ERROR:(\w+)/);
                    uploadResult = match ? match[0] : 'JSON_ERROR';
                    if (uploadResolve) uploadResolve(uploadResult);
                } else if (origBuffer.includes('CHUNK_ERROR:')) {
                    var match = origBuffer.match(/CHUNK_ERROR:(\w+)/);
                    uploadResult = match ? match[0] : 'CHUNK_ERROR';
                    if (uploadResolve) uploadResolve(uploadResult);
                }
            };

            try {
                // Start upload - pause BLE scan first
                await serialWriter.write(new TextEncoder().encode('PAUSE_SCAN\n'));
                await sleep(500);  // Wait for BLE scan to stop

                await serialWriter.write(new TextEncoder().encode('SET_CONFIG_START\n'));
                await sleep(300);  // Longer delay to ensure READY

                // Send chunks with longer delays
                for (var i = 0; i < json.length; i += CHUNK_SIZE) {
                    var chunk = json.substring(i, i + CHUNK_SIZE);
                    await serialWriter.write(new TextEncoder().encode('SET_CONFIG_CHUNK:' + chunk + '\n'));
                    await sleep(50); // Small delay between chunks

                    // Yield to browser every 10 chunks
                    if ((i / CHUNK_SIZE) % 10 === 0) await sleep(100);
                }

                // End upload and wait for response
                await sleep(500);
                await serialWriter.write(new TextEncoder().encode('SET_CONFIG_END\n'));

                // Wait for response (max 10 seconds)
                var responsePromise = new Promise(function (resolve) {
                    uploadResolve = resolve;
                    uploadTimeout = setTimeout(function () {
                        resolve('TIMEOUT');
                    }, 10000);
                });

                var result = await responsePromise;
                clearTimeout(uploadTimeout);

                // Restore original processSerialData
                processSerialData = origProcessSerialData;

                // Resume BLE scan
                await sleep(200);
                await serialWriter.write(new TextEncoder().encode('RESUME_SCAN\n'));

                // Handle result
                if (result === 'SUCCESS') {
                    alert('âœ… Config saved to device successfully!');
                } else if (result === 'INVALID_INPUT' && !isRetry) {
                    // Auto-retry once for InvalidInput
                    console.log('JSON_ERROR:InvalidInput - auto-retrying once...');
                    await sleep(1000);
                    return sendToDevice(true); // Retry with flag
                } else if (result === 'INVALID_INPUT' && isRetry) {
                    alert('âŒ Config save failed: Invalid JSON input\n\nThe device failed to parse the config twice.\nPlease check the serial monitor for details.');
                } else if (result === 'TIMEOUT') {
                    alert('âš ï¸ Config upload timeout.\n\nNo response from device after 10 seconds.\nCheck if device is connected and try again.');
                } else if (result.startsWith('JSON_ERROR:')) {
                    alert('âŒ Config save failed: ' + result + '\n\nPlease check the serial monitor for details.');
                } else if (result.startsWith('CHUNK_ERROR:')) {
                    alert('âŒ Config upload failed: ' + result + '\n\nBuffer overflow - try again or restart device.');
                } else {
                    alert('âš ï¸ Config sent. Check serial monitor for status.');
                }
            } catch (e) {
                // Restore original processSerialData on error
                processSerialData = origProcessSerialData;
                alert('âŒ Send error: ' + e.message);
            }
        }

        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        // ===============================================================
        // WEB BLUETOOTH API - BLE Connection to Chocotone
        // ===============================================================
        var bleDevice = null;
        var bleRxChar = null;  // Write to device
        var bleTxChar = null;  // Notify from device
        var bleBuffer = '';
        var bleConfigJson = '';
        var bleExpectingConfig = false;

        // Chocotone Config Service UUIDs (must match firmware)
        const BLE_CONFIG_SERVICE = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890';
        const BLE_CONFIG_RX = 'a1b2c3d4-e5f6-7890-abcd-ef1234567891';
        const BLE_CONFIG_TX = 'a1b2c3d4-e5f6-7890-abcd-ef1234567892';

        async function connectBLE() {
            if (!('bluetooth' in navigator)) {
                alert('Web Bluetooth not supported. Use Chrome or Edge on desktop.');
                return;
            }
            try {
                bleDevice = await navigator.bluetooth.requestDevice({
                    // Use services filter instead of name to avoid case sensitivity issues
                    // This shows all devices advertising the Config Service UUID
                    filters: [
                        { services: [BLE_CONFIG_SERVICE] },
                        { namePrefix: 'CHOCOTONE' },
                        { namePrefix: 'Chocotone' },
                        { namePrefix: 'chocotone' }
                    ],
                    optionalServices: [BLE_CONFIG_SERVICE]
                });

                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService(BLE_CONFIG_SERVICE);

                bleRxChar = await service.getCharacteristic(BLE_CONFIG_RX);
                bleTxChar = await service.getCharacteristic(BLE_CONFIG_TX);

                // Start notifications for responses
                await bleTxChar.startNotifications();
                bleTxChar.addEventListener('characteristicvaluechanged', handleBleNotification);

                // Handle disconnection events
                bleDevice.addEventListener('gattserverdisconnected', () => {
                    console.log('BLE Disconnected');
                    bleRxChar = null;
                    bleTxChar = null;
                    var statusEl = document.getElementById('bleStatus');
                    if (statusEl) {
                        statusEl.textContent = 'Disconnected';
                        statusEl.style.color = '#ef4444';
                    }
                    var btnEl = document.getElementById('btnBleConnect');
                    if (btnEl) btnEl.textContent = 'Connect BLE';
                    render();
                });

                var bleStatusEl = document.getElementById('bleStatus');
                if (bleStatusEl) {
                    bleStatusEl.textContent = 'Connected';
                    bleStatusEl.style.color = '#22c55e';
                }
                var bleBtnEl = document.getElementById('btnBleConnect');
                if (bleBtnEl) bleBtnEl.textContent = 'Disconnect';
                render();

                console.log('BLE Connected to Chocotone');

                // Brief delay to ensure connection is stable
                await sleep(200);
            } catch (e) {
                console.error('BLE error:', e);
                alert('BLE Connection failed: ' + e.message);
            }
        }

        async function disconnectBLE() {
            if (bleDevice && bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
            }
            bleDevice = null;
            bleRxChar = null;
            bleTxChar = null;
            var bleStatusEl2 = document.getElementById('bleStatus');
            if (bleStatusEl2) {
                bleStatusEl2.textContent = 'Not connected';
                bleStatusEl2.style.color = '#71717a';
            }
            var bleBtnEl2 = document.getElementById('btnBleConnect');
            if (bleBtnEl2) bleBtnEl2.textContent = 'Connect BLE';
            render();
        }

        function toggleBLE() {
            if (bleDevice && bleDevice.gatt.connected) disconnectBLE();
            else connectBLE();
        }

        // BLE response handler - simplified for request-acknowledge protocol
        var bleResponseResolve = null;
        var bleResponseTimeout = null;

        function handleBleNotification(event) {
            var value = new TextDecoder().decode(event.target.value);
            console.log('BLE response:', value.substring(0, 100));

            // Clear timeout and resolve promise
            if (bleResponseTimeout) {
                clearTimeout(bleResponseTimeout);
                bleResponseTimeout = null;
            }
            if (bleResponseResolve) {
                bleResponseResolve(value);
                bleResponseResolve = null;
            }
        }

        // Send command and wait for response
        async function sendBleCommand(cmd, timeoutMs = 3000) {
            return new Promise(async (resolve, reject) => {
                bleResponseResolve = resolve;
                bleResponseTimeout = setTimeout(() => {
                    bleResponseResolve = null;
                    reject(new Error('BLE timeout waiting for: ' + cmd));
                }, timeoutMs);

                try {
                    await bleRxChar.writeValue(new TextEncoder().encode(cmd + '\n'));
                } catch (e) {
                    clearTimeout(bleResponseTimeout);
                    bleResponseResolve = null;
                    reject(e);
                }
            });
        }

        async function readFromDeviceBLE() {
            if (!bleRxChar || !bleDevice || !bleDevice.gatt.connected) {
                alert('Bluetooth not connected. Please connect first.');
                return;
            }

            try {
                console.log('BLE Read: Starting request-acknowledge transfer...');

                // Step 1: Request config info
                var infoResponse = await sendBleCommand('GET_CONFIG', 5000);
                console.log('BLE Read: Got info:', infoResponse);

                if (!infoResponse.startsWith('CONFIG_INFO:')) {
                    throw new Error('Unexpected response: ' + infoResponse);
                }

                // Parse: CONFIG_INFO:8203:65
                var parts = infoResponse.split(':');
                var totalBytes = parseInt(parts[1]);
                var totalChunks = parseInt(parts[2]);
                console.log('BLE Read: Expecting ' + totalBytes + ' bytes in ' + totalChunks + ' chunks');

                // Step 2: Request each chunk
                var jsonBuffer = '';
                for (var i = 0; i < totalChunks; i++) {
                    var chunkResponse = await sendBleCommand('GET_CHUNK:' + i, 3000);

                    // Parse: CHUNK:N:data
                    if (!chunkResponse.startsWith('CHUNK:')) {
                        throw new Error('Invalid chunk response: ' + chunkResponse);
                    }

                    // Extract data after "CHUNK:N:"
                    var colonIdx = chunkResponse.indexOf(':', 6);  // Find second colon
                    var chunkData = chunkResponse.substring(colonIdx + 1);
                    jsonBuffer += chunkData;

                    // Progress logging every 10 chunks
                    if (i % 10 === 0 || i === totalChunks - 1) {
                        console.log('BLE Read: Chunk ' + (i + 1) + '/' + totalChunks + ' (' + jsonBuffer.length + ' bytes)');
                    }

                    // Small delay between chunk requests
                    await sleep(20);
                }

                console.log('BLE Read: All chunks received, total: ' + jsonBuffer.length + ' bytes');

                // Step 3: Parse JSON
                var data = JSON.parse(jsonBuffer);
                normalizeConfigData(data);  // Remap colorâ†’rgb
                console.log('BLE received config:', data);

                if (data.presets) {
                    // Use config metadata from device if present
                    if (data.configName) presetData.configName = data.configName;
                    if (data.lastModified) presetData.lastModified = data.lastModified;
                    presetData.presets = data.presets;
                    if (data.system) {
                        // Merge system properties individually
                        if (data.system.bleDeviceName) presetData.system.bleDeviceName = data.system.bleDeviceName;
                        if (data.system.apSSID) presetData.system.apSSID = data.system.apSSID;
                        if (data.system.apPassword) presetData.system.apPassword = data.system.apPassword;
                        if (data.system.buttonCount) presetData.system.buttonCount = data.system.buttonCount;
                        if (data.system.buttonPins) presetData.system.buttonPins = data.system.buttonPins;
                        if (data.system.ledPin) presetData.system.ledPin = data.system.ledPin;
                        if (data.system.ledsPerButton) presetData.system.ledsPerButton = data.system.ledsPerButton;
                        if (data.system.ledMap) presetData.system.ledMap = data.system.ledMap;
                        if (data.system.encoderA !== undefined) presetData.system.encoderA = data.system.encoderA;
                        if (data.system.encoderB !== undefined) presetData.system.encoderB = data.system.encoderB;
                        if (data.system.encoderBtn !== undefined) presetData.system.encoderBtn = data.system.encoderBtn;
                        if (data.system.bleMode) presetData.system.bleMode = data.system.bleMode;
                        if (data.system.brightness) presetData.system.brightness = data.system.brightness;
                        if (data.system.brightnessDim !== undefined) presetData.system.brightnessDim = data.system.brightnessDim;
                        if (data.system.brightnessTap !== undefined) presetData.system.brightnessTap = data.system.brightnessTap;
                    }
                    presetData.currentPreset = data.currentPreset || 0;
                    selectedBtn = 0;
                    showSystem = false;
                    render();
                    alert('Config loaded from device via Bluetooth!');
                } else {
                    alert('BLE Error: No presets found in config');
                }

            } catch (e) {
                console.error('BLE Read error:', e);
                alert('BLE Read error: ' + e.message);
            }
        }

        async function sendToDeviceBLE() {
            if (!bleRxChar || !bleDevice || !bleDevice.gatt.connected) {
                alert('Bluetooth not connected. Please connect first.');
                return;
            }
            var json = JSON.stringify(presetData);
            var CHUNK_SIZE = 150; // Small chunks for reliable BLE transfer
            var totalChunks = Math.ceil(json.length / CHUNK_SIZE);

            try {
                console.log('BLE Send: Starting upload of ' + json.length + ' bytes in ' + totalChunks + ' chunks');

                // Start upload
                var startResponse = await sendBleCommand('SET_CONFIG_START', 3000);
                console.log('BLE Send: Start response:', startResponse);

                if (startResponse !== 'CONFIG_READY') {
                    throw new Error('Device not ready: ' + startResponse);
                }

                // Send chunks
                for (var i = 0; i < json.length; i += CHUNK_SIZE) {
                    var chunkNum = Math.floor(i / CHUNK_SIZE) + 1;
                    var chunk = json.substring(i, i + CHUNK_SIZE);

                    var chunkResponse = await sendBleCommand('SET_CONFIG_CHUNK:' + chunk, 3000);

                    if (!chunkResponse.startsWith('CHUNK_OK:')) {
                        throw new Error('Chunk error: ' + chunkResponse);
                    }

                    if (chunkNum % 10 === 0) {
                        console.log('BLE Send: Chunk ' + chunkNum + '/' + totalChunks);
                    }
                }

                // End upload
                var endResponse = await sendBleCommand('SET_CONFIG_END', 10000);
                console.log('BLE Send: End response:', endResponse);

                if (endResponse === 'CONFIG_SAVED') {
                    alert('Config saved to device via Bluetooth!');
                } else {
                    throw new Error('Save failed: ' + endResponse);
                }

            } catch (e) {
                console.error('BLE Send error:', e);
                alert('BLE Send error: ' + e.message);
            }
        }

        // Add connection sections to render
        var origRender = render;
        render = function () {
            origRender();
            var app = document.getElementById('app');

            // USB Status
            var usbConnected = serialPort !== null;
            var usbStatusText = usbConnected ? 'Connected' : 'Not connected';
            var usbStatusColor = usbConnected ? '#22c55e' : '#71717a';
            var usbBtnText = usbConnected ? 'Disconnect' : 'Connect USB/BT';

            // BLE Status
            var bleConnected = bleDevice && bleDevice.gatt && bleDevice.gatt.connected;
            var bleStatusText = bleConnected ? 'Connected' : 'Not connected';
            var bleStatusColor = bleConnected ? '#22c55e' : '#71717a';
            var bleBtnText = bleConnected ? 'Disconnect' : 'Connect BLE';

            // Unified Connection Bar
            var anyConnected = usbConnected || bleConnected;
            var html = '<div class="section" style="padding:10px 16px;margin-bottom:12px">';
            html += '<div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">';

            // USB Connect
            html += '<button class="btn primary" onclick="toggleUSB()" style="padding:6px 12px;font-size:11px">ðŸ”Œ ' + usbBtnText + '</button>';
            if (usbConnected) html += '<span style="font-size:10px;color:#22c55e">â— USB</span>';

            // BLE Connect
            html += '<button class="btn" onclick="toggleBLE()" style="background:var(--cyan);color:#000;padding:6px 12px;font-size:11px">ðŸ“¶ ' + bleBtnText + '</button>';
            if (bleConnected) html += '<span style="font-size:10px;color:#22c55e">â— BLE</span>';

            // Shared Read/Send (uses active connection)
            html += '<div style="display:flex;gap:6px;align-items:center">';
            html += '<button class="btn success" onclick="readFromConnected()" style="padding:5px 12px;font-size:11px"' + (!anyConnected ? ' disabled' : '') + '>ðŸ“¥ Read</button>';
            html += '<button class="btn warning" onclick="sendToConnected()" style="padding:5px 12px;font-size:11px"' + (!anyConnected ? ' disabled' : '') + '>ðŸ“¤ Send</button>';
            html += '</div>';

            // Serial Log (inline with connection bar)
            html += '<div style="flex:1;display:flex;gap:8px;align-items:center;margin-left:20px">';
            html += '<textarea id="serialLog" readonly style="flex:1;height:42px;background:#1a1a2e;border:1px solid #333;border-radius:4px;color:#8b5cf6;font-family:monospace;font-size:10px;padding:4px 8px;resize:none" placeholder="Firmware messages..."></textarea>';
            html += '<div style="display:flex;flex-direction:column;gap:4px">';
            html += '<button class="btn" onclick="document.getElementById(\'serialLog\').value=\'\'" style="background:#333;padding:3px 10px;font-size:10px">Clear</button>';
            html += '<button class="btn" onclick="navigator.clipboard.writeText(document.getElementById(\'serialLog\').value)" style="background:#333;padding:3px 10px;font-size:10px">Copy</button>';
            html += '</div></div>';

            html += '</div></div>';
            app.insertAdjacentHTML('afterbegin', html);
        };

        // Helper functions for unified Read/Send
        function readFromConnected() {
            if (serialPort) readFromDevice();
            else if (bleDevice && bleDevice.gatt && bleDevice.gatt.connected) readFromDeviceBLE();
            else alert('Not connected. Please connect via USB or BLE first.');
        }

        function sendToConnected() {
            if (serialPort) sendToDevice();
            else if (bleDevice && bleDevice.gatt && bleDevice.gatt.connected) sendToDeviceBLE();
            else alert('Not connected. Please connect via USB or BLE first.');
        }

        render();

        // ===============================================================
        // DEV TOOLS - Live Color Palette Editor
        // ===============================================================
        (function () {
            var devPanel = document.createElement('div');
            devPanel.id = 'devTools';
            devPanel.className = 'collapsed';
            devPanel.innerHTML = `
                <style>
                    #devTools {
                        position: fixed;
                        top: 15px;
                        right: 15px;
                        background: var(--card, #111);
                        border: 2px solid var(--orange, #ffae3d);
                        border-radius: 12px;
                        padding: 16px;
                        z-index: 9999;
                        font-family: 'Montserrat', sans-serif;
                        font-size: 12px;
                        color: var(--mint, #e5fff2);
                        min-width: 200px;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                    }
                    #devTools.collapsed { 
                        padding: 0;
                        min-width: auto;
                        border-radius: 50%;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    #devTools.collapsed .dev-content { display: none; }
                    #devTools.collapsed .dev-header-text { display: none; }
                    #devTools .dev-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 12px;
                        font-weight: 700;
                        color: var(--orange, #ffae3d);
                        cursor: pointer;
                    }
                    #devTools.collapsed .dev-header { 
                        margin-bottom: 0;
                        font-size: 18px;
                    }
                    #devTools .dev-asterisk {
                        display: none;
                    }
                    #devTools.collapsed .dev-asterisk {
                        display: block;
                        font-size: 20px;
                    }
                    #devTools .color-row {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        margin-bottom: 8px;
                    }
                    #devTools .color-row label {
                        flex: 1;
                        color: var(--cyan, #8ffdff);
                    }
                    #devTools input[type="color"] {
                        width: 40px;
                        height: 28px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                    }
                    #devTools .dev-btn {
                        width: 100%;
                        padding: 8px;
                        margin-top: 10px;
                        background: var(--orange, #ffae3d);
                        color: #000;
                        border: none;
                        border-radius: 6px;
                        font-weight: 600;
                        cursor: pointer;
                    }
                    #devTools .dev-btn:hover { background: var(--acc-dim, #cc8a2e); }
                </style>
                <div class="dev-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="dev-asterisk">âœ±</span>
                    <span class="dev-header-text">ðŸŽ¨ Dev Tools</span>
                    <span class="dev-header-text" style="font-size:10px">âœ•</span>
                </div>
                <div class="dev-content">
                    <div class="color-row">
                        <label>Background</label>
                        <input type="color" id="devBg" value="#000000">
                    </div>
                    <div class="color-row">
                        <label>Mint (Text)</label>
                        <input type="color" id="devMint" value="#e5fff2">
                    </div>
                    <div class="color-row">
                        <label>Cyan (Dim)</label>
                        <input type="color" id="devCyan" value="#8ffdff">
                    </div>
                    <div class="color-row">
                        <label>Accent (Acc)</label>
                        <input type="color" id="devOrange" value="#8c81df">
                    </div>
                    <button class="dev-btn" onclick="exportPalette()">ðŸ“‹ Export Palette</button>
                </div>
            `;
            document.body.appendChild(devPanel);

            // Live color update functions
            document.getElementById('devBg').addEventListener('input', function (e) {
                document.documentElement.style.setProperty('--bg', e.target.value);
            });
            document.getElementById('devMint').addEventListener('input', function (e) {
                document.documentElement.style.setProperty('--text', e.target.value);
                document.documentElement.style.setProperty('--mint', e.target.value);
            });
            document.getElementById('devCyan').addEventListener('input', function (e) {
                document.documentElement.style.setProperty('--text-dim', e.target.value);
                document.documentElement.style.setProperty('--cyan', e.target.value);
            });
            document.getElementById('devOrange').addEventListener('input', function (e) {
                document.documentElement.style.setProperty('--acc', e.target.value);
                document.documentElement.style.setProperty('--warning', e.target.value);
                document.documentElement.style.setProperty('--orange', e.target.value);
            });

            // Export palette function
            window.exportPalette = function () {
                var bg = document.getElementById('devBg').value;
                var mint = document.getElementById('devMint').value;
                var cyan = document.getElementById('devCyan').value;
                var orange = document.getElementById('devOrange').value;
                var code = `Palette:\n--bg: ${bg};\n--mint: ${mint};\n--cyan: ${cyan};\n--orange: ${orange};`;
                navigator.clipboard.writeText(code);
                alert('Palette copied to clipboard!\n\n' + code);
            };
        })();
    </script>

    <!-- FOOTER -->
    <footer
        style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid var(--brd); color: #555; font-size: 0.8rem;">
        <p style="margin-bottom: 8px;">
            <a href="web_tools/installer.html" style="color: var(--acc); text-decoration: none; margin: 0 10px;">ðŸš€
                Installer</a> Â·
            <a href="presentation.html" style="color: var(--acc); text-decoration: none; margin: 0 10px;">ðŸŽ® Virtual
                Chocotone</a> Â·
            <a href="https://github.com/solispensa/Chocotone" target="_blank"
                style="color: var(--acc); text-decoration: none; margin: 0 10px;">ðŸ“¦ GitHub</a>
        </p>
        <p>Made with â¤ï¸ for the MIDI community</p>
    </footer>
</body>

</html>